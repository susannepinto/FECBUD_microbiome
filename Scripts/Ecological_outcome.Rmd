---
title: "Ecological outcome"
date: "December 2022"
output:
  github_document: default
  word_document: default
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load required packages

```{r Load packages 1, echo=TRUE, message=FALSE}
library( dplyr )
library( magrittr )
library( knitr )
library( tidyverse )
library( reshape2 )
```

```{r Load packages 2, echo=TRUE, message=FALSE, warning=FALSE}
library( phyloseq )
library( microbiome )
library( devtools )
library( stringr )
```

```{r Load packages 3, echo=TRUE, message=FALSE, warning=FALSE}
library( aod )
library( nlme )
library( lme4 )
library( splines )
library( jtools )
```

## Load the data

Here we use the relative abundance dataset.

```{r Load Data, echo=FALSE}
physeq_mOTU <- readRDS( "/Volumes/My Passport for Mac/FECBUD studie/FECBUD GitHub/FECBUD_microbiome/Data/FECBUD_physeq_filt_relativeabundances.rds" ) 
```

## Select 'average' donor mOTUs

```{r donor species, echo=TRUE}
donor_A_phyloseq <- subset_samples( physeq_mOTU, subject_id == "Donor A" )
donor_A_phyloseq

## Now determine the actual 'core' or persistent species per donor
donor_A_core_species <- core_members(
  x = donor_A_phyloseq,
  detection = 0.001, # detection limit is the same as the general limit (0.1%)
  prevalence = 6 / ( length( sample_names( donor_A_phyloseq ))),
  include.lowest = TRUE
  # select only bacteria that occur at at least 2 different timepoints
)

donor_B_phyloseq <- subset_samples( physeq_mOTU, subject_id == "Donor B" )
donor_B_phyloseq

donor_B_core_species <- core_members(
  x =  donor_B_phyloseq,
  detection = 0.001, # detection limit is the same as the general limit (0.1%)
  prevalence = 6 / ( length( sample_names( donor_B_phyloseq ))),
  include.lowest = TRUE
  # select only bacteria that occur at at least 2 different timepoints
)
```

## Select patient mOTUs per timepoint 

```{r mOTUs per patient, echo=TRUE}
# Collect data for patients per timepoint
# and convert to dataframe for easier processing
baseline_bacteria <- psmelt( physeq_mOTU ) %>%
  filter( timepoint.new == "Baseline" ) %>%
  filter( Abundance > 0 ) %>%
  arrange( subject_id )

# Now list all species present in each patient before FMT
baseline_bacteria.select <- select( baseline_bacteria, OTU, subject_id, treated_with_donor )
# Make a list per recipient
baseline_per_recipient <- unstack(baseline_bacteria.select[ ,1:2 ])

# Collect data for patients per timepoint
# and convert to dataframe for easier processing
Pre_FMT_bacteria <- psmelt( physeq_mOTU ) %>%
  filter( timepoint.new == "Pre-FMT" ) %>%
  filter( Abundance > 0 ) %>%
  arrange( subject_id )

# Now list all species present in each patient before FMT
Pre_FMT_bacteria.select <- select( Pre_FMT_bacteria, OTU, subject_id, treated_with_donor )
# Make a list per recipient
Pre_FMT_per_recipient <- unstack( Pre_FMT_bacteria.select[ ,1:2 ])

# Collect data for patients per timepoint
# and convert to dataframe for easier processing
Post_1_bacteria <- psmelt( physeq_mOTU ) %>%
  filter( timepoint.new == "Post-1" ) %>%
  filter( Abundance > 0 ) %>%
  arrange( subject_id )

# Now list all species present in each patient before FMT
Post_1_bacteria.select <- select( Post_1_bacteria, OTU, subject_id, treated_with_donor )
# Make a list per recipient
Post_1_per_recipient <- unstack( Post_1_bacteria.select[ ,1:2 ])

# Collect data for patients per timepoint
# and convert to dataframe for easier processing
Post_2_bacteria <- psmelt( physeq_mOTU ) %>%
  filter( timepoint.new == "Post-2" ) %>%
  filter( Abundance > 0 ) %>%
  arrange( subject_id )

# Now list all species present in each patient before FMT
Post_2_bacteria.select <- select( Post_2_bacteria, OTU, subject_id, treated_with_donor )
# Make a list per recipient
Post_2_per_recipient <- unstack( Post_2_bacteria.select[ ,1:2 ])

# Collect data for patients per timepoint
# and convert to dataframe for easier processing
Post_3_bacteria <- psmelt( physeq_mOTU ) %>%
  filter( timepoint.new == "Post-3" ) %>%
  filter( Abundance > 0 ) %>%
  arrange( subject_id )

# Now list all species present in each patient before FMT
Post_3_bacteria.select <- select( Post_3_bacteria, OTU, subject_id, treated_with_donor )
# Make a list per recipient
Post_3_per_recipient <- unstack( Post_3_bacteria.select[ ,1:2 ])

# Collect data for patients per timepoint
# and convert to dataframe for easier processing
Post_4_bacteria <- psmelt( physeq_mOTU ) %>%
  filter( timepoint.new == "Post-4" ) %>%
  filter( Abundance > 0 ) %>%
  arrange( subject_id )

# Now list all species present in each patient before FMT
Post_4_bacteria.select <- select( Post_4_bacteria, OTU, subject_id, treated_with_donor )
# Make a list per recipient
Post_4_per_recipient <- unstack( Post_4_bacteria.select[ ,1:2 ])

# Collect data for patients per timepoint
# and convert to dataframe for easier processing
Week8_bacteria <- psmelt( physeq_mOTU ) %>%
  filter( timepoint.new == "Week8" ) %>%
  filter( Abundance > 0 ) %>%
  arrange( subject_id )

# Now list all species present in each patient before FMT
Week8_bacteria.select <- select( Week8_bacteria, OTU, subject_id, treated_with_donor )
# Make a list per recipient
Week8_per_recipient <- unstack( Week8_bacteria.select[ ,1:2 ])

# Collect data for patients per timepoint
# and convert to dataframe for easier processing
Week10_bacteria <- psmelt( physeq_mOTU ) %>%
  filter( timepoint.new == "Week10" ) %>%
  filter( Abundance > 0 ) %>%
  arrange( subject_id )

# Now list all species present in each patient before FMT
Week10_bacteria.select <- select( Week10_bacteria, OTU, subject_id, treated_with_donor )
# Make a list per recipient
Week10_per_recipient <- unstack( Week10_bacteria.select[ ,1:2 ])

# Collect data for patients per timepoint
# and convert to dataframe for easier processing
Week14_bacteria <- psmelt( physeq_mOTU ) %>%
  filter( timepoint.new == "Week14" ) %>%
  filter( Abundance > 0 ) %>%
  arrange( subject_id )

# Now list all species present in each patient before FMT
Week14_bacteria.select <- select( Week14_bacteria, OTU, subject_id, treated_with_donor )
# Make a list per recipient
Week14_per_recipient <- unstack( Week14_bacteria.select[ ,1:2 ])
```

## Obtain results per patient per sample

```{r Remove donors, echo=TRUE}
# Remove donors
physeq_mOTU = subset_samples( physeq_mOTU, subject_id != "Donor A" )
physeq_mOTU = subset_samples( physeq_mOTU, subject_id != "Donor B" )
```

```{r Obtain information, echo=TRUE}
sub.id <- physeq_mOTU@sam_data[[ "subject_id" ]] %>% unique()
mOTUs.all <- physeq_mOTU@otu_table %>% rownames()
times <- physeq_mOTU@sam_data[[ "timepoint.new" ]] %>% unique()
```

```{r Dataframe with all mOTUs, echo=TRUE}
data.recipient <- matrix( nrow = length( mOTUs.all ), ncol = 11 )  
colnames( data.recipient ) <- c( "mOTUs", "Donor", "Baseline" ,"Pre_FMT", "Post_1", "Post_2", "Post_3",
                          "Post_4", "Week8", "Week10", "Week14" )
data.recipient[ ,1 ] <- mOTUs.all 
head( data.recipient )
```

```{r Loop through all patients, echo=TRUE}
# The list to store the results
listofresults <- list()

for( i in 1:length( physeq_mOTU@sam_data[[ "subject_id" ]] %>% unique())){
  patient = sub.id[[ i ]]
  patient.characteristics <- physeq_mOTU@sam_data[ paste( patient, "-FMT1", sep = "" )] %>% as.matrix()
  
  # select donor bacteria
  if( patient.characteristics[ ,"treated_with_donor" ] == "Donor A" ){
  Donor = donor_A_core_species
  } else if( patient.characteristics[ ,"treated_with_donor" ] == "Donor B" ) {
  Donor = donor_B_core_species }
  
  # select patient characteristics of interest
  patient.characteristics <- paste( patient.characteristics[ ,"subject_id" ] %>% as.character(), "-" , patient.characteristics[ ,"clinical_outcome_wk14" ] %>%
                                     as.character(), "-", patient.characteristics[ ,"treated_with_donor" ] %>% as.character(), "-",
                                   patient.characteristics[ ,"pretreatment" ] %>% as.character(), "-", patient.characteristics[ ,"age" ] %>% as.character(), "-",
                                   patient.characteristics[ ,"sex" ] %>% as.character())

  # mOTUs present/absent data
  for( j in 1:nrow( data.recipient )) {
    data.recipient[j,2] <- ifelse( data.recipient[j,1] %in% Donor, 1, 0)
    
    data.recipient[j,3] <- ifelse( data.recipient[j,1] %in% baseline_per_recipient[[ patient ]], 1, 0 )
    data.recipient[j,4] <- ifelse( data.recipient[j,1] %in% Pre_FMT_per_recipient[[ patient ]], 1, 0 )
  
    data.recipient[j,5] <- ifelse( data.recipient[j,1] %in% Post_1_per_recipient[[ patient ]], 1, 0 )
    data.recipient[j,6] <- ifelse( data.recipient[j,1] %in% Post_2_per_recipient[[ patient ]], 1, 0 )
    data.recipient[j,7] <- ifelse( data.recipient[j,1] %in% Post_3_per_recipient[[ patient ]], 1, 0 )
    data.recipient[j,8] <- ifelse( data.recipient[j,1] %in% Post_4_per_recipient[[ patient ]], 1, 0 )
    data.recipient[j,9] <- ifelse( data.recipient[j,1] %in% Week8_per_recipient[[ patient ]], 1, 0 )
    data.recipient[j,10] <- ifelse( data.recipient[j,1] %in% Week10_per_recipient[[ patient ]], 1, 0 )
    data.recipient[j,11] <- ifelse( data.recipient[j,1] %in% Week14_per_recipient[[ patient ]], 1, 0 )
    }
  
  data.recipient.sel <- data.recipient[apply(data.recipient[ ,-1 ], 1, function(x) !all( x == 0 )),] %>% as.data.frame()
  data.recipient.sel %>% head()
  data.recipient.sel[ ,2:11 ] <- sapply(data.recipient.sel[ ,2:11 ],as.numeric )
  data.recipient.sel[ ,2:11 ] %>% colSums()
  data.recipient.sel[ ,2:11 ][ data.recipient.sel[ ,2:11 ] %>% colSums() == 0 ] <- NA
  data.recipient.sel %>% head()
  
  # Possible combinations
  expand.grid( rep( list( 0:1 ), 3 ))
  expand.grid( rep( list( 0:1 ), 4 ))
  
  data.recipient.results <- matrix( ncol = 9, nrow = nrow( data.recipient.sel ))
  colnames( data.recipient.results ) <- c( "mOTUs", "Pre_FMT", "Post_1", "Post_2", "Post_3",
                                        "Post_4", "Week8", "Week10", "Week14" )
  data.recipient.results <- data.recipient.results %>% as.data.frame()
  data.recipient.results[ ,"mOTUs" ] <- data.recipient.sel[ ,"mOTUs" ]
  data.recipient.results %>% head()

  # Analyse the Pre_FMT timepoint
  for( j in 1:nrow( data.recipient.results )) {
    data.recipient.results[ j, 2 ] <- 
      if( is.na( data.recipient.sel[j,2] ) | is.na(data.recipient.sel[j,3]) | is.na(data.recipient.sel[j,4]) ) {
        NA
      } else if( data.recipient.sel[j,2] != 0 & data.recipient.sel[j,3] == 0 & data.recipient.sel[j,4] == 0 ) {
        "Rejection" 
      } else if( data.recipient.sel[j,2] != 0 & data.recipient.sel[j,3] != 0 & data.recipient.sel[j,4] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel[j,2] == 0 & data.recipient.sel[j,3] != 0 & data.recipient.sel[j,4] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel[j,2] != 0 & data.recipient.sel[j,3] != 0 & data.recipient.sel[j,4] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel[j,2] == 0 & data.recipient.sel[j,3] != 0 & data.recipient.sel[j,4] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel[j,2] != 0 & data.recipient.sel[j,3] == 0 & data.recipient.sel[j,4] != 0 ) {
        "Colonisation" 
      } else if( data.recipient.sel[j,2] == 0 & data.recipient.sel[j,3] == 0 & data.recipient.sel[j,4] != 0 ) {
        "Novel" 
      } else if( data.recipient.sel[j,2] == 0 & data.recipient.sel[j,3] == 0 & data.recipient.sel[j,4] == 0 ) {
        "Absent"
      }
  }

  # Analyse the post_1 timepoint
  data.recipient.sel %>% head()
  data.recipient.sel.2 <- data.recipient.sel
  data.recipient.sel.2 <- data.recipient.sel.2 %>% 
    replace( is.na( data.recipient.sel.2 ), 0 ) %>% 
    dplyr::mutate( Pre_FMT2 = Baseline + Pre_FMT )
  data.recipient.sel.2 <- data.recipient.sel.2[ c( 1, 2, 12, 5:11 )]
  data.recipient.sel.2 %>% head()

  for( j in 1:nrow( data.recipient.results )) {
    data.recipient.results[j,3] <- 
      if( is.na(data.recipient.sel[j,5]) ) {
        NA
      } else if( data.recipient.sel.2[j,2] != 0 & data.recipient.sel.2[j,3] == 0 & 
          data.recipient.sel.2[j,4] == 0 & data.recipient.sel.2[j,5] == 0 ) {
        "Rejection" 
      } else if( data.recipient.sel.2[j,2] == 0 & data.recipient.sel.2[j,3] != 0 & 
                 data.recipient.sel.2[j,4] == 0 & data.recipient.sel.2[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.2[j,2] != 0 & data.recipient.sel.2[j,3] != 0 & 
                 data.recipient.sel.2[j,4] == 0 & data.recipient.sel.2[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.2[j,2] == 0 & data.recipient.sel.2[j,3] == 0 & 
                 data.recipient.sel.2[j,4] != 0 & data.recipient.sel.2[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.2[j,2] == 0 & data.recipient.sel.2[j,3] != 0 & 
                 data.recipient.sel.2[j,4] != 0 & data.recipient.sel.2[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.2[j,2] != 0 & data.recipient.sel.2[j,3] != 0 & 
                data.recipient.sel.2[j,4] != 0 & data.recipient.sel.2[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.2[j,2] != 0 & data.recipient.sel.2[j,3] == 0 & 
               data.recipient.sel.2[j,4] != 0 & data.recipient.sel.2[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.2[j,2] == 0 & data.recipient.sel.2[j,3] == 0 & 
                 data.recipient.sel.2[j,4] == 0 & data.recipient.sel.2[j,5] != 0 ) {
        "Novel" 
      } else if( data.recipient.sel.2[j,2] != 0 & data.recipient.sel.2[j,3] == 0 & 
                data.recipient.sel.2[j,4] == 0 & data.recipient.sel.2[j,5] != 0 ) {
       "Colonisation" 
      } else if( data.recipient.sel.2[j,2] != 0 & data.recipient.sel.2[j,3] == 0 & 
               data.recipient.sel.2[j,4] != 0 & data.recipient.sel.2[j,5] != 0 ) {
        "Colonisation" 
      } else if( data.recipient.sel.2[j,2] == 0 & data.recipient.sel.2[j,3] != 0 & 
               data.recipient.sel.2[j,4] == 0 & data.recipient.sel.2[j,5] != 0 ) {
        "Transient" 
      } else if( data.recipient.sel.2[j,2] != 0 & data.recipient.sel.2[j,3] != 0 & 
               data.recipient.sel.2[j,4] == 0 & data.recipient.sel.2[j,5] != 0 ) {
        "Transient" 
      } else if( data.recipient.sel.2[j,2] == 0 & data.recipient.sel.2[j,3] == 0 & 
               data.recipient.sel.2[j,4] != 0 & data.recipient.sel.2[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.2[j,2] == 0 & data.recipient.sel.2[j,3] != 0 & 
               data.recipient.sel.2[j,4] != 0 & data.recipient.sel.2[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.2[j,2] != 0 & data.recipient.sel.2[j,3] != 0 & 
               data.recipient.sel.2[j,4] != 0 & data.recipient.sel.2[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.2[j,2] == 0 & data.recipient.sel.2[j,3] == 0 & 
               data.recipient.sel.2[j,4] == 0 & data.recipient.sel.2[j,5] == 0 ) {
        "Absent" 
      }
  }

  # analyse the post_2 timepoint
  data.recipient.sel.2 %>% head()
  data.recipient.sel.3 <- data.recipient.sel.2
  data.recipient.sel.3 %>% head()

  for( j in 1:nrow( data.recipient.results )) {
    data.recipient.results[j,4] <- 
      if( is.na( data.recipient.sel[j,6] ) ) {
        NA
      } else if( data.recipient.sel.3[j,2] != 0 & data.recipient.sel.3[j,3] == 0 & 
          data.recipient.sel.3[j,4] == 0 & data.recipient.sel.3[j,5] == 0 ) {
        "Rejection" 
      } else if( data.recipient.sel.3[j,2] == 0 & data.recipient.sel.3[j,3] != 0 & 
                 data.recipient.sel.3[j,4] == 0 & data.recipient.sel.3[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.3[j,2] != 0 & data.recipient.sel.3[j,3] != 0 & 
                 data.recipient.sel.3[j,4] == 0 & data.recipient.sel.3[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.3[j,2] == 0 & data.recipient.sel.3[j,3] == 0 & 
                 data.recipient.sel.3[j,4] != 0 & data.recipient.sel.3[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.3[j,2] == 0 & data.recipient.sel.3[j,3] != 0 & 
                 data.recipient.sel.3[j,4] != 0 & data.recipient.sel.3[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.3[j,2] != 0 & data.recipient.sel.3[j,3] != 0 & 
                 data.recipient.sel.3[j,4] != 0 & data.recipient.sel.3[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.3[j,2] != 0 & data.recipient.sel.3[j,3] == 0 & 
                 data.recipient.sel.3[j,4] != 0 & data.recipient.sel.3[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.3[j,2] == 0 & data.recipient.sel.3[j,3] == 0 & 
                 data.recipient.sel.3[j,4] == 0 & data.recipient.sel.3[j,5] != 0 ) {
        "Novel" 
      } else if( data.recipient.sel.3[j,2] != 0 & data.recipient.sel.3[j,3] == 0 & 
                 data.recipient.sel.3[j,4] == 0 & data.recipient.sel.3[j,5] != 0 ) {
        "Colonisation" 
      } else if( data.recipient.sel.3[j,2] != 0 & data.recipient.sel.3[j,3] == 0 & 
                 data.recipient.sel.3[j,4] != 0 & data.recipient.sel.3[j,5] != 0 ) {
        "Colonisation" 
      } else if( data.recipient.sel.3[j,2] == 0 & data.recipient.sel.3[j,3] != 0 & 
                 data.recipient.sel.3[j,4] == 0 & data.recipient.sel.3[j,5] != 0 ) {
        "Transient" 
      } else if( data.recipient.sel.3[j,2] != 0 & data.recipient.sel.3[j,3] != 0 & 
                 data.recipient.sel.3[j,4] == 0 & data.recipient.sel.3[j,5] != 0 ) {
        "Transient" 
      } else if( data.recipient.sel.3[j,2] == 0 & data.recipient.sel.3[j,3] == 0 & 
                 data.recipient.sel.3[j,4] != 0 & data.recipient.sel.3[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.3[j,2] == 0 & data.recipient.sel.3[j,3] != 0 & 
                 data.recipient.sel.3[j,4] != 0 & data.recipient.sel.3[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.3[j,2] != 0 & data.recipient.sel.3[j,3] != 0 & 
                 data.recipient.sel.3[j,4] != 0 & data.recipient.sel.3[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.3[j,2] == 0 & data.recipient.sel.3[j,3] == 0 & 
                 data.recipient.sel.3[j,4] == 0 & data.recipient.sel.3[j,5] == 0 ) {
        "Absent" 
      }
  }

  # Analyse the post_3 timepoint
  data.recipient.sel.3 %>% head()
  data.recipient.sel.4 <- data.recipient.sel.3
  data.recipient.sel.4 <- data.recipient.sel.4 %>% dplyr::mutate(Post_FMT = Post_1 + Post_2 )
  data.recipient.sel.4 <- data.recipient.sel.4[ c( 1:3, 11, 6:10 )]
  data.recipient.sel.4 %>% head()
  
  for( j in 1:nrow( data.recipient.results )) {
    data.recipient.results[j,5] <- 
      if( is.na( data.recipient.sel[j,7] ) ) {
        NA
      } else if( data.recipient.sel.4[j,2] != 0 & data.recipient.sel.4[j,3] == 0 & 
          data.recipient.sel.4[j,4] == 0 & data.recipient.sel.4[j,5] == 0 ) {
        "Rejection" 
      } else if( data.recipient.sel.4[j,2] == 0 & data.recipient.sel.4[j,3] != 0 & 
                 data.recipient.sel.4[j,4] == 0 & data.recipient.sel.4[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.4[j,2] != 0 & data.recipient.sel.4[j,3] != 0 & 
                 data.recipient.sel.4[j,4] == 0 & data.recipient.sel.4[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.4[j,2] == 0 & data.recipient.sel.4[j,3] == 0 & 
                 data.recipient.sel.4[j,4] != 0 & data.recipient.sel.4[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.4[j,2] == 0 & data.recipient.sel.4[j,3] != 0 & 
                 data.recipient.sel.4[j,4] != 0 & data.recipient.sel.4[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.4[j,2] != 0 & data.recipient.sel.4[j,3] != 0 & 
                 data.recipient.sel.4[j,4] != 0 & data.recipient.sel.4[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.4[j,2] != 0 & data.recipient.sel.4[j,3] == 0 & 
                 data.recipient.sel.4[j,4] != 0 & data.recipient.sel.4[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.4[j,2] == 0 & data.recipient.sel.4[j,3] == 0 & 
                 data.recipient.sel.4[j,4] == 0 & data.recipient.sel.4[j,5] != 0 ) {
        "Novel" 
      } else if( data.recipient.sel.4[j,2] != 0 & data.recipient.sel.4[j,3] == 0 & 
                 data.recipient.sel.4[j,4] == 0 & data.recipient.sel.4[j,5] != 0 ) {
        "Colonisation" 
      } else if( data.recipient.sel.4[j,2] != 0 & data.recipient.sel.4[j,3] == 0 & 
                 data.recipient.sel.4[j,4] != 0 & data.recipient.sel.4[j,5] != 0 ) {
        "Colonisation" 
      } else if( data.recipient.sel.4[j,2] == 0 & data.recipient.sel.4[j,3] != 0 & 
                 data.recipient.sel.4[j,4] == 0 & data.recipient.sel.4[j,5] != 0 ) {
        "Transient" 
      } else if( data.recipient.sel.4[j,2] != 0 & data.recipient.sel.4[j,3] != 0 & 
                 data.recipient.sel.4[j,4] == 0 & data.recipient.sel.4[j,5] != 0 ) {
        "Transient" 
      } else if( data.recipient.sel.4[j,2] == 0 & data.recipient.sel.4[j,3] == 0 & 
                 data.recipient.sel.4[j,4] != 0 & data.recipient.sel.4[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.4[j,2] == 0 & data.recipient.sel.4[j,3] != 0 & 
                 data.recipient.sel.4[j,4] != 0 & data.recipient.sel.4[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.4[j,2] != 0 & data.recipient.sel.4[j,3] != 0 & 
                 data.recipient.sel.4[j,4] != 0 & data.recipient.sel.4[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.4[j,2] == 0 & data.recipient.sel.4[j,3] == 0 & 
                 data.recipient.sel.4[j,4] == 0 & data.recipient.sel.4[j,5] == 0 ) {
        "Absent" 
      }
  }
  
  # analyse the post 4 timepoint
  data.recipient.sel.4 %>% head()
  data.recipient.sel.5 <- data.recipient.sel.4
  data.recipient.sel.5 <- data.recipient.sel.5 %>% dplyr::mutate(Post_FMT = Post_FMT + Post_3 )
  data.recipient.sel.5 <- data.recipient.sel.5[ c( 1:4, 6:9 )]
  data.recipient.sel.5 %>% head()
  
  for( j in 1:nrow( data.recipient.results )) {
    data.recipient.results[j,6] <- 
      if( is.na( data.recipient.sel[j,8] ) ) {
        NA
      } else if( data.recipient.sel.5[j,2] != 0 & data.recipient.sel.5[j,3] == 0 & 
          data.recipient.sel.5[j,4] == 0 & data.recipient.sel.5[j,5] == 0 ) {
        "Rejection" 
      } else if( data.recipient.sel.5[j,2] == 0 & data.recipient.sel.5[j,3] != 0 & 
                 data.recipient.sel.5[j,4] == 0 & data.recipient.sel.5[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.5[j,2] != 0 & data.recipient.sel.5[j,3] != 0 & 
                 data.recipient.sel.5[j,4] == 0 & data.recipient.sel.5[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.5[j,2] == 0 & data.recipient.sel.5[j,3] == 0 & 
                 data.recipient.sel.5[j,4] != 0 & data.recipient.sel.5[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.5[j,2] == 0 & data.recipient.sel.5[j,3] != 0 & 
                 data.recipient.sel.5[j,4] != 0 & data.recipient.sel.5[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.5[j,2] != 0 & data.recipient.sel.5[j,3] != 0 & 
                 data.recipient.sel.5[j,4] != 0 & data.recipient.sel.5[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.5[j,2] != 0 & data.recipient.sel.5[j,3] == 0 & 
                 data.recipient.sel.5[j,4] != 0 & data.recipient.sel.5[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.5[j,2] == 0 & data.recipient.sel.5[j,3] == 0 & 
                 data.recipient.sel.5[j,4] == 0 & data.recipient.sel.5[j,5] != 0 ) {
        "Novel" 
      } else if( data.recipient.sel.5[j,2] != 0 & data.recipient.sel.5[j,3] == 0 & 
                 data.recipient.sel.5[j,4] == 0 & data.recipient.sel.5[j,5] != 0 ) {
        "Colonisation" 
      } else if( data.recipient.sel.5[j,2] != 0 & data.recipient.sel.5[j,3] == 0 & 
                 data.recipient.sel.5[j,4] != 0 & data.recipient.sel.5[j,5] != 0 ) {
        "Colonisation" 
      } else if( data.recipient.sel.5[j,2] == 0 & data.recipient.sel.5[j,3] != 0 & 
                 data.recipient.sel.5[j,4] == 0 & data.recipient.sel.5[j,5] != 0 ) {
        "Transient" 
      } else if( data.recipient.sel.5[j,2] != 0 & data.recipient.sel.5[j,3] != 0 & 
                 data.recipient.sel.5[j,4] == 0 & data.recipient.sel.5[j,5] != 0 ) {
        "Transient" 
      } else if( data.recipient.sel.5[j,2] == 0 & data.recipient.sel.5[j,3] == 0 & 
                 data.recipient.sel.5[j,4] != 0 & data.recipient.sel.5[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.5[j,2] == 0 & data.recipient.sel.5[j,3] != 0 & 
                 data.recipient.sel.5[j,4] != 0 & data.recipient.sel.5[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.5[j,2] != 0 & data.recipient.sel.5[j,3] != 0 & 
                 data.recipient.sel.5[j,4] != 0 & data.recipient.sel.5[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.5[j,2] == 0 & data.recipient.sel.5[j,3] == 0 & 
                 data.recipient.sel.5[j,4] == 0 & data.recipient.sel.5[j,5] == 0 ) {
        "Absent" 
      }
  }
  
  # analyse the Week 8 timepoint
  data.recipient.sel.5 %>% head()
  data.recipient.sel.6 <- data.recipient.sel.5
  data.recipient.sel.6 <- data.recipient.sel.6 %>% dplyr::mutate(Post_FMT = Post_FMT + Post_4 )
  data.recipient.sel.6 <- data.recipient.sel.6[ c( 1:4, 6:8 )]
  data.recipient.sel.6 %>% head()
  
  for( j in 1:nrow( data.recipient.results )) {
    data.recipient.results[j,7] <- 
      if( is.na( data.recipient.sel[j,9] ) ) {
        NA
      } else if( data.recipient.sel.6[j,2] != 0 & data.recipient.sel.6[j,3] == 0 & 
          data.recipient.sel.6[j,4] == 0 & data.recipient.sel.6[j,5] == 0 ) {
        "Rejection" 
      } else if( data.recipient.sel.6[j,2] == 0 & data.recipient.sel.6[j,3] != 0 & 
                 data.recipient.sel.6[j,4] == 0 & data.recipient.sel.6[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.6[j,2] != 0 & data.recipient.sel.6[j,3] != 0 & 
                 data.recipient.sel.6[j,4] == 0 & data.recipient.sel.6[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.6[j,2] == 0 & data.recipient.sel.6[j,3] == 0 & 
                 data.recipient.sel.6[j,4] != 0 & data.recipient.sel.6[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.6[j,2] == 0 & data.recipient.sel.6[j,3] != 0 & 
                 data.recipient.sel.6[j,4] != 0 & data.recipient.sel.6[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.6[j,2] != 0 & data.recipient.sel.6[j,3] != 0 & 
                 data.recipient.sel.6[j,4] != 0 & data.recipient.sel.6[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.6[j,2] != 0 & data.recipient.sel.6[j,3] == 0 & 
                 data.recipient.sel.6[j,4] != 0 & data.recipient.sel.6[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.6[j,2] == 0 & data.recipient.sel.6[j,3] == 0 & 
                 data.recipient.sel.6[j,4] == 0 & data.recipient.sel.6[j,5] != 0 ) {
        "Novel" 
      } else if( data.recipient.sel.6[j,2] != 0 & data.recipient.sel.6[j,3] == 0 & 
                 data.recipient.sel.6[j,4] == 0 & data.recipient.sel.6[j,5] != 0 ) {
        "Colonisation" 
      } else if( data.recipient.sel.6[j,2] != 0 & data.recipient.sel.6[j,3] == 0 & 
                 data.recipient.sel.6[j,4] != 0 & data.recipient.sel.6[j,5] != 0 ) {
        "Colonisation" 
      } else if( data.recipient.sel.6[j,2] == 0 & data.recipient.sel.6[j,3] != 0 & 
                 data.recipient.sel.6[j,4] == 0 & data.recipient.sel.6[j,5] != 0 ) {
        "Transient" 
      } else if( data.recipient.sel.6[j,2] != 0 & data.recipient.sel.6[j,3] != 0 & 
                 data.recipient.sel.6[j,4] == 0 & data.recipient.sel.6[j,5] != 0 ) {
        "Transient" 
      } else if( data.recipient.sel.6[j,2] == 0 & data.recipient.sel.6[j,3] == 0 & 
                 data.recipient.sel.6[j,4] != 0 & data.recipient.sel.6[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.6[j,2] == 0 & data.recipient.sel.6[j,3] != 0 & 
                 data.recipient.sel.6[j,4] != 0 & data.recipient.sel.6[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.6[j,2] != 0 & data.recipient.sel.6[j,3] != 0 & 
                 data.recipient.sel.6[j,4] != 0 & data.recipient.sel.6[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.6[j,2] == 0 & data.recipient.sel.6[j,3] == 0 & 
                 data.recipient.sel.6[j,4] == 0 & data.recipient.sel.6[j,5] == 0 ) {
        "Absent" 
      }
  }
  
  # analyse the Week 10 timepoint
  data.recipient.sel.6 %>% head()
  data.recipient.sel.7 <- data.recipient.sel.6
  data.recipient.sel.7 <- data.recipient.sel.7 %>% dplyr::mutate(Post_FMT = Post_FMT + Week8 )
  data.recipient.sel.7 <- data.recipient.sel.7[ c( 1:4, 6:7 )]
  data.recipient.sel.7 %>% head()
  
  for(j in 1:nrow( data.recipient.results )) {
    data.recipient.results[j,8] <- 
      if( is.na( data.recipient.sel[j,10] ) ) {
        NA
      } else if( data.recipient.sel.7[j,2] != 0 & data.recipient.sel.7[j,3] == 0 & 
          data.recipient.sel.7[j,4] == 0 & data.recipient.sel.7[j,5] == 0 ) {
        "Rejection" 
      } else if( data.recipient.sel.7[j,2] == 0 & data.recipient.sel.7[j,3] != 0 & 
                 data.recipient.sel.7[j,4] == 0 & data.recipient.sel.7[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.7[j,2] != 0 & data.recipient.sel.7[j,3] != 0 & 
                 data.recipient.sel.7[j,4] == 0 & data.recipient.sel.7[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.7[j,2] == 0 & data.recipient.sel.7[j,3] == 0 & 
                 data.recipient.sel.7[j,4] != 0 & data.recipient.sel.7[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.7[j,2] == 0 & data.recipient.sel.7[j,3] != 0 & 
                 data.recipient.sel.7[j,4] != 0 & data.recipient.sel.7[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.7[j,2] != 0 & data.recipient.sel.7[j,3] != 0 & 
                 data.recipient.sel.7[j,4] != 0 & data.recipient.sel.7[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.7[j,2] != 0 & data.recipient.sel.7[j,3] == 0 & 
                 data.recipient.sel.7[j,4] != 0 & data.recipient.sel.7[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.7[j,2] == 0 & data.recipient.sel.7[j,3] == 0 & 
                 data.recipient.sel.7[j,4] == 0 & data.recipient.sel.7[j,5] != 0 ) {
        "Novel" 
      } else if( data.recipient.sel.7[j,2] != 0 & data.recipient.sel.7[j,3] == 0 & 
                 data.recipient.sel.7[j,4] == 0 & data.recipient.sel.7[j,5] != 0 ) {
        "Colonisation" 
      } else if( data.recipient.sel.7[j,2] != 0 & data.recipient.sel.7[j,3] == 0 & 
                 data.recipient.sel.7[j,4] != 0 & data.recipient.sel.7[j,5] != 0 ) {
        "Colonisation" 
      } else if( data.recipient.sel.7[j,2] == 0 & data.recipient.sel.7[j,3] != 0 & 
                 data.recipient.sel.7[j,4] == 0 & data.recipient.sel.7[j,5] != 0 ) {
        "Transient" 
      } else if( data.recipient.sel.7[j,2] != 0 & data.recipient.sel.7[j,3] != 0 & 
                 data.recipient.sel.7[j,4] == 0 & data.recipient.sel.7[j,5] != 0 ) {
        "Transient" 
      } else if( data.recipient.sel.7[j,2] == 0 & data.recipient.sel.7[j,3] == 0 & 
                 data.recipient.sel.7[j,4] != 0 & data.recipient.sel.7[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.7[j,2] == 0 & data.recipient.sel.7[j,3] != 0 & 
                 data.recipient.sel.7[j,4] != 0 & data.recipient.sel.7[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.7[j,2] != 0 & data.recipient.sel.7[j,3] != 0 & 
                 data.recipient.sel.7[j,4] != 0 & data.recipient.sel.7[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.7[j,2] == 0 & data.recipient.sel.7[j,3] == 0 & 
                 data.recipient.sel.7[j,4] == 0 & data.recipient.sel.7[j,5] == 0 ) {
        "Absent" 
      }
  }
  
  # analyse the Week 14 timepoint
  data.recipient.sel.7 %>% head()
  data.recipient.sel.8 <- data.recipient.sel.7
  data.recipient.sel.8 <- data.recipient.sel.8 %>% dplyr::mutate(Post_FMT = Post_FMT + Week10 )
  data.recipient.sel.8 <- data.recipient.sel.8[ c( 1:4, 6 )]
  data.recipient.sel.8 %>% head()
  
  for( j in 1:nrow( data.recipient.results )) {
    data.recipient.results[j,9] <- 
      if( is.na( data.recipient.sel[j,11] ) ) {
        NA
      } else if( data.recipient.sel.8[j,2] != 0 & data.recipient.sel.8[j,3] == 0 & 
                 data.recipient.sel.8[j,4] == 0 & data.recipient.sel.8[j,5] == 0 ) {
        "Rejection" 
      } else if( data.recipient.sel.8[j,2] == 0 & data.recipient.sel.8[j,3] != 0 & 
                 data.recipient.sel.8[j,4] == 0 & data.recipient.sel.8[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.8[j,2] != 0 & data.recipient.sel.8[j,3] != 0 & 
                 data.recipient.sel.8[j,4] == 0 & data.recipient.sel.8[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.8[j,2] == 0 & data.recipient.sel.8[j,3] == 0 & 
                 data.recipient.sel.8[j,4] != 0 & data.recipient.sel.8[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.8[j,2] == 0 & data.recipient.sel.8[j,3] != 0 & 
                 data.recipient.sel.8[j,4] != 0 & data.recipient.sel.8[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.8[j,2] != 0 & data.recipient.sel.8[j,3] != 0 & 
                 data.recipient.sel.8[j,4] != 0 & data.recipient.sel.8[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.8[j,2] != 0 & data.recipient.sel.8[j,3] == 0 & 
                 data.recipient.sel.8[j,4] != 0 & data.recipient.sel.8[j,5] == 0 ) {
        "Species loss" 
      } else if( data.recipient.sel.8[j,2] == 0 & data.recipient.sel.8[j,3] == 0 & 
                 data.recipient.sel.8[j,4] == 0 & data.recipient.sel.8[j,5] != 0 ) {
        "Novel" 
      } else if( data.recipient.sel.8[j,2] != 0 & data.recipient.sel.8[j,3] == 0 & 
                 data.recipient.sel.8[j,4] == 0 & data.recipient.sel.8[j,5] != 0 ) {
        "Colonisation" 
      } else if( data.recipient.sel.8[j,2] != 0 & data.recipient.sel.8[j,3] == 0 & 
                 data.recipient.sel.8[j,4] != 0 & data.recipient.sel.8[j,5] != 0 ) {
        "Colonisation" 
      } else if( data.recipient.sel.8[j,2] == 0 & data.recipient.sel.8[j,3] != 0 & 
                 data.recipient.sel.8[j,4] == 0 & data.recipient.sel.8[j,5] != 0 ) {
        "Transient" 
      } else if( data.recipient.sel.8[j,2] != 0 & data.recipient.sel.8[j,3] != 0 & 
                 data.recipient.sel.8[j,4] == 0 & data.recipient.sel.8[j,5] != 0 ) {
        "Transient" 
      } else if( data.recipient.sel.8[j,2] == 0 & data.recipient.sel.8[j,3] == 0 & 
                 data.recipient.sel.8[j,4] != 0 & data.recipient.sel.8[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.8[j,2] == 0 & data.recipient.sel.8[j,3] != 0 & 
                 data.recipient.sel.8[j,4] != 0 & data.recipient.sel.8[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.8[j,2] != 0 & data.recipient.sel.8[j,3] != 0 & 
                 data.recipient.sel.8[j,4] != 0 & data.recipient.sel.8[j,5] != 0 ) {
        "Persistence" 
      } else if( data.recipient.sel.8[j,2] == 0 & data.recipient.sel.8[j,3] == 0 & 
                 data.recipient.sel.8[j,4] == 0 & data.recipient.sel.8[j,5] == 0 ) {
        "Absent" 
      }
  }
  data.recipient.results.meta <- cbind( data.recipient.results, patient.characteristics )
  listofresults[[ i ]]  <- data.recipient.results.meta

  # print( i )
  }
  
head( listofresults[[ 1 ]])
```

```{r Make the count dataset, echo=TRUE, message=FALSE, warning=FALSE}
# count data
resultscounts <- list()
for(i in 1:length( listofresults )){
  resultscounts[[i]] <- listofresults[[i]] %>% 
    pivot_longer(cols = c(Pre_FMT, Post_1, Post_2, Post_3,
                          Post_4, Week8, Week10, Week14), names_to = "timepoint", values_to = "index") %>% 
    group_by(timepoint) %>% 
    mutate(index = factor(index, levels = c("Rejection", "Species loss",
                                                "Novel", "Colonisation", "Transient", "Persistence",  
                                                "Absent" ))) %>% 
    filter(index != "Absent") %>%
    summarise(n = c((table(index)))) %>% 
    mutate(index = c("Rejection", "Species loss",
                       "Novel", "Colonisation", "Transient", "Persistence",  
                       "Absent")) 
  
  resultscounts[[ i ]]$timepoint = factor(resultscounts[[ i ]]$timepoint, levels = c(  "Pre_FMT","Post_1", "Post_2", "Post_3",
                                                        "Post_4", "Week8", "Week10", "Week14" ))
  resultscounts[[ i ]]$patient.characteristics <- listofresults[[i]]$patient.characteristics %>% unique()
  resultscounts[[ i ]][c('Patient_ID', 'State', 'Donor', 'Pretreatment', 'Age', 'Sex')] <- str_split_fixed(resultscounts[[ i ]]$patient.characteristics, ' - ', 6)
  resultscounts[[ i ]] <- resultscounts[[ i ]][c('Patient_ID', 'State', 'Donor', 'Pretreatment', 'Age', 'Sex' ,'timepoint', 'index', 'n')]
}
```

```{r Unlist, echo=TRUE}
results.all.count <- bind_rows( resultscounts, .id = "column_label" )
results.all.count <- results.all.count[ c( 2:10 )]
```

## Save results

```{r Save phyloseq, eval=FALSE}
save( results.all.count, file = "results.all.count.short.Rda" )
```

## Investigate results

```{r Investigate results, echo=TRUE}
dim( results.all.count )
head( results.all.count )
typeof( results.all.count )
hist( results.all.count$n, n = 50 )
results.all.count$timepoint %>% unique()
results.all.count$index %>% unique()
```

## Preprocessing for modeling

```{r Preprocessing the data, echo=TRUE}
# Remove category 'Absent', because always 9
results.all.count <- results.all.count  %>% filter( index != "Absent" )

# Remove information in Pre-FMT transient category (because always 0)
results.all.count$n[ results.all.count$timepoint == "Pre_FMT"&results.all.count$index == "Transient" ] <- NA

# make time categorical (translate to weeks)
results.all.count$time <- 0
results.all.count$time[ results.all.count$timepoint == "Pre_FMT" ] <- 0
results.all.count$time[ results.all.count$timepoint =="Post_1" ] <- 1
results.all.count$time[ results.all.count$timepoint == "Post_2" ] <- 2
results.all.count$time[ results.all.count$timepoint == "Post_3" ] <- 3
results.all.count$time[ results.all.count$timepoint == "Post_4" ] <- 4
results.all.count$time[ results.all.count$timepoint == "Week8" ] <- 8
results.all.count$time[ results.all.count$timepoint == "Week10" ] <- 10
results.all.count$time[ results.all.count$timepoint =="Week14" ] <- 14

# Rescale time, because of the warning (Model is nearly unidentifiable: very large eigenvalue)
results.all.count$time2 <- results.all.count$time / 52

# Rescale age
results.all.count$Age <- results.all.count$Age %>% as.numeric()
results.all.count$Age2 <- results.all.count$Age / 10
```

## Model the ecological outcomes

```{r Modelling, echo=TRUE, fig.width = 9, height = 9}
# with 3 splines
model.eco <- glmer.nb( n ~ ns( time2, df = 3 )  * index + State * index + Donor + Pretreatment + Age2 + Sex + ( 1 | Patient_ID ), 
                        data = results.all.count[ results.all.count$Patient_ID != "109" & 
                                                 results.all.count$Patient_ID != "117", ])
summary( model.eco )

plot_summs( model.eco ) +
theme( panel.grid.major = element_line(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    axis.line = element_line(),
    text = element_text( family = 'Helvetica' ),
    legend.title = element_blank(), 
    axis.text = element_text( size = 25 ),
    axis.title = element_text( size = 15 ))

wald.test( Sigma = vcov( model.eco ), b = fixef( model.eco ), Terms = c( 5, 6, 7, 8, 9, 15:34 )) # ecological index
wald.test( Sigma = vcov( model.eco ), b = fixef( model.eco ), Terms = c( 10, 30, 31, 32, 33, 34 )) # Clinical state 
wald.test( Sigma = vcov( model.eco ), b = fixef( model.eco ), Terms = c( 14 )) # Sex
wald.test( Sigma = vcov( model.eco ), b = fixef( model.eco ), Terms = c( 13 )) # Age
wald.test( Sigma = vcov( model.eco ), b = fixef( model.eco ), Terms = c( 12 )) # Pretreatment
wald.test( Sigma = vcov( model.eco ), b = fixef( model.eco ), Terms = c( 11 )) # Donor

```

## Plot ecological outcomes per timepoint per disease state

```{r Plot outcomes per state, echo=TRUE, fig.width = 9, fig.height= 9, warning=FALSE}
State.labs <- c( "Responders", "Non Responders")
names( State.labs ) <- c( "Good", "None" )

ggplot( results.all.count,
        aes( x = timepoint, y = n, col = index )) + 
  geom_jitter() + 
  theme_bw() +
  geom_boxplot( alpha=0.2 ) + 
  facet_grid( State ~ index, scales = "free",
              labeller = labeller(State = State.labs )) +
  theme( text = element_text( size = 20 ),
         axis.text.x = element_text( angle = 45, hjust = 1 )) 
```

## Plot ecological outcomes per timepoint per patient

```{r Plot outcomes per patient, echo=TRUE, fig.width = 9, fig.height = 9, warning=FALSE}
State.labs <- c( "Responder", "Non Responder")
names( State.labs ) <- c( "Good", "None" )

ggplot( data = results.all.count, aes( x = timepoint, y = n, color = index )) +
  geom_point( size = 2 ) +
  geom_line( aes( group = index )) +
  facet_wrap( facets =  State ~ Patient_ID  ,
              labeller = labeller(State = State.labs ),
              ncol = 9, nrow = 3) +
  scale_y_log10() +
  theme_bw() +
  ggtitle( "Indices per patient" ) +
  labs( x = "Timepoint", y = "n (log)" ) +
  theme( text = element_text( size = 20 ),
         axis.text.x = element_text( angle = 90 )) 
```