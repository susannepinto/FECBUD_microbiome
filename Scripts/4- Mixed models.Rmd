---
title: "Top 10 families Mixed models"
date: "December 2022"
authors: "S. Pinto and D. Sajbenova"
output:
  github_document: default
  word_document: default
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load required packages

```{r Load packages 1, echo=TRUE, message=FALSE}
library( dplyr )
library( magrittr )
library( knitr )
library( tidyverse )
```

```{r Load packages 2, echo=TRUE, message=FALSE, warning=FALSE}
library( phyloseq )
library( microbiome )
library( microViz )
library( lattice )
library( latticeExtra )
library( nlme )
library( glmmTMB )
library( splines )
library( lme4 )
library( MuMIn ) 
library( aod )
library( DHARMa )
library( jtools )
library( dotwhisker )
```

```{r Load packages 3, echo=TRUE, message=FALSE}
library( broom )
library( broom.mixed )
library( dotwhisker )
library( tidyverse )
library( tibble )
```

## Load the data

Here we use the compositional count abundance dataset, else problems with convergence occur.

```{r Load Data, echo=FALSE}
physeq_mOTU <- readRDS( "/Volumes/My Passport for Mac/FECBUD studie/FECBUD GitHub/Data/FECBUD_physeq_filt_countdata.rds" ) 
```

## Preprocessing of the data

```{r Phyloseq object, echo=TRUE}
# Make compositional
physeq_mOTU = microbiome::transform(physeq_mOTU, "compositional")

# Aggregate to family level
physeq_mOTU = aggregate_taxa( physeq_mOTU, "family" )
physeq_mOTU
```

```{r Preprocessing, echo=TRUE}
# Remove donors from data
physeq_mOTU = subset_samples( physeq_mOTU, subject_id != "Donor A" )
physeq_mOTU = subset_samples( physeq_mOTU, subject_id != "Donor B" )

# make new class - Coriobacteriaceae
physeq_mOTU = merge_taxa2(physeq_mOTU, pattern = "_Coriobacteriaceae", name = "Coriobacteriaceae")
```

```{r Sample data, echo=TRUE}
# Sample data
sample.data = as.data.frame(as.matrix(physeq_mOTU@sam_data))
sample.data$timepoint.new = as.factor(sample.data$timepoint.new)
sample.data$timepoint.new = factor(sample.data$timepoint.new, levels = c("Baseline", "Pre-FMT" , "Post-1", "Post-2", "Post-3", "Post-4", "Week8", "Week10", "Week14"))
sample.data$timepoint.new.num = as.numeric(sample.data$timepoint.new)
sample.data$clinical_outcome_wk14 = as.factor(sample.data$clinical_outcome_wk14)
sample.data$clinical_outcome_wk14 = factor(sample.data$clinical_outcome_wk14, levels = c("None", "Good"))
sample.data$sex = as.factor(sample.data$sex)
sample.data$age = as.numeric(sample.data$age)
sample.data$subject_id = as.factor(sample.data$subject_id)
sample.data$pretreatment = as.factor(sample.data$pretreatment)
sample.data$treated_with_donor = as.factor(sample.data$treated_with_donor)

# Abundance data
abund = as.data.frame(as.matrix(t(physeq_mOTU@otu_table)))

# Combine
df = data.frame(abund, sample.data)
```

# Bacteroidaceae

## Transform the data 

```{r Histogramm Bacteroidaceae, echo=TRUE}
hist( df$Bacteroidaceae )
df$Bacteroidaceae.new = asin( sqrt( df$Bacteroidaceae ))
hist( df$Bacteroidaceae.new )
```

```{r Proportion Bacteroidaceae, echo=TRUE}
sum( df$Bacteroidaceae.new == 0 ) / length( df$Bacteroidaceae.new ) # proportion of zeros
```

```{r Plot data Bacteroidaceae, echo=TRUE}
# None responders
df.none = subset( df, clinical_outcome_wk14 == "None" ) # changed filter to subset

# Good responders
df.good = subset( df, clinical_outcome_wk14 == "Good" )
```

## Plot Bacteroidaceae
 
```{r Plot Bacteroidaceae, echo=TRUE, fig.width = 9}
a = xyplot( Bacteroidaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.none, xlab = "Timepoint", ylab = "Relative abundance (transformed)", main="Bacteroidaceae", 
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#EC7063", lwd = 4 )
           },
           key = list( space = "right", 
                      lines = list( col = c( "#EC7063", "#85C1E9" ), lty = c( 1, 1 ), lwd = 2 ),  # "#85C1E9"
                      text = list( c( "Non-Responders", "Responders" ))))

b = xyplot( Bacteroidaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.good, xlab = "Timepoint",
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#85C1E9", lwd = 4, type = "l", lty = 1 )
           })

c = xyplot( Bacteroidaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.none, type = "p", col = "#EC7063" )

d = xyplot( Bacteroidaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.good, type = "p", col = "#85C1E9" )

Bacteroidaceae.plot = a + as.layer( b ) + as.layer( c ) + as.layer( d )
Bacteroidaceae.plot
```

## Choose between the lmer and glmmTMB models Bacteroidaceae

We have used time as a numeric value and added a spline at knots = 7.

```{r Mixed model Bacteroidaceae, echo=TRUE}
lme.int.Bacteroidaceae = lme4::lmer(Bacteroidaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)

#lme.int.Bacteroidaceae = lme4::lmer(Bacteroidaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), data = df)

glmm.int.Bacteroidaceae = glmmTMB(Bacteroidaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), 
               family = gaussian, 
               data = df, 
               zi= ~ 1) 

#glmm.slope.Bacteroidaceae = glmmTMB(Bacteroidaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), 
               #family = gaussian, 
               #data = df, 
               #zi= ~ 1) 

AICc(lme.int.Bacteroidaceae)
AICc(glmm.int.Bacteroidaceae) # lower
```

# Diagnostics Bacteroidaceae

```{r Diagnostics Bacteroidaceae, eval=FALSE}
lme.Bacteroidaceae.diag = DHARMa::simulateResiduals( lme.int.Bacteroidaceae )
plot( lme.Bacteroidaceae.diag )

plotResiduals( lme.Bacteroidaceae.diag, form = df$clinical_outcome_wk14 )
plotResiduals( lme.Bacteroidaceae.diag, form = df$timepoint.new )
plotResiduals( lme.Bacteroidaceae.diag, form = df$treated_with_donor )
plotResiduals( lme.Bacteroidaceae.diag, form = df$sex ) 
plotResiduals( lme.Bacteroidaceae.diag, form = df$age )
plotResiduals( lme.Bacteroidaceae.diag, form = df$pretreatment )

testZeroInflation( lme.Bacteroidaceae.diag )
testDispersion( lme.Bacteroidaceae.diag )

output1 = recalculateResiduals( lme.Bacteroidaceae.diag, group = df$timepoint.new )
testTemporalAutocorrelation( output1, time = unique( df$timepoint.new ))
```

LMM model was chosen due to slightly better diagnostics. 

```{r Results Bacteroidaceae}
plot_summs( lme.int.Bacteroidaceae )

wald.test( Sigma = vcov( lme.int.Bacteroidaceae ), b = fixef( lme.int.Bacteroidaceae ), Terms = 2 )$result # sex
wald.test( Sigma = vcov( lme.int.Bacteroidaceae ), b = fixef( lme.int.Bacteroidaceae ), Terms = 3 )$result # age
wald.test( Sigma = vcov( lme.int.Bacteroidaceae ), b = fixef( lme.int.Bacteroidaceae ), Terms = 4 )$result # pretreatment
wald.test( Sigma = vcov( lme.int.Bacteroidaceae ), b = fixef( lme.int.Bacteroidaceae ), Terms = 5 )$result # donor
wald.test( Sigma = vcov( lme.int.Bacteroidaceae ), b = fixef( lme.int.Bacteroidaceae ), Terms = c( 6, 9, 10 ))$result # clinical outcome wk14
```

Satistical Tests:
Use statistical tests such as the likelihood ratio test or information criteria (e.g., AIC, BIC) to compare model fit. A significant improvement in model fit when adding a variable may indicate its importance as a confounder.

Magnitude of Change:
Large changes in the magnitude of the coefficient of the independent variable when adding a potential confounder may indicate confounding. "Large" is subjective and can vary, but a common rule of thumb is a change of around 10% or more. Pay attention to the direction of the change. If the sign of the coefficient changes (e.g., from positive to negative or vice versa), it suggests a significant impact.

Variance Inflation Factor (VIF):
Assess collinearity using the VIF. A VIF greater than 5 or 10 is often considered an indicator of potential multicollinearity, which can affect the stability and reliability of coefficient estimates. In addition to VIF, you can also check condition indices. Values above 30 may suggest potential collinearity issues.


```{r confounders Bacteroidaceae, echo=TRUE}
library(lmtest)

full.model = lme4::lmer(Bacteroidaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)
summary(full.model )
AIC(full.model)

initial.model = lme4::lmer(Bacteroidaceae.new ~ clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)
summary(initial.model )
AIC(initial.model)

sex.model = lme4::lmer(Bacteroidaceae.new ~ sex + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)
summary(sex.model )

AIC(initial.model) - AIC(sex.model)
lr_test.sex <- lrtest(initial.model, sex.model) # not significant
lr_test.sex
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(sex.model)
coef_initial_sex <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_sex <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.sex  <- coef_full_sex - coef_initial_sex # 0.01124904
coefficient_change_percentage.sex = (coef_full_sex - coef_initial_sex) / coef_initial_sex * 100 # 22%
coefficient_change_percentage.sex
# Check collinearity
#vif_values.sex <- car::vif(sex.model)
#vif_values.sex

age.model = lme4::lmer(Bacteroidaceae.new ~  age + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)
summary(age.model )

AIC(initial.model) - AIC(age.model)
lr_test.age <- lrtest(initial.model, age.model)
lr_test.age
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(age.model)
coef_initial_age <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_age <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.age  <- coef_full_age - coef_initial_age # 0.01124904
coefficient_change_percentage.age = (coef_full_age - coef_initial_age) / coef_initial_age * 100 
coefficient_change_percentage.age
# Check collinearity
#vif_values.age <- car::vif(age.model)
#vif_values.age

pretreatment.model = lme4::lmer(Bacteroidaceae.new ~ pretreatment + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)
summary(pretreatment.model )

AIC(initial.model) - AIC(pretreatment.model)
lr_test.pretreatment <- lrtest(initial.model, pretreatment.model)
lr_test.pretreatment
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(pretreatment.model)
coef_initial_pretreatment <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_pretreatment <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.pretreatment  <- coef_full_pretreatment - coef_initial_pretreatment # 0.01124904
coefficient_change_percentpretreatment.pretreatment = (coef_full_pretreatment - coef_initial_pretreatment) / coef_initial_pretreatment * 100
coefficient_change_percentpretreatment.pretreatment
# Check collinearity
#vif_values.pretreatment <- car::vif(pretreatment.model)
#vif_values.pretreatment

donor.model = lme4::lmer(Bacteroidaceae.new ~ treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)
summary(donor.model )

AIC(initial.model) - AIC(donor.model)
lr_test.treated_with_donor <- lrtest(initial.model, donor.model)
lr_test.treated_with_donor
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(donor.model)
coef_initial_donor <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_donor <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.donor  <- coef_full_donor - coef_initial_donor # 0.01124904
coefficient_change_percentdonor.donor = (coef_full_donor - coef_initial_donor) / coef_initial_donor * 100
coefficient_change_percentdonor.donor
# Check collinearity
#vif_values.treated_with_donor  <- car::vif(donor.model)
#vif_values.treated_with_donor
```


```{r Final Results Bacteroidaceae}
lme.int.Bacteroidaceae = lme4::lmer(Bacteroidaceae.new ~ sex + age + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)
summary(lme.int.Bacteroidaceae )

plot_summs( lme.int.Bacteroidaceae )

wald.test( Sigma = vcov( lme.int.Bacteroidaceae ), b = fixef( lme.int.Bacteroidaceae ), Terms = 2 )$result # sex
wald.test( Sigma = vcov( lme.int.Bacteroidaceae ), b = fixef( lme.int.Bacteroidaceae ), Terms = 3 )$result # age
#wald.test( Sigma = vcov( lme.int.Bacteroidaceae ), b = fixef( lme.int.Bacteroidaceae ), Terms = 4 )$result # pretreatment
wald.test( Sigma = vcov( lme.int.Bacteroidaceae ), b = fixef( lme.int.Bacteroidaceae ), Terms = 4 )$result # donor
wald.test( Sigma = vcov( lme.int.Bacteroidaceae ), b = fixef( lme.int.Bacteroidaceae ), Terms = c( 5, 8, 9 ))$result # clinical outcome wk14
```

# Bacteroidalesfam.incertaesedis

```{r}
sum(df$Bacteroidalesfam.incertaesedis == 0) / length(df$Bacteroidalesfam.incertaesedis)
```

```{r}
xyplot(Bacteroidalesfam.incertaesedis ~ timepoint.new | clinical_outcome_wk14, data = df, xlab = "Bacteroidalesfam.incertaesedis", ylab = "Bifidobacteriaceae", ylim = c(0, 0.05),
           panel = function(x, y) {
            panel.average(x, y, horizontal = FALSE, col = "plum", lwd = 4)
       })

hist(df$Bacteroidalesfam.incertaesedis)

df$Bacteroidalesfam.incertaesedis.new = asin(sqrt(df$Bacteroidalesfam.incertaesedis))
hist(df$Bacteroidalesfam.incertaesedis.new)

xyplot(Bacteroidalesfam.incertaesedis.new ~ timepoint.new | clinical_outcome_wk14, data = df, xlab = "Bacteroidalesfam.incertaesedis", ylab = "Bifidobacteriaceae", ylim = c(0, 0.15),
           panel = function(x, y) {
            panel.average(x, y, horizontal = FALSE, col = "plum", lwd = 4)
       })
```

```{r}
lme.int.Bacteroidalesfam.incertaesedis = lmer(Bacteroidalesfam.incertaesedis.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)

#lme.slope.Bacteroidalesfam.incertaesedis = lmer(Bacteroidalesfam.incertaesedis.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), data = df)

glmm.int.Bacteroidalesfam.incertaesedis = glmmTMB(Bacteroidalesfam.incertaesedis.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), 
               family = gaussian, 
               data = df, 
               zi= ~ 1) # ~ clinical_outcome_wk14

#glmm.slope.Bacteroidalesfam.incertaesedis = glmmTMB(Bacteroidalesfam.incertaesedis.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), 
               #family = gaussian, 
               #data = df, 
               #zi= ~ clinical_outcome_wk14) 

AICc(lme.int.Bacteroidalesfam.incertaesedis)
AICc(glmm.int.Bacteroidalesfam.incertaesedis) # lower
```

```{r}
# diagnostics zigmm
glmm.Bacteroidalesfam.incertaesedis.diag = DHARMa::simulateResiduals(glmm.int.Bacteroidalesfam.incertaesedis)

plot(glmm.Bacteroidalesfam.incertaesedis.diag)

plotResiduals(glmm.Bacteroidalesfam.incertaesedis.diag, form = df$clinical_outcome_wk14)
plotResiduals(glmm.Bacteroidalesfam.incertaesedis.diag, form = df$timepoint.new)
plotResiduals(glmm.Bacteroidalesfam.incertaesedis.diag, form = df$treated_with_donor)
plotResiduals(glmm.Bacteroidalesfam.incertaesedis.diag, form = df$sex)
plotResiduals(glmm.Bacteroidalesfam.incertaesedis.diag, form = df$age)
plotResiduals(glmm.Bacteroidalesfam.incertaesedis.diag, form = df$pretreatment)

testZeroInflation(glmm.Bacteroidalesfam.incertaesedis.diag)
testDispersion(glmm.Bacteroidalesfam.incertaesedis.diag)
output1 = recalculateResiduals(glmm.Bacteroidalesfam.incertaesedis.diag, group=df$timepoint.new)
testTemporalAutocorrelation(output1, time = unique(df$timepoint.new))
```

```{r}
# diagnostics lme
lme.Bacteroidalesfam.incertaesedis.diag = DHARMa::simulateResiduals(lme.int.Bacteroidalesfam.incertaesedis)

plot(lme.Bacteroidalesfam.incertaesedis.diag)

plotResiduals(lme.Bacteroidalesfam.incertaesedis.diag, form = df$clinical_outcome_wk14)
plotResiduals(lme.Bacteroidalesfam.incertaesedis.diag, form = df$timepoint.new)
plotResiduals(lme.Bacteroidalesfam.incertaesedis.diag, form = df$treated_with_donor)
plotResiduals(lme.Bacteroidalesfam.incertaesedis.diag, form = df$sex)
plotResiduals(lme.Bacteroidalesfam.incertaesedis.diag, form = df$age)
plotResiduals(lme.Bacteroidalesfam.incertaesedis.diag, form = df$pretreatment)

testZeroInflation(lme.Bacteroidalesfam.incertaesedis.diag)
testDispersion(lme.Bacteroidalesfam.incertaesedis.diag)
output1 = recalculateResiduals(lme.Bacteroidalesfam.incertaesedis.diag, group=df$timepoint.new)
testTemporalAutocorrelation(output1, time = unique(df$timepoint.new))
```

```{r}
wald.test(Sigma = vcov(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], b = fixef(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], Terms = 2)$result # sex

wald.test(Sigma = vcov(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], b = fixef(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], Terms = 3)$result # age

wald.test(Sigma = vcov(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], b = fixef(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], Terms = 4)$result # pretreatment

wald.test(Sigma = vcov(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], b = fixef(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], Terms = 5)$result # donor

wald.test(Sigma = vcov(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], b = fixef(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], Terms = c(6, 9, 10))$result
```

```{r confounders Bacteroidalesfam.incertaesedis, echo=TRUE}
library(lmtest)

full.model = glmmTMB(Bacteroidalesfam.incertaesedis.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(full.model )
AIC(full.model)

initial.model = glmmTMB(Bacteroidalesfam.incertaesedis.new ~ clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(initial.model )
AIC(initial.model)

sex.model = glmmTMB(Bacteroidalesfam.incertaesedis.new ~ sex + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(sex.model )

AIC(initial.model) - AIC(sex.model)
lr_test.sex <- lrtest(initial.model, sex.model) # not significant
lr_test.sex
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(sex.model)
coef_initial_sex <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_sex <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.sex  <- coef_full_sex - coef_initial_sex # 0.01124904
coefficient_change_percentage.sex = (coef_full_sex - coef_initial_sex) / coef_initial_sex * 100 # 22%
coefficient_change_percentage.sex
# Check collinearity
#vif_values.sex <- car::vif(sex.model)
#vif_values.sex

age.model = glmmTMB(Bacteroidalesfam.incertaesedis.new ~ age + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(age.model )

AIC(initial.model) - AIC(age.model)
lr_test.age <- lrtest(initial.model, age.model)
lr_test.age
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(age.model)
coef_initial_age <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_age <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.age  <- coef_full_age - coef_initial_age # 0.01124904
coefficient_change_percentage.age = (coef_full_age - coef_initial_age) / coef_initial_age * 100 
coefficient_change_percentage.age
# Check collinearity
#vif_values.age <- car::vif(age.model)
#vif_values.age

pretreatment.model = glmmTMB(Bacteroidalesfam.incertaesedis.new ~ pretreatment + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(pretreatment.model )

AIC(initial.model) - AIC(pretreatment.model)
lr_test.pretreatment <- lrtest(initial.model, pretreatment.model)
lr_test.pretreatment
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(pretreatment.model)
coef_initial_pretreatment <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_pretreatment <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.pretreatment  <- coef_full_pretreatment - coef_initial_pretreatment # 0.01124904
coefficient_change_percentpretreatment.pretreatment = (coef_full_pretreatment - coef_initial_pretreatment) / coef_initial_pretreatment * 100
coefficient_change_percentpretreatment.pretreatment
# Check collinearity
#vif_values.pretreatment <- car::vif(pretreatment.model)
#vif_values.pretreatment

donor.model = glmmTMB(Bacteroidalesfam.incertaesedis.new ~ treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(donor.model )

AIC(initial.model) - AIC(donor.model)
lr_test.treated_with_donor <- lrtest(initial.model, donor.model)
lr_test.treated_with_donor
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(donor.model)
coef_initial_donor <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_donor <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.donor  <- coef_full_donor - coef_initial_donor # 0.01124904
coefficient_change_percentdonor.donor = (coef_full_donor - coef_initial_donor) / coef_initial_donor * 100
coefficient_change_percentdonor.donor
# Check collinearity
#vif_values.treated_with_donor  <- car::vif(donor.model)
#vif_values.treated_with_donor
```

```{r final results}
glmm.int.Bacteroidalesfam.incertaesedis = glmmTMB(Bacteroidalesfam.incertaesedis.new ~ sex + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(glmm.int.Bacteroidalesfam.incertaesedis )

wald.test(Sigma = vcov(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], b = fixef(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], Terms = 2)$result # sex

# wald.test(Sigma = vcov(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], b = fixef(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], Terms = 3)$result # age
# 
# wald.test(Sigma = vcov(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], b = fixef(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], Terms = 4)$result # pretreatment
# 
# wald.test(Sigma = vcov(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], b = fixef(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], Terms = 5)$result # donor

wald.test(Sigma = vcov(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], b = fixef(glmm.int.Bacteroidalesfam.incertaesedis)[["cond"]], Terms = c(3, 6, 7))$result
```

# Bifidobacteriaceae

```{r}
sum(df$Bifidobacteriaceae == 0) / length(df$Bifidobacteriaceae)
```

```{r}
xyplot(Bifidobacteriaceae ~ timepoint.new | clinical_outcome_wk14, data = df, xlab = "Timepoint", ylab = "Bifidobacteriaceae", ylim = c(0, 0.03),
           panel = function(x, y) {
            panel.average(x, y, horizontal = FALSE, col = "plum", lwd = 4)
       })

hist(df$Bifidobacteriaceae)

df$Bifidobacteriaceae.new = asin(sqrt(df$Bifidobacteriaceae))
hist(df$Bifidobacteriaceae.new)

xyplot(Bifidobacteriaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df, xlab = "Timepoint", ylab = "Bifidobacteriaceae", ylim = c(0, 0.15),
           panel = function(x, y) {
            panel.average(x, y, horizontal = FALSE, col = "plum", lwd = 4)
       })
```

```{r}
lme.int.Bifidobacteriaceae = lmer(Bifidobacteriaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)

#lme.slope.Bifidobacteriaceae = lmer(Bifidobacteriaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), data = df)

glmm.int.Bifidobacteriaceae = glmmTMB(Bifidobacteriaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), 
               family = gaussian, 
               data = df, 
               zi= ~ 1)

#glmm.slope.Bifidobacteriaceae = glmmTMB(Bifidobacteriaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), 
               #family = gaussian, 
               #data = df, 
               #zi= ~ 1) 

AICc(lme.int.Bifidobacteriaceae)
AICc(glmm.int.Bifidobacteriaceae) # lower
```

```{r}
# diagnostics zigmm
glmm.Bifidobacteriaceae.diag = DHARMa::simulateResiduals(glmm.int.Bifidobacteriaceae)

plot(glmm.Bifidobacteriaceae.diag)

plotResiduals(glmm.Bifidobacteriaceae.diag, form = df$clinical_outcome_wk14)
plotResiduals(glmm.Bifidobacteriaceae.diag, form = df$timepoint.new)
plotResiduals(glmm.Bifidobacteriaceae.diag, form = df$treated_with_donor)
plotResiduals(glmm.Bifidobacteriaceae.diag, form = df$sex)
plotResiduals(glmm.Bifidobacteriaceae.diag, form = df$age)
plotResiduals(glmm.Bifidobacteriaceae.diag, form = df$pretreatment)

testZeroInflation(glmm.Bifidobacteriaceae.diag)
testDispersion(glmm.Bifidobacteriaceae.diag)
output1 = recalculateResiduals(glmm.Bifidobacteriaceae.diag, group=df$timepoint.new)
testTemporalAutocorrelation(output1, time = unique(df$timepoint.new))
```

```{r}
# diagnostics lme
lme.Bifidobacteriaceae.diag = DHARMa::simulateResiduals(lme.int.Bifidobacteriaceae)

plot(lme.Bifidobacteriaceae.diag)

plotResiduals(lme.Bifidobacteriaceae.diag, form = df$clinical_outcome_wk14)
plotResiduals(lme.Bifidobacteriaceae.diag, form = df$timepoint.new)
plotResiduals(lme.Bifidobacteriaceae.diag, form = df$treated_with_donor)
plotResiduals(lme.Bifidobacteriaceae.diag, form = df$sex)
plotResiduals(lme.Bifidobacteriaceae.diag, form = df$age)
plotResiduals(lme.Bifidobacteriaceae.diag, form = df$pretreatment)

testZeroInflation(lme.Bifidobacteriaceae.diag)
testDispersion(lme.Bifidobacteriaceae.diag)
output1 = recalculateResiduals(lme.Bifidobacteriaceae.diag, group=df$timepoint.new)
testTemporalAutocorrelation(output1, time = unique(df$timepoint.new))
```

```{r}
wald.test(Sigma = vcov(glmm.int.Bifidobacteriaceae)[["cond"]], b = fixef(glmm.int.Bifidobacteriaceae)[["cond"]], Terms = 2)$result # sex

wald.test(Sigma = vcov(glmm.int.Bifidobacteriaceae)[["cond"]], b = fixef(glmm.int.Bifidobacteriaceae)[["cond"]], Terms = 3)$result # age

wald.test(Sigma = vcov(glmm.int.Bifidobacteriaceae)[["cond"]], b = fixef(glmm.int.Bifidobacteriaceae)[["cond"]], Terms = 4)$result # pretreatment

wald.test(Sigma = vcov(glmm.int.Bifidobacteriaceae)[["cond"]], b = fixef(glmm.int.Bifidobacteriaceae)[["cond"]], Terms = 5)$result # donor

wald.test(Sigma = vcov(glmm.int.Bifidobacteriaceae)[["cond"]], b = fixef(glmm.int.Bifidobacteriaceae)[["cond"]], Terms = c(6, 9, 10))$result

# test effect confounders

glmm.int.Bifidobacteriaceae = glmmTMB(Bifidobacteriaceae.new ~ sex + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), 
               family = gaussian, 
               data = df, 
               zi= ~ 1)
wald.test(Sigma = vcov(glmm.int.Bifidobacteriaceae)[["cond"]], b = fixef(glmm.int.Bifidobacteriaceae)[["cond"]], Terms = c(3, 6, 7))$result

```

```{r confounders Bifidobacteriaceae, echo=TRUE}
library(lmtest)

full.model = glmmTMB(Bifidobacteriaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(full.model )
AIC(full.model)

initial.model = glmmTMB(Bifidobacteriaceae.new ~  clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(initial.model )
AIC(initial.model)

sex.model = glmmTMB(Bifidobacteriaceae.new ~ sex  + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(sex.model )

AIC(initial.model) - AIC(sex.model)
lr_test.sex <- lrtest(initial.model, sex.model) # not significant
lr_test.sex
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(sex.model)
coef_initial_sex <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_sex <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.sex  <- coef_full_sex - coef_initial_sex # 0.01124904
coefficient_change_percentage.sex = (coef_full_sex - coef_initial_sex) / coef_initial_sex * 100 # 22%
coefficient_change_percentage.sex
# Check collinearity
##vif_values.sex <- car::vif(sex.model)
##vif_values.sex

age.model = glmmTMB(Bifidobacteriaceae.new ~ age + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(age.model )

AIC(initial.model) - AIC(age.model)
lr_test.age <- lrtest(initial.model, age.model)
lr_test.age
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(age.model)
coef_initial_age <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_age <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.age  <- coef_full_age - coef_initial_age # 0.01124904
coefficient_change_percentage.age = (coef_full_age - coef_initial_age) / coef_initial_age * 100 
coefficient_change_percentage.age
# Check collinearity
##vif_values.age <- car::vif(age.model)
##vif_values.age

pretreatment.model = glmmTMB(Bifidobacteriaceae.new ~ pretreatment + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(pretreatment.model )

AIC(initial.model) - AIC(pretreatment.model)
lr_test.pretreatment <- lrtest(initial.model, pretreatment.model)
lr_test.pretreatment
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(pretreatment.model)
coef_initial_pretreatment <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_pretreatment <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.pretreatment  <- coef_full_pretreatment - coef_initial_pretreatment # 0.01124904
coefficient_change_percentpretreatment.pretreatment = (coef_full_pretreatment - coef_initial_pretreatment) / coef_initial_pretreatment * 100
coefficient_change_percentpretreatment.pretreatment
# Check collinearity
##vif_values.pretreatment <- car::vif(pretreatment.model)
##vif_values.pretreatment

donor.model = glmmTMB(Bifidobacteriaceae.new ~ treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(donor.model )

AIC(initial.model) - AIC(donor.model)
lr_test.treated_with_donor <- lrtest(initial.model, donor.model)
lr_test.treated_with_donor
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(donor.model)
coef_initial_donor <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_donor <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.donor  <- coef_full_donor - coef_initial_donor # 0.01124904
coefficient_change_percentdonor.donor = (coef_full_donor - coef_initial_donor) / coef_initial_donor * 100
coefficient_change_percentdonor.donor
# Check collinearity
##vif_values.treated_with_donor  <- car::vif(donor.model)
##vif_values.treated_with_donor
```

```{r}
glmm.int.Bifidobacteriaceae = glmmTMB(Bifidobacteriaceae.new ~ sex + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(glmm.int.Bifidobacteriaceae )

wald.test(Sigma = vcov(glmm.int.Bifidobacteriaceae)[["cond"]], b = fixef(glmm.int.Bifidobacteriaceae)[["cond"]], Terms = 2)$result # sex

#wald.test(Sigma = vcov(glmm.int.Bifidobacteriaceae)[["cond"]], b = fixef(glmm.int.Bifidobacteriaceae)[["cond"]], Terms = 3)$result # age

#wald.test(Sigma = vcov(glmm.int.Bifidobacteriaceae)[["cond"]], b = fixef(glmm.int.Bifidobacteriaceae)[["cond"]], Terms = 4)$result # pretreatment

wald.test(Sigma = vcov(glmm.int.Bifidobacteriaceae)[["cond"]], b = fixef(glmm.int.Bifidobacteriaceae)[["cond"]], Terms = 3)$result # donor

wald.test(Sigma = vcov(glmm.int.Bifidobacteriaceae)[["cond"]], b = fixef(glmm.int.Bifidobacteriaceae)[["cond"]], Terms = c(4, 7, 8))$result
```

# Clostridiaceae

## Transform the data 

```{r Histogramm Clostridiaceae, echo=TRUE}
hist( df$Clostridiaceae )
df$Clostridiaceae.new = asin( sqrt( df$Clostridiaceae ))
hist( df$Clostridiaceae.new )
```

```{r Proportion Clostridiaceae, echo=TRUE}
sum( df$Clostridiaceae.new == 0 ) / length( df$Clostridiaceae.new ) # proportion of zeros
```

```{r Plot data Clostridiaceae, echo=TRUE}
# None responders
df.none = subset( df, clinical_outcome_wk14 == "None" ) # changed filter to subset

# Good responders
df.good = subset( df, clinical_outcome_wk14 == "Good" )
```

## Plot Clostridiaceae
 
```{r Plot Clostridiaceae, echo=TRUE, fig.width = 9}
a = xyplot( Clostridiaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.none, xlab = "Timepoint", ylab = "Relative abundance (transformed)", main="Clostridiaceae", 
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#EC7063", lwd = 4 )
           },
           key = list( space = "right", 
                      lines = list( col = c( "#EC7063", "#85C1E9" ), lty = c( 1, 1 ), lwd = 2 ), 
                      text = list( c( "Non-Responders", "Responders" ))))

b = xyplot( Clostridiaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.good, xlab = "Timepoint",
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#85C1E9", lwd = 4, type = "l", lty = 1 )
           })

c = xyplot( Clostridiaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.none, type = "p", col = "#EC7063" )

d = xyplot( Clostridiaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.good, type = "p", col = "#85C1E9" )

Clostridiaceae.plot = a + as.layer( b ) + as.layer( c ) + as.layer( d )
Clostridiaceae.plot
```

## Choose between the lmer and glmmTMB models Clostridiaceae

We have used time as a numeric value and added a spline at knots = 7.

```{r Mixed model Clostridiaceae, echo=TRUE}
lme.int.Clostridiaceae = lme( Clostridiaceae.new~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ), 
               data = df, 
               random = ~ 1 | subject_id )

# lme.slope.Clostridiaceae = lme( Clostridiaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7), 
              # data = df, 
              # random = ~ ns( timepoint.new.num, knots = 7 ) | subject_id )

glmm.int.Clostridiaceae = glmmTMB( Clostridiaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), 
               family = gaussian, 
               data = df, 
               zi= ~ 1 )

# glmm.slope.Clostridiaceae = glmmTMB( Clostridiaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns(timepoint.new.num, knots = 7 ) | subject_id ), 
               # family = gaussian, 
               # data = df, 
               # zi= ~ 1 )

AICc( lme.int.Clostridiaceae )
AICc( glmm.int.Clostridiaceae ) # lower
```

# Diagnostics Clostridiaceae

```{r Diagnostics Clostridiaceae, eval=FALSE}
glmm.Clostridiaceae.diag = DHARMa::simulateResiduals( glmm.int.Clostridiaceae )
plot( glmm.Clostridiaceae.diag )

plotResiduals( glmm.Clostridiaceae.diag, form = df$clinical_outcome_wk14 )
plotResiduals( glmm.Clostridiaceae.diag, form = df$timepoint.new )
plotResiduals( glmm.Clostridiaceae.diag, form = df$treated_with_donor )
plotResiduals( glmm.Clostridiaceae.diag, form = df$sex ) 
plotResiduals( glmm.Clostridiaceae.diag, form = df$age )
plotResiduals( glmm.Clostridiaceae.diag, form = df$pretreatment )

testZeroInflation( glmm.Clostridiaceae.diag )
testDispersion( glmm.Clostridiaceae.diag )

output1 = recalculateResiduals( glmm.Clostridiaceae.diag, group = df$timepoint.new )
testTemporalAutocorrelation( output1, time = unique( df$timepoint.new ))
```

ZIGMM model had a lower AICc and similar diagnostics to the LMM. 

```{r Results Clostridiaceae, fig.width = 9}
conf.int = data.frame( confint( glmm.int.Clostridiaceae ))
colnames( conf.int )[ 1 ] = "conf.low"
colnames( conf.int )[ 2 ] = "conf.high"
conf.int = conf.int[ -c( 11:21 ), ]

clostridfam = broom.mixed::tidy( glmm.int.Clostridiaceae )[ , -c( 1 )]
clostridfam = clostridfam[ -c( 11:23 ), ]
clostridfam = clostridfam[ , -c( 1 )]
effect = "fixed"

clostridfam = data.frame( model = "Clostridiales incertaesedis", effect = effect, clostridfam, conf.low = conf.int$conf.low, conf.high = conf.int$conf.high )
clostridfam = clostridfam[ , -c( 8 )]
clostridfam = as_tibble( clostridfam )

dwplot( clostridfam ) + xlab( "Coefficient Estimate" ) + geom_vline( xintercept = 0, colour = "grey60", linetype = 2 ) + theme_bw() + theme( legend.title = element_blank())
```
```{r}
wald.test(Sigma = vcov(glmm.int.Clostridiaceae)[["cond"]], b = fixef(glmm.int.Clostridiaceae)[["cond"]], Terms = 2)$result # sex

wald.test(Sigma = vcov(glmm.int.Clostridiaceae)[["cond"]], b = fixef(glmm.int.Clostridiaceae)[["cond"]], Terms = 3)$result # age

wald.test(Sigma = vcov(glmm.int.Clostridiaceae)[["cond"]], b = fixef(glmm.int.Clostridiaceae)[["cond"]], Terms = 4)$result # pretreatment

wald.test(Sigma = vcov(glmm.int.Clostridiaceae)[["cond"]], b = fixef(glmm.int.Clostridiaceae)[["cond"]], Terms = 5)$result # donor

wald.test(Sigma = vcov(glmm.int.Clostridiaceae)[["cond"]], b = fixef(glmm.int.Clostridiaceae)[["cond"]], Terms = c(6, 9, 10))$result
```

```{r confounders Clostridiaceae, echo=TRUE}
library(lmtest)

full.model = glmmTMB( Clostridiaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), family = gaussian, data = df, zi= ~ 1 )
summary(full.model )
AIC(full.model)

initial.model = glmmTMB( Clostridiaceae.new ~  clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), family = gaussian, data = df, zi= ~ 1 )
summary(initial.model )
AIC(initial.model)

sex.model = glmmTMB( Clostridiaceae.new ~ sex + clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), family = gaussian, data = df, zi= ~ 1 )
summary(sex.model )

AIC(initial.model) - AIC(sex.model)
lr_test.sex <- lrtest(initial.model, sex.model) # not significant
lr_test.sex
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(sex.model)
coef_initial_sex <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_sex <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.sex  <- coef_full_sex - coef_initial_sex # 0.01124904
coefficient_change_percentage.sex = (coef_full_sex - coef_initial_sex) / coef_initial_sex * 100 # 22%
coefficient_change_percentage.sex
# Check collinearity
##vif_values.sex <- car::vif(sex.model)
##vif_values.sex

age.model = glmmTMB( Clostridiaceae.new ~ age + clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), family = gaussian, data = df, zi= ~ 1 )
summary(age.model )

AIC(initial.model) - AIC(age.model)
lr_test.age <- lrtest(initial.model, age.model)
lr_test.age
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(age.model)
coef_initial_age <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_age <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.age  <- coef_full_age - coef_initial_age # 0.01124904
coefficient_change_percentage.age = (coef_full_age - coef_initial_age) / coef_initial_age * 100 
coefficient_change_percentage.age
# Check collinearity
##vif_values.age <- car::vif(age.model)
##vif_values.age

pretreatment.model = glmmTMB( Clostridiaceae.new ~ pretreatment + clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), family = gaussian, data = df, zi= ~ 1 )
summary(pretreatment.model )

AIC(initial.model) - AIC(pretreatment.model)
lr_test.pretreatment <- lrtest(initial.model, pretreatment.model)
lr_test.pretreatment
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(pretreatment.model)
coef_initial_pretreatment <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_pretreatment <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.pretreatment  <- coef_full_pretreatment - coef_initial_pretreatment # 0.01124904
coefficient_change_percentpretreatment.pretreatment = (coef_full_pretreatment - coef_initial_pretreatment) / coef_initial_pretreatment * 100
coefficient_change_percentpretreatment.pretreatment
# Check collinearity
#vif_values.pretreatment <- car::vif(pretreatment.model)
#vif_values.pretreatment

donor.model = glmmTMB( Clostridiaceae.new ~ treated_with_donor + clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), family = gaussian, data = df, zi= ~ 1 )
summary(donor.model )

AIC(initial.model) - AIC(donor.model)
lr_test.treated_with_donor <- lrtest(initial.model, donor.model)
lr_test.treated_with_donor
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(donor.model)
coef_initial_donor <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_donor <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.donor  <- coef_full_donor - coef_initial_donor # 0.01124904
coefficient_change_percentdonor.donor = (coef_full_donor - coef_initial_donor) / coef_initial_donor * 100
coefficient_change_percentdonor.donor
# Check collinearity
#vif_values.treated_with_donor  <- car::vif(donor.model)
#vif_values.treated_with_donor
```

```{r}
glmm.int.Clostridiaceae = glmmTMB( Clostridiaceae.new ~ sex + age + clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), family = gaussian, data = df, zi= ~ 1 )
summary(glmm.int.Clostridiaceae )

wald.test(Sigma = vcov(glmm.int.Clostridiaceae)[["cond"]], b = fixef(glmm.int.Clostridiaceae)[["cond"]], Terms = 2)$result # sex

wald.test(Sigma = vcov(glmm.int.Clostridiaceae)[["cond"]], b = fixef(glmm.int.Clostridiaceae)[["cond"]], Terms = 3)$result # age

#wald.test(Sigma = vcov(glmm.int.Clostridiaceae)[["cond"]], b = fixef(glmm.int.Clostridiaceae)[["cond"]], Terms = 4)$result # pretreatment

#wald.test(Sigma = vcov(glmm.int.Clostridiaceae)[["cond"]], b = fixef(glmm.int.Clostridiaceae)[["cond"]], Terms = 5)$result # donor

wald.test(Sigma = vcov(glmm.int.Clostridiaceae)[["cond"]], b = fixef(glmm.int.Clostridiaceae)[["cond"]], Terms = c(4, 7, 8))$result
```

# Clostridialesfam.incertaesedis

## Transform the data 

```{r Histogramm Clostridialesfam.incertaesedis, echo=TRUE}
hist( df$Clostridialesfam.incertaesedis )
df$Clostridialesfam.incertaesedis.new = asin( sqrt( df$Clostridialesfam.incertaesedis ))
hist( df$Clostridialesfam.incertaesedis.new )
```

```{r Proportion Clostridialesfam.incertaesedis, echo=TRUE}
sum( df$Clostridialesfam.incertaesedis.new == 0 ) / length( df$Clostridialesfam.incertaesedis.new ) # proportion of zeros
```

```{r Plot data Clostridialesfam.incertaesedis, echo=TRUE}
# None responders
df.none = subset( df, clinical_outcome_wk14 == "None" ) # changed filter to subset

# Good responders
df.good = subset( df, clinical_outcome_wk14 == "Good" )
```

## Plot Clostridialesfam.incertaesedis
 
```{r Plot Clostridialesfam.incertaesedis, echo=TRUE, fig.width = 9}
a = xyplot( Clostridialesfam.incertaesedis.new ~ timepoint.new | clinical_outcome_wk14, data = df.none, xlab = "Timepoint", ylab = "Relative abundance (transformed)", main="Clostridialesfam.incertaesedis", 
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#EC7063", lwd = 4 )
           },
           key = list( space = "right", 
                      lines = list( col = c( "#EC7063", "#85C1E9" ), lty = c( 1, 1 ), lwd = 2 ), 
                      text = list( c( "Non-Responders", "Responders" ))))

b = xyplot( Clostridialesfam.incertaesedis.new ~ timepoint.new | clinical_outcome_wk14, data = df.good, xlab = "Timepoint",
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#85C1E9", lwd = 4, type = "l", lty = 1 )
           })

c = xyplot( Clostridialesfam.incertaesedis.new ~ timepoint.new | clinical_outcome_wk14, data = df.none, type = "p", col = "#EC7063" )

d = xyplot( Clostridialesfam.incertaesedis.new ~ timepoint.new | clinical_outcome_wk14, data = df.good, type = "p", col = "#85C1E9" )

Clostridialesfam.incertaesedis.plot = a + as.layer( b ) + as.layer( c ) + as.layer( d )
Clostridialesfam.incertaesedis.plot
```

## Choose between the lmer and glmmTMB models Clostridialesfam.incertaesedis

We have used time as a numeric value and added a spline at knots = 7.

```{r Mixed model Clostridialesfam.incertaesedis, echo=TRUE}
lme.int.Clostridialesfam.incertaesedis = lme( Clostridialesfam.incertaesedis.new~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ), 
               data = df, 
               random = ~ 1 | subject_id )

# lme.slope.Clostridialesfam.incertaesedis = lme( Clostridialesfam.incertaesedis.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ), 
#                data = df, 
#                random = ~ ns( timepoint.new.num, knots = 7 ) | subject_id )

# glmm.int.Clostridialesfam.incertaesedis = glmmTMB( Clostridialesfam.incertaesedis.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), 
#                family = gaussian, 
#                data = df, 
#                zi = ~ clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ),
#                REML = TRUE )

glmm.slope.Clostridialesfam.incertaesedis = glmmTMB( Clostridialesfam.incertaesedis.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), 
               family = gaussian, 
               data = df, 
               zi = ~ clinical_outcome_wk14 + ns(timepoint.new.num, knots = 7 ) + ( 1 | subject_id ),
               REML = TRUE )

AICc( lme.int.Clostridialesfam.incertaesedis ) 
AICc( glmm.slope.Clostridialesfam.incertaesedis ) # lower
```

# Diagnostics Clostridialesfam.incertaesedis

```{r Diagnostics Clostridialesfam.incertaesedis, eval=FALSE}
glmm.Clostridialesfam.incertaesedis.diag = DHARMa::simulateResiduals( glmm.slope.Clostridialesfam.incertaesedis )
plot( glmm.Clostridialesfam.incertaesedis.diag )

plotResiduals( glmm.Clostridialesfam.incertaesedis.diag, form = df$clinical_outcome_wk14 )
plotResiduals( glmm.Clostridialesfam.incertaesedis.diag, form = df$timepoint.new )
plotResiduals( glmm.Clostridialesfam.incertaesedis.diag, form = df$treated_with_donor )
plotResiduals( glmm.Clostridialesfam.incertaesedis.diag, form = df$sex ) 
plotResiduals( glmm.Clostridialesfam.incertaesedis.diag, form = df$age )
plotResiduals( glmm.Clostridialesfam.incertaesedis.diag, form = df$pretreatment )

testZeroInflation( glmm.Clostridialesfam.incertaesedis.diag )
testDispersion( glmm.Clostridialesfam.incertaesedis.diag )

output1 = recalculateResiduals( glmm.Clostridialesfam.incertaesedis.diag, group = df$timepoint.new )
testTemporalAutocorrelation( output1, time = unique( df$timepoint.new ))
```
As the ZIGMM showed better diagnostics, it was selected as the better model. AICc values were very similar between LMM and ZIGMM models. 

```{r Results Clostridialesfam.incertaesedis 3, fig.width = 9}
conf.int = data.frame( confint( glmm.slope.Clostridialesfam.incertaesedis ))
colnames( conf.int )[ 1 ] = "conf.low"
colnames( conf.int )[ 2 ] = "conf.high"
conf.int = conf.int[ -c( 11:21 ), ]

clostridfam = broom.mixed::tidy( glmm.slope.Clostridialesfam.incertaesedis )[ , -c( 1 )]
clostridfam = clostridfam[ -c( 11:23 ), ]
clostridfam = clostridfam[ , -c( 1 )]
effect = "fixed"

clostridfam = data.frame( model = "Clostridiales incertaesedis", effect = effect, clostridfam, conf.low = conf.int$conf.low, conf.high = conf.int$conf.high )
clostridfam = clostridfam[ , -c( 8 )]
clostridfam = as_tibble( clostridfam )

dwplot( clostridfam ) + xlab( "Coefficient Estimate" ) + geom_vline( xintercept = 0, colour = "grey60", linetype = 2 ) + theme_bw() + theme( legend.title = element_blank())

wald.test( Sigma = vcov( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], b = fixef( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], Terms = 2 )$result # sex

wald.test( Sigma = vcov( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], b = fixef( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], Terms = 3 )$result # age

wald.test( Sigma = vcov( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], b = fixef( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], Terms = 4 )$result # pretreatment

wald.test( Sigma = vcov( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], b = fixef( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], Terms = 5 )$result # donor

wald.test( Sigma = vcov( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], b = fixef( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], Terms = c( 6, 9, 10 ))$result
```
```{r confounders Clostridialesfam.incertaesedis, echo=TRUE}
library(lmtest)

full.model = glmmTMB( Clostridialesfam.incertaesedis.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), family = gaussian, data = df, zi = ~ clinical_outcome_wk14 + ns(timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), REML = TRUE )
summary(full.model )
AIC(full.model)

initial.model = glmmTMB( Clostridialesfam.incertaesedis.new ~ clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), family = gaussian, data = df, zi = ~ clinical_outcome_wk14 + ns(timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), REML = TRUE )
summary(initial.model )
AIC(initial.model)

sex.model = glmmTMB( Clostridialesfam.incertaesedis.new ~ sex + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), family = gaussian, data = df, zi = ~ clinical_outcome_wk14 + ns(timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), REML = TRUE )
summary(sex.model )

AIC(initial.model) - AIC(sex.model)
lr_test.sex <- lrtest(initial.model, sex.model) # not significant
lr_test.sex
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(sex.model)
coef_initial_sex <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_sex <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.sex  <- coef_full_sex - coef_initial_sex # 0.01124904
coefficient_change_percentage.sex = (coef_full_sex - coef_initial_sex) / coef_initial_sex * 100 # 22%
coefficient_change_percentage.sex
# Check collinearity
#vif_values.sex <- car::vif(sex.model)
#vif_values.sex

age.model = glmmTMB( Clostridialesfam.incertaesedis.new ~ age + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), family = gaussian, data = df, zi = ~ clinical_outcome_wk14 + ns(timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), REML = TRUE )
summary(age.model )

AIC(initial.model) - AIC(age.model)
lr_test.age <- lrtest(initial.model, age.model)
lr_test.age
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(age.model)
coef_initial_age <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_age <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.age  <- coef_full_age - coef_initial_age # 0.01124904
coefficient_change_percentage.age = (coef_full_age - coef_initial_age) / coef_initial_age * 100 
coefficient_change_percentage.age
# Check collinearity
#vif_values.age <- car::vif(age.model)
#vif_values.age

pretreatment.model = glmmTMB( Clostridialesfam.incertaesedis.new ~ pretreatment + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), family = gaussian, data = df, zi = ~ clinical_outcome_wk14 + ns(timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), REML = TRUE )
summary(pretreatment.model )

AIC(initial.model) - AIC(pretreatment.model)
lr_test.pretreatment <- lrtest(initial.model, pretreatment.model)
lr_test.pretreatment
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(pretreatment.model)
coef_initial_pretreatment <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_pretreatment <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.pretreatment  <- coef_full_pretreatment - coef_initial_pretreatment # 0.01124904
coefficient_change_percentpretreatment.pretreatment = (coef_full_pretreatment - coef_initial_pretreatment) / coef_initial_pretreatment * 100
coefficient_change_percentpretreatment.pretreatment
# Check collinearity
#vif_values.pretreatment <- car::vif(pretreatment.model)
#vif_values.pretreatment

donor.model = glmmTMB( Clostridialesfam.incertaesedis.new ~ treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), family = gaussian, data = df, zi = ~ clinical_outcome_wk14 + ns(timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), REML = TRUE )
summary(donor.model )

AIC(initial.model) - AIC(donor.model)
lr_test.treated_with_donor <- lrtest(initial.model, donor.model)
lr_test.treated_with_donor
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(donor.model)
coef_initial_donor <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_donor <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.donor  <- coef_full_donor - coef_initial_donor # 0.01124904
coefficient_change_percentdonor.donor = (coef_full_donor - coef_initial_donor) / coef_initial_donor * 100
coefficient_change_percentdonor.donor
# Check collinearity
#vif_values.treated_with_donor  <- car::vif(donor.model)
#vif_values.treated_with_donor
```

```{r Results Clostridialesfam.incertaesedis 2, fig.width = 9}
glmm.slope.Clostridialesfam.incertaesedis = glmmTMB( Clostridialesfam.incertaesedis.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), family = gaussian, data = df, zi = ~ clinical_outcome_wk14 + ns(timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), REML = TRUE )
summary(full.model )

wald.test( Sigma = vcov( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], b = fixef( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], Terms = 2 )$result # sex

wald.test( Sigma = vcov( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], b = fixef( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], Terms = 3 )$result # age

wald.test( Sigma = vcov( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], b = fixef( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], Terms = 4 )$result # pretreatment

wald.test( Sigma = vcov( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], b = fixef( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], Terms = 5 )$result # donor

wald.test( Sigma = vcov( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], b = fixef( glmm.slope.Clostridialesfam.incertaesedis )[[ "cond" ]], Terms = c( 6, 9, 10 ))$result
```

# Coriobacteriaceae

```{r}
sum(df$Coriobacteriaceae == 0) / length(df$Coriobacteriaceae) 
```

```{r}
xyplot(Coriobacteriaceae ~ timepoint.new | clinical_outcome_wk14, data = df, xlab = "Timepoint", ylab = "Coriobacteriaceae", ylim = c(0, 0.04),
           panel = function(x, y) {
            panel.average(x, y, horizontal = FALSE, col = "plum", lwd = 4)
       })

hist(df$Coriobacteriaceae)

df$Coriobacteriaceae.new = asin(sqrt(df$Coriobacteriaceae))
hist(df$Coriobacteriaceae.new)

xyplot(Coriobacteriaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df, xlab = "Timepoint", ylab = "Coriobacteriaceae", ylim = c(0, 0.2),
           panel = function(x, y) {
            panel.average(x, y, horizontal = FALSE, col = "plum", lwd = 4)
       })
```

```{r}
lme.int.Coriobacteriaceae = lmer(Coriobacteriaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)

#lme.slope.Coriobacteriaceae = lmer(Coriobacteriaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), data = df)

glmm.int.Coriobacteriaceae = glmmTMB(Coriobacteriaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), 
               family = gaussian, 
               data = df, 
               zi= ~ 1)

#glmm.slope.Coriobacteriaceae = glmmTMB(Coriobacteriaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), 
               #family = gaussian, 
               #data = df, 
               #zi= ~ 1) 

AICc(lme.int.Coriobacteriaceae)
AICc(glmm.int.Coriobacteriaceae) # lower
```

```{r}
# diagnostics zigmm
glmm.Coriobacteriaceae.diag = DHARMa::simulateResiduals(glmm.int.Coriobacteriaceae)

plot(glmm.Coriobacteriaceae.diag)

plotResiduals(glmm.Coriobacteriaceae.diag, form = df$clinical_outcome_wk14)
plotResiduals(glmm.Coriobacteriaceae.diag, form = df$timepoint.new)
plotResiduals(glmm.Coriobacteriaceae.diag, form = df$treated_with_donor)
plotResiduals(glmm.Coriobacteriaceae.diag, form = df$sex)
plotResiduals(glmm.Coriobacteriaceae.diag, form = df$age)
plotResiduals(glmm.Coriobacteriaceae.diag, form = df$pretreatment)

testZeroInflation(glmm.Coriobacteriaceae.diag)
testDispersion(glmm.Coriobacteriaceae.diag)
output1 = recalculateResiduals(glmm.Coriobacteriaceae.diag, group=df$timepoint.new)
testTemporalAutocorrelation(output1, time = unique(df$timepoint.new))
```

```{r}
# diagnostics lme
lme.Coriobacteriaceae.diag = DHARMa::simulateResiduals(lme.int.Coriobacteriaceae)

plot(lme.Coriobacteriaceae.diag)

plotResiduals(lme.Coriobacteriaceae.diag, form = df$clinical_outcome_wk14)
plotResiduals(lme.Coriobacteriaceae.diag, form = df$timepoint.new)
plotResiduals(lme.Coriobacteriaceae.diag, form = df$treated_with_donor)
plotResiduals(lme.Coriobacteriaceae.diag, form = df$sex)
plotResiduals(lme.Coriobacteriaceae.diag, form = df$age)
plotResiduals(lme.Coriobacteriaceae.diag, form = df$pretreatment)

testZeroInflation(lme.Coriobacteriaceae.diag)
testDispersion(lme.Coriobacteriaceae.diag)
output1 = recalculateResiduals(lme.Coriobacteriaceae.diag, group=df$timepoint.new)
testTemporalAutocorrelation(output1, time = unique(df$timepoint.new))
```

```{r}
wald.test(Sigma = vcov(glmm.int.Coriobacteriaceae)[["cond"]], b = fixef(glmm.int.Coriobacteriaceae)[["cond"]], Terms = 2)$result # sex

wald.test(Sigma = vcov(glmm.int.Coriobacteriaceae)[["cond"]], b = fixef(glmm.int.Coriobacteriaceae)[["cond"]], Terms = 3)$result # age

wald.test(Sigma = vcov(glmm.int.Coriobacteriaceae)[["cond"]], b = fixef(glmm.int.Coriobacteriaceae)[["cond"]], Terms = 4)$result # pretreatment

wald.test(Sigma = vcov(glmm.int.Coriobacteriaceae)[["cond"]], b = fixef(glmm.int.Coriobacteriaceae)[["cond"]], Terms = 5)$result # donor

wald.test(Sigma = vcov(glmm.int.Coriobacteriaceae)[["cond"]], b = fixef(glmm.int.Coriobacteriaceae)[["cond"]], Terms = c(6, 9, 10))$result
```
```{r confounders Coriobacteriaceae, echo=TRUE}
library(lmtest)

full.model =  glmmTMB(Coriobacteriaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df,  zi= ~ 1)
summary(full.model )
AIC(full.model)

initial.model = glmmTMB(Coriobacteriaceae.new ~  clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df,  zi= ~ 1)
summary(initial.model )
AIC(initial.model)

sex.model = glmmTMB(Coriobacteriaceae.new ~ sex  + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df,  zi= ~ 1)
summary(sex.model )

AIC(initial.model) - AIC(sex.model)
lr_test.sex <- lrtest(initial.model, sex.model) # not significant
lr_test.sex
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(sex.model)
coef_initial_sex <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_sex <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.sex  <- coef_full_sex - coef_initial_sex # 0.01124904
coefficient_change_percentage.sex = (coef_full_sex - coef_initial_sex) / coef_initial_sex * 100 # 22%
coefficient_change_percentage.sex
# Check collinearity
#vif_values.sex <- car::vif(sex.model)
#vif_values.sex

age.model = glmmTMB(Coriobacteriaceae.new ~ age + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df,  zi= ~ 1)
summary(age.model )

AIC(initial.model) - AIC(age.model)
lr_test.age <- lrtest(initial.model, age.model)
lr_test.age
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(age.model)
coef_initial_age <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_age <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.age  <- coef_full_age - coef_initial_age # 0.01124904
coefficient_change_percentage.age = (coef_full_age - coef_initial_age) / coef_initial_age * 100 
coefficient_change_percentage.age
# Check collinearity
#vif_values.age <- car::vif(age.model)
#vif_values.age

pretreatment.model = glmmTMB(Coriobacteriaceae.new ~ pretreatment + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df,  zi= ~ 1)
summary(pretreatment.model )

AIC(initial.model) - AIC(pretreatment.model)
lr_test.pretreatment <- lrtest(initial.model, pretreatment.model)
lr_test.pretreatment
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(pretreatment.model)
coef_initial_pretreatment <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_pretreatment <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.pretreatment  <- coef_full_pretreatment - coef_initial_pretreatment # 0.01124904
coefficient_change_percentpretreatment.pretreatment = (coef_full_pretreatment - coef_initial_pretreatment) / coef_initial_pretreatment * 100
coefficient_change_percentpretreatment.pretreatment
# Check collinearity
#vif_values.pretreatment <- car::vif(pretreatment.model)
#vif_values.pretreatment

donor.model = glmmTMB(Coriobacteriaceae.new ~  treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df,  zi= ~ 1)
summary(donor.model )

AIC(initial.model) - AIC(donor.model)
lr_test.treated_with_donor <- lrtest(initial.model, donor.model)
lr_test.treated_with_donor
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(donor.model)
coef_initial_donor <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_donor <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.donor  <- coef_full_donor - coef_initial_donor # 0.01124904
coefficient_change_percentdonor.donor = (coef_full_donor - coef_initial_donor) / coef_initial_donor * 100
coefficient_change_percentdonor.donor
# Check collinearity
#vif_values.treated_with_donor  <- car::vif(donor.model)
#vif_values.treated_with_donor
```

```{r finals}
glmm.int.Coriobacteriaceae =  glmmTMB(Coriobacteriaceae.new ~ sex + age + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df,  zi= ~ 1)
summary(glmm.int.Coriobacteriaceae )

wald.test(Sigma = vcov(glmm.int.Coriobacteriaceae)[["cond"]], b = fixef(glmm.int.Coriobacteriaceae)[["cond"]], Terms = 2)$result # sex

wald.test(Sigma = vcov(glmm.int.Coriobacteriaceae)[["cond"]], b = fixef(glmm.int.Coriobacteriaceae)[["cond"]], Terms = 3)$result # age

#wald.test(Sigma = vcov(glmm.int.Coriobacteriaceae)[["cond"]], b = fixef(glmm.int.Coriobacteriaceae)[["cond"]], Terms = 4)$result # pretreatment

wald.test(Sigma = vcov(glmm.int.Coriobacteriaceae)[["cond"]], b = fixef(glmm.int.Coriobacteriaceae)[["cond"]], Terms = 4)$result # donor

wald.test(Sigma = vcov(glmm.int.Coriobacteriaceae)[["cond"]], b = fixef(glmm.int.Coriobacteriaceae)[["cond"]], Terms = c(5, 8, 9))$result
```

# Eubacteriaceae 

```{r}
sum(df$Eubacteriaceae == 0) / length(df$Eubacteriaceae)
```

```{r}
xyplot(Eubacteriaceae ~ timepoint.new | clinical_outcome_wk14, data = df, xlab = "Timepoint", ylab = "Eubacteriaceae",
           panel = function(x, y) {
            panel.average(x, y, horizontal = FALSE, col = "plum", lwd = 4)
       })

hist(df$Eubacteriaceae)
df$Eubacteriaceae.new = asin(sqrt(df$Eubacteriaceae))
hist(df$Eubacteriaceae.new)

xyplot(Eubacteriaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df, xlab = "Timepoint", ylab = "Eubacteriaceae",
           panel = function(x, y) {
            panel.average(x, y, horizontal = FALSE, col = "plum", lwd = 4)
       })
```

```{r}
library(nlme)

lme.int.Eubacteriaceae = lme(Eubacteriaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7), 
               data = df, 
               random = ~ 1 | subject_id)

lme.slope.Eubacteriaceae = lme(Eubacteriaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7), 
               data = df, 
               random = ~ ns(timepoint.new.num, knots = 7) | subject_id)

anova_results = anova(lme.int.Eubacteriaceae, lme.slope.Eubacteriaceae)
mixtureLRT = anova_results[["L.Ratio"]][2]
0.5 * pchisq(mixtureLRT, 1, lower.tail = FALSE) + 0.5 * pchisq(mixtureLRT, 2, lower.tail = FALSE) # use random-slopes

glmm.int.Eubacteriaceae = glmmTMB(Eubacteriaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), 
               family = gaussian, 
               data = df, 
               zi = ~ 1,
               REML = TRUE)

lme.slope.Eubacteriaceae = lmer(Eubacteriaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), data = df)

#glmm.slope.Eubacteriaceae = glmmTMB(Eubacteriaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), 
               #family = gaussian, 
               #data = df, 
               #zi = ~ 1,
               #REML = TRUE)

AICc(lme.slope.Eubacteriaceae) # lower
AICc(glmm.int.Eubacteriaceae)
```

```{r}
# diagnostics lme
lme.Eubacteriaceae.diag = DHARMa::simulateResiduals(lme.slope.Eubacteriaceae)

plot(lme.Eubacteriaceae.diag)

plotResiduals(lme.Eubacteriaceae.diag, form = df$clinical_outcome_wk14)
plotResiduals(lme.Eubacteriaceae.diag, form = df$timepoint.new)
plotResiduals(lme.Eubacteriaceae.diag, form = df$treated_with_donor)
plotResiduals(lme.Eubacteriaceae.diag, form = df$sex)
plotResiduals(lme.Eubacteriaceae.diag, form = df$age)
plotResiduals(lme.Eubacteriaceae.diag, form = df$pretreatment)

testZeroInflation(lme.Eubacteriaceae.diag)
testDispersion(lme.Eubacteriaceae.diag)
output1 = recalculateResiduals(lme.Eubacteriaceae.diag, group=df$timepoint.new)
testTemporalAutocorrelation(output1, time = unique(df$timepoint.new))
```

```{r}
# diagnostics zigmm
glmm.Eubacteriaceae.diag = DHARMa::simulateResiduals(glmm.int.Eubacteriaceae)

plot(glmm.Eubacteriaceae.diag)

plotResiduals(glmm.Eubacteriaceae.diag, form = df$clinical_outcome_wk14)
plotResiduals(glmm.Eubacteriaceae.diag, form = df$timepoint.new)
plotResiduals(glmm.Eubacteriaceae.diag, form = df$treated_with_donor)
plotResiduals(glmm.Eubacteriaceae.diag, form = df$sex)
plotResiduals(glmm.Eubacteriaceae.diag, form = df$age)
plotResiduals(glmm.Eubacteriaceae.diag, form = df$pretreatment)

testZeroInflation(glmm.Eubacteriaceae.diag)
testDispersion(glmm.Eubacteriaceae.diag)
output1 = recalculateResiduals(glmm.Eubacteriaceae.diag, group=df$timepoint.new)
testTemporalAutocorrelation(output1, time = unique(df$timepoint.new))
```

```{r}
wald.test(Sigma = vcov(lme.slope.Eubacteriaceae), b = fixef(lme.slope.Eubacteriaceae), Terms = 2)$result # sex

wald.test(Sigma = vcov(lme.slope.Eubacteriaceae), b = fixef(lme.slope.Eubacteriaceae), Terms = 3)$result # age

wald.test(Sigma = vcov(lme.slope.Eubacteriaceae), b = fixef(lme.slope.Eubacteriaceae), Terms = 4)$result # pretreatment

wald.test(Sigma = vcov(lme.slope.Eubacteriaceae), b = fixef(lme.slope.Eubacteriaceae), Terms = 5)$result # donor

wald.test(Sigma = vcov(lme.slope.Eubacteriaceae), b = fixef(lme.slope.Eubacteriaceae), Terms = c(6, 9, 10))$result
```
```{r confounders Eubacteriaceae, echo=TRUE}
library(lmtest)

full.model = lmer(Eubacteriaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), data = df)
summary(full.model )
AIC(full.model)

initial.model = lmer(Eubacteriaceae.new ~ clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), data = df)
summary(initial.model )
AIC(initial.model)

sex.model = lmer(Eubacteriaceae.new ~ sex + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), data = df)
summary(sex.model )

AIC(initial.model) - AIC(sex.model)
lr_test.sex <- lrtest(initial.model, sex.model) # not significant
lr_test.sex
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(sex.model)
coef_initial_sex <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_sex <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.sex  <- coef_full_sex - coef_initial_sex # 0.01124904
coefficient_change_percentage.sex = (coef_full_sex - coef_initial_sex) / coef_initial_sex * 100 # 22%
coefficient_change_percentage.sex
# Check collinearity
#vif_values.sex <- car::vif(sex.model)
#vif_values.sex

age.model = lmer(Eubacteriaceae.new ~ age + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), data = df)
summary(age.model )

AIC(initial.model) - AIC(age.model)
lr_test.age <- lrtest(initial.model, age.model)
lr_test.age
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(age.model)
coef_initial_age <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_age <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.age  <- coef_full_age - coef_initial_age # 0.01124904
coefficient_change_percentage.age = (coef_full_age - coef_initial_age) / coef_initial_age * 100 
coefficient_change_percentage.age
# Check collinearity
#vif_values.age <- car::vif(age.model)
#vif_values.age

pretreatment.model = lmer(Eubacteriaceae.new ~  pretreatment + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), data = df)
summary(pretreatment.model )

AIC(initial.model) - AIC(pretreatment.model)
lr_test.pretreatment <- lrtest(initial.model, pretreatment.model)
lr_test.pretreatment
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(pretreatment.model)
coef_initial_pretreatment <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_pretreatment <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.pretreatment  <- coef_full_pretreatment - coef_initial_pretreatment # 0.01124904
coefficient_change_percentpretreatment.pretreatment = (coef_full_pretreatment - coef_initial_pretreatment) / coef_initial_pretreatment * 100
coefficient_change_percentpretreatment.pretreatment
# Check collinearity
#vif_values.pretreatment <- car::vif(pretreatment.model)
#vif_values.pretreatment

donor.model = lmer(Eubacteriaceae.new ~ treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), data = df)
summary(donor.model )

AIC(initial.model) - AIC(donor.model)
lr_test.treated_with_donor <- lrtest(initial.model, donor.model)
lr_test.treated_with_donor
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(donor.model)
coef_initial_donor <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_donor <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.donor  <- coef_full_donor - coef_initial_donor # 0.01124904
coefficient_change_percentdonor.donor = (coef_full_donor - coef_initial_donor) / coef_initial_donor * 100
coefficient_change_percentdonor.donor
# Check collinearity
#vif_values.treated_with_donor  <- car::vif(donor.model)
#vif_values.treated_with_donor
```

# Firmicutesfam.incertaesedis

```{r}
sum(df$Firmicutesfam.incertaesedis == 0) / length(df$Firmicutesfam.incertaesedis)
```

```{r}
xyplot(Firmicutesfam.incertaesedis ~ timepoint.new | clinical_outcome_wk14, data = df, xlab = "Timepoint", ylab = "Firmicutesfam.incertaesedis", ylim = c(0, 0.04),
           panel = function(x, y) {
            panel.average(x, y, horizontal = FALSE, col = "plum", lwd = 4)
       })

hist(df$Firmicutesfam.incertaesedis)
df$Firmicutesfam.incertaesedis.new = asin(sqrt(df$Firmicutesfam.incertaesedis))
hist(df$Firmicutesfam.incertaesedis.new)

xyplot(Firmicutesfam.incertaesedis ~ timepoint.new | clinical_outcome_wk14, data = df, xlab = "Timepoint", ylab = "Firmicutesfam.incertaesedis", ylim = c(0, 0.04), 
           panel = function(x, y) {
            panel.average(x, y, horizontal = FALSE, col = "plum", lwd = 4)
       })
```

```{r}
lme.int.Firmicutesfam.incertaesedis = lmer(Firmicutesfam.incertaesedis.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)

#lme.slope.Firmicutesfam.incertaesedis = lmer(Firmicutesfam.incertaesedis.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), data = df)

glmm.int.Firmicutesfam.incertaesedis = glmmTMB(Firmicutesfam.incertaesedis.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), 
               family = gaussian, 
               data = df, 
               zi = ~ 1,
               REML = TRUE)

#glmm.slope.Firmicutesfam.incertaesedis = glmmTMB(Firmicutesfam.incertaesedis.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), 
               #family = gaussian, 
               #data = df, 
               #zi = ~ clinical_outcome_wk14 + ( 1 | subject_id),
               #REML = TRUE)

AICc(lme.int.Firmicutesfam.incertaesedis) # lower
AICc(glmm.int.Firmicutesfam.incertaesedis)
```

```{r}
# diagnostics lme
lme.Firmicutesfam.incertaesedis.diag = DHARMa::simulateResiduals(lme.int.Firmicutesfam.incertaesedis)

plot(lme.Firmicutesfam.incertaesedis.diag)

plotResiduals(lme.Firmicutesfam.incertaesedis.diag, form = df$clinical_outcome_wk14)
plotResiduals(lme.Firmicutesfam.incertaesedis.diag, form = df$timepoint.new)
plotResiduals(lme.Firmicutesfam.incertaesedis.diag, form = df$treated_with_donor)
plotResiduals(lme.Firmicutesfam.incertaesedis.diag, form = df$sex)
plotResiduals(lme.Firmicutesfam.incertaesedis.diag, form = df$age)
plotResiduals(lme.Firmicutesfam.incertaesedis.diag, form = df$pretreatment)

testZeroInflation(lme.Firmicutesfam.incertaesedis.diag)
testDispersion(lme.Firmicutesfam.incertaesedis.diag)
output1 = recalculateResiduals(lme.Firmicutesfam.incertaesedis.diag, group=df$timepoint.new)
testTemporalAutocorrelation(output1, time = unique(df$timepoint.new))
```

```{r}
# diagnostics zigmm
glmm.Firmicutesfam.incertaesedis.diag = DHARMa::simulateResiduals(glmm.int.Firmicutesfam.incertaesedis)

plot(glmm.Firmicutesfam.incertaesedis.diag)

plotResiduals(glmm.Firmicutesfam.incertaesedis.diag, form = df$clinical_outcome_wk14)
plotResiduals(glmm.Firmicutesfam.incertaesedis.diag, form = df$timepoint.new)
plotResiduals(glmm.Firmicutesfam.incertaesedis.diag, form = df$treated_with_donor)
plotResiduals(glmm.Firmicutesfam.incertaesedis.diag, form = df$sex)
plotResiduals(glmm.Firmicutesfam.incertaesedis.diag, form = df$age)
plotResiduals(glmm.Firmicutesfam.incertaesedis.diag, form = df$pretreatment)

testZeroInflation(glmm.Firmicutesfam.incertaesedis.diag)
testDispersion(glmm.Firmicutesfam.incertaesedis.diag)
output1 = recalculateResiduals(glmm.Firmicutesfam.incertaesedis.diag, group=df$timepoint.new)
testTemporalAutocorrelation(output1, time = unique(df$timepoint.new))
```
```{r}
wald.test(Sigma = vcov(lme.int.Firmicutesfam.incertaesedis), b = fixef(lme.int.Firmicutesfam.incertaesedis), Terms = 2)$result # sex

wald.test(Sigma = vcov(lme.int.Firmicutesfam.incertaesedis), b = fixef(lme.int.Firmicutesfam.incertaesedis), Terms = 3)$result # age

wald.test(Sigma = vcov(lme.int.Firmicutesfam.incertaesedis), b = fixef(lme.int.Firmicutesfam.incertaesedis), Terms = 4)$result # pretreatment

wald.test(Sigma = vcov(lme.int.Firmicutesfam.incertaesedis), b = fixef(lme.int.Firmicutesfam.incertaesedis), Terms = 5)$result # donor

wald.test(Sigma = vcov(lme.int.Firmicutesfam.incertaesedis), b = fixef(lme.int.Firmicutesfam.incertaesedis), Terms = c(6, 9, 10))$result

# test effect confounder
lme.int.Firmicutesfam.incertaesedis = lmer(Firmicutesfam.incertaesedis.new ~ age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)
wald.test(Sigma = vcov(lme.int.Firmicutesfam.incertaesedis), b = fixef(lme.int.Firmicutesfam.incertaesedis), Terms = c(5, 8, 9))$result
```


```{r confounders Firmicutesfam.incertaesedis, echo=TRUE}
library(lmtest)

full.model = lmer(Firmicutesfam.incertaesedis.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)
summary(full.model )
AIC(full.model)

initial.model = lmer(Firmicutesfam.incertaesedis.new ~ clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)
summary(initial.model )
AIC(initial.model)

sex.model = lmer(Firmicutesfam.incertaesedis.new ~ sex + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)
summary(sex.model )

AIC(initial.model) - AIC(sex.model)
lr_test.sex <- lrtest(initial.model, sex.model) # not significant
lr_test.sex
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(sex.model)
coef_initial_sex <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_sex <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.sex  <- coef_full_sex - coef_initial_sex # 0.01124904
coefficient_change_percentage.sex = (coef_full_sex - coef_initial_sex) / coef_initial_sex * 100
coefficient_change_percentage.sex
# Check collinearity
#vif_values.sex <- car::vif(sex.model)
#vif_values.sex

age.model = lmer(Firmicutesfam.incertaesedis.new ~ age + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)
summary(age.model )

AIC(initial.model) - AIC(age.model)
lr_test.age <- lrtest(initial.model, age.model)
lr_test.age
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(age.model)
coef_initial_age <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_age <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.age  <- coef_full_age - coef_initial_age # 0.01124904
coefficient_change_percentage.age = (coef_full_age - coef_initial_age) / coef_initial_age * 100 
coefficient_change_percentage.age
# Check collinearity
#vif_values.age <- car::vif(age.model)
#vif_values.age

pretreatment.model = lmer(Firmicutesfam.incertaesedis.new ~  pretreatment + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)
summary(pretreatment.model )

AIC(initial.model) - AIC(pretreatment.model)
lr_test.pretreatment <- lrtest(initial.model, pretreatment.model)
lr_test.pretreatment
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(pretreatment.model)
coef_initial_pretreatment <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_pretreatment <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.pretreatment  <- coef_full_pretreatment - coef_initial_pretreatment # 0.01124904
coefficient_change_percentpretreatment.pretreatment = (coef_full_pretreatment - coef_initial_pretreatment) / coef_initial_pretreatment * 100
coefficient_change_percentpretreatment.pretreatment
# Check collinearity
#vif_values.pretreatment <- car::vif(pretreatment.model)
#vif_values.pretreatment

donor.model = lmer(Firmicutesfam.incertaesedis.new ~ treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)
summary(donor.model )

AIC(initial.model) - AIC(donor.model)
lr_test.treated_with_donor <- lrtest(initial.model, donor.model)
lr_test.treated_with_donor
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(donor.model)
coef_initial_donor <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_donor <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.donor  <- coef_full_donor - coef_initial_donor # 0.01124904
coefficient_change_percentdonor.donor = (coef_full_donor - coef_initial_donor) / coef_initial_donor * 100
coefficient_change_percentdonor.donor
# Check collinearity
#vif_values.treated_with_donor  <- car::vif(donor.model)
#vif_values.treated_with_donor
```

# Lachnospiraceae

## Transform the data 

```{r Histogramm Lachnospiraceae, echo=TRUE}
hist( df$Lachnospiraceae )
df$Lachnospiraceae.new = asin( sqrt( df$Lachnospiraceae ))
hist( df$Lachnospiraceae.new )
```

```{r Proportion Lachnospiraceae, echo=TRUE}
sum( df$Lachnospiraceae.new == 0 ) / length( df$Lachnospiraceae.new ) # proportion of zeros
```

```{r Plot data Lachnospiraceae, echo=TRUE}
# None responders
df.none = subset( df, clinical_outcome_wk14 == "None" ) # changed filter to subset

# Good responders
df.good = subset( df, clinical_outcome_wk14 == "Good" )
```

## Plot Lachnospiraceae
 
```{r Plot Lachnospiraceae, echo=TRUE, fig.width = 9}
a = xyplot( Lachnospiraceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.none, xlab = "Timepoint", ylab = "Relative abundance (transformed)", main="Lachnospiraceae", 
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#EC7063", lwd = 4 )
           },
           key = list( space = "right", 
                      lines = list( col = c( "#EC7063", "#85C1E9" ), lty = c( 1, 1 ), lwd = 2 ), 
                      text = list( c( "Non-Responders", "Responders" ))))

b = xyplot( Lachnospiraceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.good, xlab = "Timepoint",
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#85C1E9", lwd = 4, type = "l", lty = 1 )
           })

c = xyplot( Lachnospiraceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.none, type = "p", col = "#EC7063" )

d = xyplot( Lachnospiraceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.good, type = "p", col = "#85C1E9" )

Lachnospiraceae.plot = a + as.layer( b ) + as.layer( c ) + as.layer( d )
Lachnospiraceae.plot
```

## Choose between the lmer and glmmTMB models Lachnospiraceae

We have used time as a numeric value and added a spline at knots = 7.

```{r Mixed model Lachnospiraceae, echo=TRUE}
lme.int.Lachnospiraceae = lmer( Lachnospiraceae.new~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), data = df )

# lme.slope.Lachnospiraceaee = lmer( Lachnospiraceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ),data = df )

glmm.int.Lachnospiraceae = glmmTMB( Lachnospiraceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), 
               family = gaussian, 
               data = df, 
               zi = ~ 1,
               REML = TRUE )

# glmm.slope.Lachnospiraceae = glmmTMB( Lachnospiraceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), 
               #family = gaussian, 
               #data = df, 
               #zi = ~ 1,
               #REML = TRUE )

AICc( lme.int.Lachnospiraceae ) # lower
AICc( glmm.int.Lachnospiraceae )
```

# Diagnostics Lachnospiraceae

```{r Diagnostics Lachnospiraceae, eval=FALSE}
lme.Lachnospiraceae.diag = DHARMa::simulateResiduals( lme.int.Lachnospiraceae )
plot( lme.Lachnospiraceae.diag )

plotResiduals( lme.Lachnospiraceae.diag, form = df$clinical_outcome_wk14 )
plotResiduals( lme.Lachnospiraceae.diag, form = df$timepoint.new )
plotResiduals( lme.Lachnospiraceae.diag, form = df$treated_with_donor )
plotResiduals( lme.Lachnospiraceae.diag, form = df$sex ) 
plotResiduals( lme.Lachnospiraceae.diag, form = df$age )
plotResiduals( lme.Lachnospiraceae.diag, form = df$pretreatment )

testZeroInflation( lme.Lachnospiraceae.diag )
testDispersion( lme.Lachnospiraceae.diag )

output1 = recalculateResiduals( lme.Lachnospiraceae.diag, group = df$timepoint.new )
testTemporalAutocorrelation( output1, time = unique( df$timepoint.new ))
```

LMM was chosen due to its lower AICc value compared to ZIGMM as well as its adequate diagnostics.

```{r Results Lachnospiraceae}
plot_summs( lme.int.Lachnospiraceae )

wald.test( Sigma = vcov( lme.int.Lachnospiraceae ), b = fixef( lme.int.Lachnospiraceae ), Terms = 2 )$result # sex
wald.test( Sigma = vcov( lme.int.Lachnospiraceae ), b = fixef( lme.int.Lachnospiraceae ), Terms = 3 )$result # age
wald.test( Sigma = vcov( lme.int.Lachnospiraceae ), b = fixef( lme.int.Lachnospiraceae ), Terms = 4 )$result # pretreatment
wald.test( Sigma = vcov( lme.int.Lachnospiraceae ), b = fixef( lme.int.Lachnospiraceae ), Terms = 5 )$result # donor
wald.test( Sigma = vcov( lme.int.Lachnospiraceae ), b = fixef( lme.int.Lachnospiraceae ), Terms = c( 6, 9, 10 ))$result # clinical outcome wk14
```
```{r confounders Lachnospiraceae, echo=TRUE}
library(lmtest)

full.model = lmer( Lachnospiraceae.new~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), data = df )
summary(full.model )
AIC(full.model)

initial.model = lmer( Lachnospiraceae.new~  + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), data = df )
summary(initial.model )
AIC(initial.model)

sex.model = lmer( Lachnospiraceae.new~ sex + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), data = df )
summary(sex.model )

AIC(initial.model) - AIC(sex.model)
lr_test.sex <- lrtest(initial.model, sex.model) # not significant
lr_test.sex
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(sex.model)
coef_initial_sex <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_sex <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.sex  <- coef_full_sex - coef_initial_sex # 0.01124904
coefficient_change_percentage.sex = (coef_full_sex - coef_initial_sex) / coef_initial_sex * 100
coefficient_change_percentage.sex
# Check collinearity
#vif_values.sex <- car::vif(sex.model)
#vif_values.sex

age.model = lmer( Lachnospiraceae.new~ age + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), data = df )
summary(age.model )

AIC(initial.model) - AIC(age.model)
lr_test.age <- lrtest(initial.model, age.model)
lr_test.age
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(age.model)
coef_initial_age <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_age <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.age  <- coef_full_age - coef_initial_age # 0.01124904
coefficient_change_percentage.age = (coef_full_age - coef_initial_age) / coef_initial_age * 100 
coefficient_change_percentage.age
# Check collinearity
#vif_values.age <- car::vif(age.model)
#vif_values.age

pretreatment.model = lmer( Lachnospiraceae.new~ pretreatment + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), data = df )
summary(pretreatment.model )

AIC(initial.model) - AIC(pretreatment.model)
lr_test.pretreatment <- lrtest(initial.model, pretreatment.model)
lr_test.pretreatment
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(pretreatment.model)
coef_initial_pretreatment <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_pretreatment <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.pretreatment  <- coef_full_pretreatment - coef_initial_pretreatment # 0.01124904
coefficient_change_percentpretreatment.pretreatment = (coef_full_pretreatment - coef_initial_pretreatment) / coef_initial_pretreatment * 100
coefficient_change_percentpretreatment.pretreatment
# Check collinearity
#vif_values.pretreatment <- car::vif(pretreatment.model)
#vif_values.pretreatment

donor.model = lmer( Lachnospiraceae.new~ treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), data = df )
summary(donor.model )

AIC(initial.model) - AIC(donor.model)
lr_test.treated_with_donor <- lrtest(initial.model, donor.model)
lr_test.treated_with_donor
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(donor.model)
coef_initial_donor <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_donor <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.donor  <- coef_full_donor - coef_initial_donor # 0.01124904
coefficient_change_percentdonor.donor = (coef_full_donor - coef_initial_donor) / coef_initial_donor * 100
coefficient_change_percentdonor.donor
# Check collinearity
#vif_values.treated_with_donor  <- car::vif(donor.model)
#vif_values.treated_with_donor
```

# Oscillospiraceae

## Transform the data 

```{r Histogramm Oscillospiraceae, echo=TRUE}
hist( df$Oscillospiraceae )
df$Oscillospiraceae.new = asin( sqrt( df$Oscillospiraceae ))
hist( df$Oscillospiraceae.new )
```

```{r Proportion Oscillospiraceae, echo=TRUE}
sum( df$Oscillospiraceae.new == 0 ) / length( df$Oscillospiraceae.new ) # proportion of zeros
```

```{r Plot data Oscillospiraceae, echo=TRUE}
# None responders
df.none = subset( df, clinical_outcome_wk14 == "None" ) # changed filter to subset

# Good responders
df.good = subset( df, clinical_outcome_wk14 == "Good" )
```

## Plot Oscillospiraceae
 
```{r Plot Oscillospiraceae, echo=TRUE, fig.width = 9}
a = xyplot( Oscillospiraceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.none, xlab = "Timepoint", ylab = "Relative abundance (transformed)", main="Oscillospiraceae", 
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#EC7063", lwd = 4 )
           },
           key = list( space = "right", 
                      lines = list( col = c( "#EC7063", "#85C1E9" ), lty = c( 1, 1 ), lwd = 2 ), 
                      text = list( c( "Non-Responders", "Responders" ))))

b = xyplot( Oscillospiraceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.good, xlab = "Timepoint",
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#85C1E9", lwd = 4, type = "l", lty = 1 )
           })

c = xyplot( Oscillospiraceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.none, type = "p", col = "#EC7063" )

d = xyplot( Oscillospiraceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.good, type = "p", col = "#85C1E9" )

Oscillospiraceae.plot = a + as.layer( b ) + as.layer( c ) + as.layer( d )
Oscillospiraceae.plot
```

## Choose between the lmer and glmmTMB models Oscillospiraceae

We have used time as a numeric value and added a spline at knots = 7.

```{r Mixed model Oscillospiraceae, echo=TRUE}
lme.int.Oscillospiraceae = lme( Oscillospiraceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7), 
               data = df, 
               random = ~ 1 | subject_id )

# lme.slope.Oscillospiraceae = lme( Oscillospiraceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7), 
               #data = df, 
               #random = ~ ns( timepoint.new.num, knots = 7 ) | subject_id )

glmm.int.Oscillospiraceae = glmmTMB( Oscillospiraceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), 
               family = gaussian, 
               data = df, 
               zi= ~ 1 )

#glmm.slope.Oscillospiraceae. = glmmTMB( Oscillospiraceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), 
               #family = gaussian, 
               #data = df, 
               #zi= ~ 1 )

AICc( lme.int.Oscillospiraceae )
AICc( glmm.int.Oscillospiraceae ) # lower
```

# Diagnostics Oscillospiraceae

```{r Diagnostics Oscillospiraceae, eval=FALSE}
lmer.int.Oscillospiraceae = lmer(Oscillospiraceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)

lme.Oscillospiraceae.diag = DHARMa::simulateResiduals( lmer.int.Oscillospiraceae )
plot( lme.Oscillospiraceae.diag )

plotResiduals( lme.Oscillospiraceae.diag, form = df$clinical_outcome_wk14 )
plotResiduals( lme.Oscillospiraceae.diag, form = df$timepoint.new )
plotResiduals( lme.Oscillospiraceae.diag, form = df$treated_with_donor )
plotResiduals( lme.Oscillospiraceae.diag, form = df$sex ) 
plotResiduals( lme.Oscillospiraceae.diag, form = df$age )
plotResiduals( lme.Oscillospiraceae.diag, form = df$pretreatment )

testZeroInflation( lme.Oscillospiraceae.diag )
testDispersion( lme.Oscillospiraceae.diag )

output1 = recalculateResiduals( lme.Oscillospiraceae.diag, group = df$timepoint.new )
testTemporalAutocorrelation( output1, time = unique( df$timepoint.new ))
```

LMM was chosen due to better diagnostics than ZIGMM despite ZIGMM having a lower AICc value. 

```{r Results Oscillospiraceae}
plot_summs( lme.int.Oscillospiraceae )

wald.test( Sigma = vcov( lme.int.Oscillospiraceae ), b = fixef( lme.int.Oscillospiraceae ), Terms = 2 )$result # sex
wald.test( Sigma = vcov( lme.int.Oscillospiraceae ), b = fixef( lme.int.Oscillospiraceae ), Terms = 3 )$result # age
wald.test( Sigma = vcov( lme.int.Oscillospiraceae ), b = fixef( lme.int.Oscillospiraceae ), Terms = 4 )$result # pretreatment
wald.test( Sigma = vcov( lme.int.Oscillospiraceae ), b = fixef( lme.int.Oscillospiraceae ), Terms = 5 )$result # donor
wald.test( Sigma = vcov( lme.int.Oscillospiraceae ), b = fixef( lme.int.Oscillospiraceae ), Terms = c( 6, 9, 10 ))$result # clinical outcome wk14
```
```{r confounders Oscillospiraceae, echo=TRUE}
library(lmtest)

full.model = lme( Oscillospiraceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7), data = df, random = ~ 1 | subject_id )
summary(full.model )
AIC(full.model)

initial.model = lme( Oscillospiraceae.new ~ clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7), data = df, random = ~ 1 | subject_id )
summary(initial.model )
AIC(initial.model)

sex.model = lme( Oscillospiraceae.new ~ sex + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7), data = df, random = ~ 1 | subject_id )
summary(sex.model )

AIC(initial.model) - AIC(sex.model)
lr_test.sex <- lrtest(initial.model, sex.model) # not significant
lr_test.sex
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(sex.model)
coef_initial_sex <- coef_initial[["clinical_outcome_wk14Good"]][1]
coef_full_sex <- coef_full[["clinical_outcome_wk14Good"]][1]
coefficient_changes.sex  <- coef_full_sex - coef_initial_sex # 0.01124904
coefficient_change_percentage.sex = (coef_full_sex - coef_initial_sex) / coef_initial_sex * 100
coefficient_change_percentage.sex
# Check collinearity
#vif_values.sex <- car::vif(sex.model)
#vif_values.sex

age.model = lme( Oscillospiraceae.new ~ age + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7), data = df, random = ~ 1 | subject_id )
summary(age.model )

AIC(initial.model) - AIC(age.model)
lr_test.age <- lrtest(initial.model, age.model)
lr_test.age
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(age.model)
coef_initial_age <- coef_initial[["clinical_outcome_wk14Good"]][1]
coef_full_age <- coef_full[["clinical_outcome_wk14Good"]][1]
coefficient_changes.age  <- coef_full_age - coef_initial_age # 0.01124904
coefficient_change_percentage.age = (coef_full_age - coef_initial_age) / coef_initial_age * 100 
coefficient_change_percentage.age
# Check collinearity
#vif_values.age <- car::vif(age.model)
#vif_values.age

pretreatment.model = lme( Oscillospiraceae.new ~ pretreatment + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7), data = df, random = ~ 1 | subject_id )
summary(pretreatment.model )

AIC(initial.model) - AIC(pretreatment.model)
lr_test.pretreatment <- lrtest(initial.model, pretreatment.model)
lr_test.pretreatment
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(pretreatment.model)
coef_initial_pretreatment <- coef_initial[["clinical_outcome_wk14Good"]][1]
coef_full_pretreatment <- coef_full[["clinical_outcome_wk14Good"]][1]
coefficient_changes.pretreatment  <- coef_full_pretreatment - coef_initial_pretreatment # 0.01124904
coefficient_change_percentpretreatment.pretreatment = (coef_full_pretreatment - coef_initial_pretreatment) / coef_initial_pretreatment * 100
coefficient_change_percentpretreatment.pretreatment
# Check collinearity
#vif_values.pretreatment <- car::vif(pretreatment.model)
#vif_values.pretreatment

donor.model = lme( Oscillospiraceae.new ~ treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7), data = df, random = ~ 1 | subject_id )
summary(donor.model )

AIC(initial.model) - AIC(donor.model)
lr_test.treated_with_donor <- lrtest(initial.model, donor.model)
lr_test.treated_with_donor
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(donor.model)
coef_initial_donor <- coef_initial[["clinical_outcome_wk14Good"]][1]
coef_full_donor <- coef_full[["clinical_outcome_wk14Good"]][1]
coefficient_changes.donor  <- coef_full_donor - coef_initial_donor # 0.01124904
coefficient_change_percentdonor.donor = (coef_full_donor - coef_initial_donor) / coef_initial_donor * 100
coefficient_change_percentdonor.donor
# Check collinearity
#vif_values.treated_with_donor  <- car::vif(donor.model)
#vif_values.treated_with_donor
```

# Prevotellaceae

## Transform the data 

```{r Histogramm Prevotellaceae, echo=TRUE}
hist( df$Prevotellaceae )
df$Prevotellaceae.new = asin( sqrt( df$Prevotellaceae ))
hist( df$Prevotellaceae.new )
```

```{r Proportion Prevotellaceae, echo=TRUE}
sum( df$Prevotellaceae.new == 0 ) / length( df$Prevotellaceae.new ) # proportion of zeros
```

```{r Plot data Prevotellaceae, echo=TRUE}
# None responders
df.none = subset( df, clinical_outcome_wk14 == "None" ) # changed filter to subset

# Good responders
df.good = subset( df, clinical_outcome_wk14 == "Good" )
```

## Plot Prevotellaceae

```{r Plot Prevotellaceae, echo=TRUE, fig.width = 9}
a = xyplot( Prevotellaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.none, xlab = "Timepoint", ylab = "Relative abundance (transformed)", main="Prevotellaceae", 
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#EC7063", lwd = 4 )
           },
           key = list( space = "right", 
                      lines = list( col = c( "#EC7063", "#85C1E9" ), lty = c( 1, 1 ), lwd = 2 ), 
                      text = list( c( "Non-Responders", "Responders" ))))

b = xyplot( Prevotellaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.good, xlab = "Timepoint",
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#85C1E9", lwd = 4, type = "l", lty = 1 )
           })

c = xyplot( Prevotellaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.none, type = "p", col = "#EC7063" )

d = xyplot( Prevotellaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.good, type = "p", col = "#85C1E9" )

Prevotellaceae.plot = a + as.layer( b ) + as.layer( c ) + as.layer( d )
Prevotellaceae.plot
```

## Choose between the lmer and glmmTMB models Prevotellaceae

We have used time as a numeric value and added a spline at knots = 7.

```{r Mixed model Prevotellaceae, echo=TRUE}
lme.int.Prevotellaceae = lmer( Prevotellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), data = df )

# lme.slope.Prevotellaceae = lmer( Prevotellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), data = df )

glmm.int.Prevotellaceae = glmmTMB( Prevotellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), 
               family = gaussian, 
               data = df, 
               zi = ~ 1,
               REML = TRUE )

# glmm.slope.Prevotellaceae = glmmTMB( Prevotellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), 
               #family = gaussian, 
               #data = df, 
               #zi = ~ 1,
               #REML = TRUE )

AICc( lme.int.Prevotellaceae ) # lower
AICc( glmm.int.Prevotellaceae )
```

# Diagnostics Prevotellaceae

```{r Diagnostics Prevotellaceae, eval=FALSE}
lme.Prevotellaceae.diag = DHARMa::simulateResiduals( lme.int.Prevotellaceae )
plot( lme.Prevotellaceae.diag )

plotResiduals( lme.Prevotellaceae.diag, form = df$clinical_outcome_wk14 )
plotResiduals( lme.Prevotellaceae.diag, form = df$timepoint.new )
plotResiduals( lme.Prevotellaceae.diag, form = df$treated_with_donor )
plotResiduals( lme.Prevotellaceae.diag, form = df$sex ) 
plotResiduals( lme.Prevotellaceae.diag, form = df$age )
plotResiduals( lme.Prevotellaceae.diag, form = df$pretreatment )

testZeroInflation( lme.Prevotellaceae.diag )
testDispersion( lme.Prevotellaceae.diag )

output1 = recalculateResiduals( lme.Prevotellaceae.diag, group = df$timepoint.new )
testTemporalAutocorrelation( output1, time = unique( df$timepoint.new ))
```

As there were no major differences in diagnostics between LMM and ZIGMM, the LMM model was chosen due to its lower AICc value. 

```{r Results Prevotellaceae}
plot_summs( lme.int.Prevotellaceae )

wald.test( Sigma = vcov( lme.int.Prevotellaceae ), b = fixef( lme.int.Prevotellaceae ), Terms = 2 )$result # sex
wald.test( Sigma = vcov( lme.int.Prevotellaceae ), b = fixef( lme.int.Prevotellaceae ), Terms = 3 )$result # age
wald.test( Sigma = vcov( lme.int.Prevotellaceae ), b = fixef( lme.int.Prevotellaceae ), Terms = 4 )$result # pretreatment
wald.test( Sigma = vcov( lme.int.Prevotellaceae ), b = fixef( lme.int.Prevotellaceae ), Terms = 5 )$result # donor
wald.test( Sigma = vcov( lme.int.Prevotellaceae ), b = fixef( lme.int.Prevotellaceae ), Terms = c( 6, 9, 10 ))$result # clinical outcome wk14
```
```{r confounders Prevotellaceae, echo=TRUE}
library(lmtest)

full.model = lmer( Prevotellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), data = df )
summary(full.model )
AIC(full.model)

initial.model = lmer( Prevotellaceae.new ~  clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), data = df )
summary(initial.model )
AIC(initial.model)

sex.model = lmer( Prevotellaceae.new ~ sex  + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), data = df )
summary(sex.model )

AIC(initial.model) - AIC(sex.model)
lr_test.sex <- lrtest(initial.model, sex.model) # not significant
lr_test.sex
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(sex.model)
coef_initial_sex <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_sex <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.sex  <- coef_full_sex - coef_initial_sex # 0.01124904
coefficient_change_percentage.sex = (coef_full_sex - coef_initial_sex) / coef_initial_sex * 100
coefficient_change_percentage.sex
# Check collinearity
#vif_values.sex <- car::vif(sex.model)
#vif_values.sex

age.model = lmer( Prevotellaceae.new ~ age + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), data = df )
summary(age.model )

AIC(initial.model) - AIC(age.model)
lr_test.age <- lrtest(initial.model, age.model)
lr_test.age
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(age.model)
coef_initial_age <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_age <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.age  <- coef_full_age - coef_initial_age # 0.01124904
coefficient_change_percentage.age = (coef_full_age - coef_initial_age) / coef_initial_age * 100 
coefficient_change_percentage.age
# Check collinearity
#vif_values.age <- car::vif(age.model)
#vif_values.age

pretreatment.model = lmer( Prevotellaceae.new ~ pretreatment + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), data = df )
summary(pretreatment.model )

AIC(initial.model) - AIC(pretreatment.model)
lr_test.pretreatment <- lrtest(initial.model, pretreatment.model)
lr_test.pretreatment
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(pretreatment.model)
coef_initial_pretreatment <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_pretreatment <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.pretreatment  <- coef_full_pretreatment - coef_initial_pretreatment # 0.01124904
coefficient_change_percentpretreatment.pretreatment = (coef_full_pretreatment - coef_initial_pretreatment) / coef_initial_pretreatment * 100
coefficient_change_percentpretreatment.pretreatment
# Check collinearity
#vif_values.pretreatment <- car::vif(pretreatment.model)
#vif_values.pretreatment

donor.model = lmer( Prevotellaceae.new ~ treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), data = df )
summary(donor.model )

AIC(initial.model) - AIC(donor.model)
lr_test.treated_with_donor <- lrtest(initial.model, donor.model)
lr_test.treated_with_donor
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(donor.model)
coef_initial_donor <- coef_initial[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_donor <- coef_full[["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.donor  <- coef_full_donor - coef_initial_donor # 0.01124904
coefficient_change_percentdonor.donor = (coef_full_donor - coef_initial_donor) / coef_initial_donor * 100
coefficient_change_percentdonor.donor
# Check collinearity
#vif_values.treated_with_donor  <- car::vif(donor.model)
#vif_values.treated_with_donor
```

```{r final Results Prevotellaceae}
lme.int.Prevotellaceae = lmer( Prevotellaceae.new ~ sex + age + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), data = df )
summary(lme.int.Prevotellaceae )

plot_summs( lme.int.Prevotellaceae )

wald.test( Sigma = vcov( lme.int.Prevotellaceae ), b = fixef( lme.int.Prevotellaceae ), Terms = 2 )$result # sex
wald.test( Sigma = vcov( lme.int.Prevotellaceae ), b = fixef( lme.int.Prevotellaceae ), Terms = 3 )$result # age
#wald.test( Sigma = vcov( lme.int.Prevotellaceae ), b = fixef( lme.int.Prevotellaceae ), Terms = 4 )$result # pretreatment
#wald.test( Sigma = vcov( lme.int.Prevotellaceae ), b = fixef( lme.int.Prevotellaceae ), Terms = 5 )$result # donor
wald.test( Sigma = vcov( lme.int.Prevotellaceae ), b = fixef( lme.int.Prevotellaceae ), Terms = c( 4, 7, 8 ))$result # clinical outcome wk14
```

# Rikenellaceae

## Transform the data 

```{r Histogramm Rikenellaceae, echo=TRUE}
hist( df$Rikenellaceae )
df$Rikenellaceae.new = asin( sqrt( df$Rikenellaceae ))
hist( df$Rikenellaceae.new )
```

```{r Proportion Rikenellaceae, echo=TRUE}
sum( df$Rikenellaceae.new == 0 ) / length( df$Rikenellaceae.new ) # proportion of zeros
```

```{r Plot data Rikenellaceae, echo=TRUE}
# None responders
df.none = subset( df, clinical_outcome_wk14 == "None" ) # changed filter to subset

# Good responders
df.good = subset( df, clinical_outcome_wk14 == "Good" )
```

## Plot Rikenellaceae
 
```{r Plot Rikenellaceae, echo=TRUE, fig.width = 9}
a = xyplot( Rikenellaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.none, xlab = "Timepoint", ylab = "Relative abundance (transformed)", main="Rikenellaceae", 
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#EC7063", lwd = 4 )
           },
           key = list( space = "right", 
                      lines = list( col = c( "#EC7063", "#85C1E9" ), lty = c( 1, 1 ), lwd = 2 ), 
                      text = list( c( "Non-Responders", "Responders" ))))

b = xyplot( Rikenellaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.good, xlab = "Timepoint",
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#85C1E9", lwd = 4, type = "l", lty = 1 )
           })

c = xyplot( Rikenellaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.none, type = "p", col = "#EC7063" )

d = xyplot( Rikenellaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.good, type = "p", col = "#85C1E9" )

Rikenellaceae.plot = a + as.layer( b ) + as.layer( c ) + as.layer( d )
Rikenellaceae.plot
```

## Choose between the lmer and glmmTMB models Rikenellaceae

We have used time as a numeric value and added a spline at knots = 7.

```{r Mixed model Rikenellaceae, echo=TRUE}
lme.int.Rikenellaceae = lme( Rikenellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ), 
               data = df, 
               random = ~ 1 | subject_id )

# lme.slope.Rikenellaceae = lme( Rikenellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ), 
               #data = df, 
               #random = ~ ns( timepoint.new.num, knots = 7 ) | subject_id )

glmm.int.Rikenellaceae = glmmTMB( Rikenellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), 
               family = gaussian, 
               data = df, 
               zi= ~ 1) #clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ))

#glmm.slope.Rikenellaceae = glmmTMB(Rikenellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 + ns(timepoint.new.num, knots = 7) + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), 
               #family = gaussian, 
               #data = df, 
               #zi= ~ clinical_outcome_wk14 + ns(timepoint.new.num, knots = 7) + ( 1 | subject_id))

AICc( lme.int.Rikenellaceae ) 
AICc( glmm.int.Rikenellaceae ) # lower
```

# Diagnostics Rikenellaceae

```{r Diagnostics Rikenellaceae, eval=FALSE}
glmm.Rikenellaceae.diag = DHARMa::simulateResiduals( glmm.int.Rikenellaceae )
plot( glmm.Rikenellaceae.diag )

plotResiduals( glmm.Rikenellaceae.diag, form = df$clinical_outcome_wk14 )
plotResiduals( glmm.Rikenellaceae.diag, form = df$timepoint.new )
plotResiduals( glmm.Rikenellaceae.diag, form = df$treated_with_donor )
plotResiduals( glmm.Rikenellaceae.diag, form = df$sex ) 
plotResiduals( glmm.Rikenellaceae.diag, form = df$age )
plotResiduals( glmm.Rikenellaceae.diag, form = df$pretreatment )

testZeroInflation( glmm.Rikenellaceae.diag )
testDispersion( glmm.Rikenellaceae.diag )

output1 = recalculateResiduals( glmm.Rikenellaceae.diag, group = df$timepoint.new )
testTemporalAutocorrelation( output1, time = unique( df$timepoint.new ))
```

ZIGMM was chosen due to a lower AICc value comapred to LMM. However, there are problems with diagnostics with both models.  

```{r Results Rikenellaceae 3, fig.width = 9}
conf.int = data.frame( confint( glmm.int.Rikenellaceae ))
colnames( conf.int )[ 1 ] = "conf.low"
colnames( conf.int )[ 2 ] = "conf.high"
conf.int = conf.int[ -c( 11:21 ), ]

clostridfam = broom.mixed::tidy( glmm.int.Rikenellaceae )[ , -c( 1 )]
clostridfam = clostridfam[ -c( 11:23 ), ]
clostridfam = clostridfam[ , -c( 1 )]
effect = "fixed"

clostridfam = data.frame( model = "Clostridiales incertaesedis", effect = effect, clostridfam, conf.low = conf.int$conf.low, conf.high = conf.int$conf.high )
clostridfam = clostridfam[ , -c( 8 )]
clostridfam = as_tibble( clostridfam )

dwplot( clostridfam ) + xlab( "Coefficient Estimate" ) + geom_vline( xintercept = 0, colour = "grey60", linetype = 2 ) + theme_bw() + theme( legend.title = element_blank())

wald.test( Sigma = vcov( glmm.int.Rikenellaceae )[[ "cond" ]], b = fixef( glmm.int.Rikenellaceae )[[ "cond" ]], Terms = 2 )$result # sex

wald.test( Sigma = vcov( glmm.int.Rikenellaceae )[[ "cond" ]], b = fixef( glmm.int.Rikenellaceae )[[ "cond" ]], Terms = 3 )$result # age

wald.test( Sigma = vcov( glmm.int.Rikenellaceae )[[ "cond" ]], b = fixef( glmm.int.Rikenellaceae )[[ "cond" ]], Terms = 4 )$result # pretreatment

wald.test( Sigma = vcov( glmm.int.Rikenellaceae )[[ "cond" ]], b = fixef( glmm.int.Rikenellaceae )[[ "cond" ]], Terms = 5 )$result # donor

wald.test( Sigma = vcov( glmm.int.Rikenellaceae )[[ "cond" ]], b = fixef( glmm.int.Rikenellaceae )[[ "cond" ]], Terms = c( 6, 9, 10 ))$result

# test effect confounders
glmm.int.Rikenellaceae = glmmTMB( Rikenellaceae.new ~ sex + age + clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), 
               family = gaussian, 
               data = df, 
               zi= ~ 1)
wald.test( Sigma = vcov( glmm.int.Rikenellaceae )[[ "cond" ]], b = fixef( glmm.int.Rikenellaceae )[[ "cond" ]], Terms = c( 4, 7, 8 ))$result


glmm.int.Rikenellaceae = glmmTMB( Rikenellaceae.new ~ age  + treated_with_donor + clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), 
               family = gaussian, 
               data = df, 
               zi= ~ 1)
wald.test( Sigma = vcov( glmm.int.Rikenellaceae )[[ "cond" ]], b = fixef( glmm.int.Rikenellaceae )[[ "cond" ]], Terms = c( 4, 7, 8 ))$result

```

```{r confounders Rikenellaceae, echo=TRUE}
library(lmtest)

full.model = glmmTMB( Rikenellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), family = gaussian, data = df, zi= ~ 1)
summary(full.model )
AIC(full.model)

initial.model = glmmTMB( Rikenellaceae.new ~  clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), family = gaussian, data = df, zi= ~ 1)
summary(initial.model )
AIC(initial.model)

sex.model =glmmTMB( Rikenellaceae.new ~ sex  + clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), family = gaussian, data = df, zi= ~ 1)
summary(sex.model )

AIC(initial.model) - AIC(sex.model)
lr_test.sex <- lrtest(initial.model, sex.model) # not significant
lr_test.sex
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(sex.model)
coef_initial_sex <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_sex <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.sex  <- coef_full_sex - coef_initial_sex # 0.01124904
coefficient_change_percentage.sex = (coef_full_sex - coef_initial_sex) / coef_initial_sex * 100 # 22%
coefficient_change_percentage.sex
# Check collinearity
#vif_values.sex <- car::vif(sex.model)
#vif_values.sex

age.model = glmmTMB( Rikenellaceae.new ~ age + clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), family = gaussian, data = df, zi= ~ 1)
summary(age.model )

AIC(initial.model) - AIC(age.model)
lr_test.age <- lrtest(initial.model, age.model)
lr_test.age
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(age.model)
coef_initial_age <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_age <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.age  <- coef_full_age - coef_initial_age # 0.01124904
coefficient_change_percentage.age = (coef_full_age - coef_initial_age) / coef_initial_age * 100 
coefficient_change_percentage.age
# Check collinearity
#vif_values.age <- car::vif(age.model)
#vif_values.age

pretreatment.model = glmmTMB( Rikenellaceae.new ~ pretreatment  + clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), family = gaussian, data = df, zi= ~ 1)
summary(pretreatment.model )

AIC(initial.model) - AIC(pretreatment.model)
lr_test.pretreatment <- lrtest(initial.model, pretreatment.model)
lr_test.pretreatment
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(pretreatment.model)
coef_initial_pretreatment <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_pretreatment <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.pretreatment  <- coef_full_pretreatment - coef_initial_pretreatment # 0.01124904
coefficient_change_percentpretreatment.pretreatment = (coef_full_pretreatment - coef_initial_pretreatment) / coef_initial_pretreatment * 100
coefficient_change_percentpretreatment.pretreatment
# Check collinearity
#vif_values.pretreatment <- car::vif(pretreatment.model)
#vif_values.pretreatment

donor.model = glmmTMB( Rikenellaceae.new ~ treated_with_donor + clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), family = gaussian, data = df, zi= ~ 1)
summary(donor.model )

AIC(initial.model) - AIC(donor.model)
lr_test.treated_with_donor <- lrtest(initial.model, donor.model)
lr_test.treated_with_donor
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(donor.model)
coef_initial_donor <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_donor <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.donor  <- coef_full_donor - coef_initial_donor # 0.01124904
coefficient_change_percentdonor.donor = (coef_full_donor - coef_initial_donor) / coef_initial_donor * 100
coefficient_change_percentdonor.donor
# Check collinearity
#vif_values.treated_with_donor  <- car::vif(donor.model)
#vif_values.treated_with_donor
```

```{r Results Rikenellaceae 2, fig.width = 9}
glmm.int.Rikenellaceae = glmmTMB( Rikenellaceae.new ~ sex + age + treated_with_donor + clinical_outcome_wk14 + ns( timepoint.new.num, knots = 7 ) + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), family = gaussian, data = df, zi= ~ 1)
summary(glmm.int.Rikenellaceae )

wald.test( Sigma = vcov( glmm.int.Rikenellaceae )[[ "cond" ]], b = fixef( glmm.int.Rikenellaceae )[[ "cond" ]], Terms = 2 )$result # sex

wald.test( Sigma = vcov( glmm.int.Rikenellaceae )[[ "cond" ]], b = fixef( glmm.int.Rikenellaceae )[[ "cond" ]], Terms = 3 )$result # age

#wald.test( Sigma = vcov( glmm.int.Rikenellaceae )[[ "cond" ]], b = fixef( glmm.int.Rikenellaceae )[[ "cond" ]], Terms = 4 )$result # pretreatment

wald.test( Sigma = vcov( glmm.int.Rikenellaceae )[[ "cond" ]], b = fixef( glmm.int.Rikenellaceae )[[ "cond" ]], Terms = 4 )$result # donor

wald.test( Sigma = vcov( glmm.int.Rikenellaceae )[[ "cond" ]], b = fixef( glmm.int.Rikenellaceae )[[ "cond" ]], Terms = c( 5, 8, 9 ))$result
```

# Ruminococcaceae

## Transform the data 

```{r Histogramm Ruminococcaceae, echo=TRUE}
hist( df$Ruminococcaceae )
# No transformation needed
```

```{r Proportion Ruminococcaceae, echo=TRUE}
sum( df$Ruminococcaceae == 0 ) / length( df$Ruminococcaceae ) # proportion of zeros
```

```{r Plot data Ruminococcaceae, echo=TRUE}
# None responders
df.none = subset( df, clinical_outcome_wk14 == "None" ) # changed filter to subset

# Good responders
df.good = subset( df, clinical_outcome_wk14 == "Good" )
```

## Plot Ruminococcaceae
 
```{r Plot Ruminococcaceae, echo=TRUE, fig.width = 9}
a = xyplot( Ruminococcaceae ~ timepoint.new | clinical_outcome_wk14, data = df.none, xlab = "Timepoint", ylab = "Relative abundance (transformed)", main="Ruminococcaceae", 
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#EC7063", lwd = 4 )
           },
           key = list( space = "right", 
                      lines = list( col = c( "#EC7063", "#85C1E9" ), lty = c( 1, 1 ), lwd = 2 ), 
                      text = list( c( "Non-Responders", "Responders" ))))

b = xyplot( Ruminococcaceae ~ timepoint.new | clinical_outcome_wk14, data = df.good, xlab = "Timepoint",
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#85C1E9", lwd = 4, type = "l", lty = 1 )
           })

c = xyplot( Ruminococcaceae ~ timepoint.new | clinical_outcome_wk14, data = df.none, type = "p", col = "#EC7063" )

d = xyplot( Ruminococcaceae ~ timepoint.new | clinical_outcome_wk14, data = df.good, type = "p", col = "#85C1E9" )

Ruminococcaceae.plot = a + as.layer( b ) + as.layer( c ) + as.layer( d )
Ruminococcaceae.plot
```

## Choose between the lmer and glmmTMB models Ruminococcaceae

We have used time as a numeric value and added a spline at knots = 7.

```{r Mixed model Ruminococcaceae, echo=TRUE}
lme.int.Ruminococcaceae = lme( Ruminococcaceae ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ), 
               data = df, 
               random = ~ 1 | subject_id )

# lme.slope.Ruminococcaceae = lme( Ruminococcaceae ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ), 
               #data = df, 
               #random = ~ ns( timepoint.new.num, knots = 7 ) | subject_id )

summary( lme.int.Ruminococcaceae )
```

# Diagnostics Ruminococcaceae

```{r Diagnostics Ruminococcaceae, eval=FALSE}
lmer.int.Ruminococcaceae = lmer( Ruminococcaceae ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ),
               data = df )

lmer.Ruminococcaceae.diag = DHARMa::simulateResiduals( lmer.int.Ruminococcaceae )
plot( lmer.Ruminococcaceae.diag )

plotResiduals( lmer.Ruminococcaceae.diag, form = df$clinical_outcome_wk14 )
plotResiduals( lmer.Ruminococcaceae.diag, form = df$timepoint.new )
plotResiduals( lmer.Ruminococcaceae.diag, form = df$treated_with_donor )
plotResiduals( lmer.Ruminococcaceae.diag, form = df$sex ) 
plotResiduals( lmer.Ruminococcaceae.diag, form = df$age )
plotResiduals( lmer.Ruminococcaceae.diag, form = df$pretreatment )

testZeroInflation( lmer.Ruminococcaceae.diag )
testDispersion( lmer.Ruminococcaceae.diag )

output1 = recalculateResiduals( lmer.Ruminococcaceae.diag, group = df$timepoint.new )
testTemporalAutocorrelation( output1, time = unique( df$timepoint.new ))
```

LMM was chosen due to its lower AICc value and adequate diagnostics. 

```{r Results Ruminococcaceae}
plot_summs( lme.int.Ruminococcaceae )

wald.test( Sigma = vcov( lme.int.Ruminococcaceae ), b = fixef( lme.int.Ruminococcaceae ), Terms = 2 )$result # sex
wald.test( Sigma = vcov( lme.int.Ruminococcaceae ), b = fixef( lme.int.Ruminococcaceae ), Terms = 3 )$result # age
wald.test( Sigma = vcov( lme.int.Ruminococcaceae ), b = fixef( lme.int.Ruminococcaceae ), Terms = 4 )$result # pretreatment
wald.test( Sigma = vcov( lme.int.Ruminococcaceae ), b = fixef( lme.int.Ruminococcaceae ), Terms = 5 )$result # donor
wald.test( Sigma = vcov( lme.int.Ruminococcaceae ), b = fixef( lme.int.Ruminococcaceae ), Terms = c( 6, 9, 10 ))$result # clinical outcome wk14
```

```{r confounders Ruminococcaceae, echo=TRUE}
library(lmtest)

full.model = lme( Ruminococcaceae ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ), data = df, random = ~ 1 | subject_id )
summary(full.model )
AIC(full.model)

initial.model =  lme( Ruminococcaceae ~ clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ), data = df, random = ~ 1 | subject_id )
summary(initial.model )
AIC(initial.model)

sex.model =  lme( Ruminococcaceae ~ sex  + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ), data = df, random = ~ 1 | subject_id )
summary(sex.model )

AIC(initial.model) - AIC(sex.model)
lr_test.sex <- lrtest(initial.model, sex.model) # not significant
lr_test.sex
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(sex.model)
coef_initial_sex <- coef_initial[["clinical_outcome_wk14Good"]][1]
coef_full_sex <- coef_full[["clinical_outcome_wk14Good"]][1]
coefficient_changes.sex  <- coef_full_sex - coef_initial_sex # 0.01124904
coefficient_change_percentage.sex = (coef_full_sex - coef_initial_sex) / coef_initial_sex * 100
coefficient_change_percentage.sex
# Check collinearity
#vif_values.sex <- car::vif(sex.model)
#vif_values.sex

age.model =  lme( Ruminococcaceae ~ age + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ), data = df, random = ~ 1 | subject_id )
summary(age.model )

AIC(initial.model) - AIC(age.model)
lr_test.age <- lrtest(initial.model, age.model)
lr_test.age
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(age.model)
coef_initial_age <- coef_initial[["clinical_outcome_wk14Good"]][1]
coef_full_age <- coef_full[["clinical_outcome_wk14Good"]][1]
coefficient_changes.age  <- coef_full_age - coef_initial_age # 0.01124904
coefficient_change_percentage.age = (coef_full_age - coef_initial_age) / coef_initial_age * 100 
coefficient_change_percentage.age
# Check collinearity
#vif_values.age <- car::vif(age.model)
#vif_values.age

pretreatment.model =  lme( Ruminococcaceae ~ pretreatment + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ), data = df, random = ~ 1 | subject_id )
summary(pretreatment.model )

AIC(initial.model) - AIC(pretreatment.model)
lr_test.pretreatment <- lrtest(initial.model, pretreatment.model)
lr_test.pretreatment
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(pretreatment.model)
coef_initial_pretreatment <- coef_initial[["clinical_outcome_wk14Good"]][1]
coef_full_pretreatment <- coef_full[["clinical_outcome_wk14Good"]][1]
coefficient_changes.pretreatment  <- coef_full_pretreatment - coef_initial_pretreatment # 0.01124904
coefficient_change_percentpretreatment.pretreatment = (coef_full_pretreatment - coef_initial_pretreatment) / coef_initial_pretreatment * 100
coefficient_change_percentpretreatment.pretreatment
# Check collinearity
#vif_values.pretreatment <- car::vif(pretreatment.model)
#vif_values.pretreatment

donor.model =  lme( Ruminococcaceae ~ treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ), data = df, random = ~ 1 | subject_id )
summary(donor.model )

AIC(initial.model) - AIC(donor.model)
lr_test.treated_with_donor <- lrtest(initial.model, donor.model)
lr_test.treated_with_donor
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(donor.model)
coef_initial_donor <- coef_initial[["clinical_outcome_wk14Good"]][1]
coef_full_donor <- coef_full[["clinical_outcome_wk14Good"]][1]
coefficient_changes.donor  <- coef_full_donor - coef_initial_donor # 0.01124904
coefficient_change_percentdonor.donor = (coef_full_donor - coef_initial_donor) / coef_initial_donor * 100
coefficient_change_percentdonor.donor
# Check collinearity
#vif_values.treated_with_donor  <- car::vif(donor.model)
#vif_values.treated_with_donor
```

# Sutterellaceae

```{r}
sum(df$Sutterellaceae == 0) / length(df$Sutterellaceae) 
```

```{r}
xyplot(Sutterellaceae ~ timepoint.new | clinical_outcome_wk14, data = df, xlab = "Timepoint", ylab = "Sutterellaceae", ylim = c(0, 0.05),
           panel = function(x, y) {
            panel.average(x, y, horizontal = FALSE, col = "plum", lwd = 4)
       })

hist(df$Sutterellaceae)

df$Sutterellaceae.new = asin(sqrt(df$Sutterellaceae))
hist(df$Sutterellaceae.new)

xyplot(Sutterellaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df, xlab = "Timepoint", ylab = "Sutterellaceae", ylim = c(0, 0.2),
           panel = function(x, y) {
            panel.average(x, y, horizontal = FALSE, col = "plum", lwd = 4)
       })
```

```{r}
lme.int.Sutterellaceae = lmer(Sutterellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), data = df)

#lme.slope.Sutterellaceae = lmer(Sutterellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), data = df)

glmm.int.Sutterellaceae = glmmTMB(Sutterellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), 
               family = gaussian, 
               data = df, 
               zi= ~ 1)

#glmm.slope.Sutterellaceae = glmmTMB(Sutterellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (ns(timepoint.new.num, knots = 7) | subject_id), 
               #family = gaussian, 
               #data = df, 
               #zi= ~ 1)

AICc(lme.int.Sutterellaceae)
AICc(glmm.int.Sutterellaceae) # lower
```

```{r}
glmm.Sutterellaceae.diag = DHARMa::simulateResiduals(glmm.int.Sutterellaceae)
plot(glmm.Sutterellaceae.diag)

plotResiduals(glmm.Sutterellaceae.diag, form = df$clinical_outcome_wk14)
plotResiduals(glmm.Sutterellaceae.diag, form = df$timepoint.new)
plotResiduals(glmm.Sutterellaceae.diag, form = df$treated_with_donor)
plotResiduals(glmm.Sutterellaceae.diag, form = df$sex)
plotResiduals(glmm.Sutterellaceae.diag, form = df$age)
plotResiduals(glmm.Sutterellaceae.diag, form = df$pretreatment)

testZeroInflation(glmm.Sutterellaceae.diag)
testDispersion(glmm.Sutterellaceae.diag)
output1 = recalculateResiduals(glmm.Sutterellaceae.diag, group=df$timepoint.new)
testTemporalAutocorrelation(output1, time = unique(df$timepoint.new))
```

```{r}
lme.Sutterellaceae.diag = DHARMa::simulateResiduals(lme.int.Sutterellaceae)
plot(lme.Sutterellaceae.diag)

plotResiduals(lme.Sutterellaceae.diag, form = df$clinical_outcome_wk14)
plotResiduals(lme.Sutterellaceae.diag, form = df$timepoint.new)
plotResiduals(lme.Sutterellaceae.diag, form = df$treated_with_donor)
plotResiduals(lme.Sutterellaceae.diag, form = df$sex)
plotResiduals(lme.Sutterellaceae.diag, form = df$age)
plotResiduals(lme.Sutterellaceae.diag, form = df$pretreatment)

testZeroInflation(lme.Sutterellaceae.diag)
testDispersion(lme.Sutterellaceae.diag)
output1 = recalculateResiduals(lme.Sutterellaceae.diag, group=df$timepoint.new)
testTemporalAutocorrelation(output1, time = unique(df$timepoint.new))
```


```{r}
wald.test(Sigma = vcov(glmm.int.Sutterellaceae)[["cond"]], b = fixef(glmm.int.Sutterellaceae)[["cond"]], Terms = 2)$result # sex

wald.test(Sigma = vcov(glmm.int.Sutterellaceae)[["cond"]], b = fixef(glmm.int.Sutterellaceae)[["cond"]], Terms = 3)$result # age

wald.test(Sigma = vcov(glmm.int.Sutterellaceae)[["cond"]], b = fixef(glmm.int.Sutterellaceae)[["cond"]], Terms = 4)$result # pretreatment

wald.test(Sigma = vcov(glmm.int.Sutterellaceae)[["cond"]], b = fixef(glmm.int.Sutterellaceae)[["cond"]], Terms = 5)$result # donor

wald.test(Sigma = vcov(glmm.int.Sutterellaceae)[["cond"]], b = fixef(glmm.int.Sutterellaceae)[["cond"]], Terms = c(6, 9, 10))$result


# test confounder

glmm.int.Sutterellaceae = glmmTMB(Sutterellaceae.new ~ clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), 
               family = gaussian, 
               data = df, 
               zi= ~ 1)
wald.test(Sigma = vcov(glmm.int.Sutterellaceae)[["cond"]], b = fixef(glmm.int.Sutterellaceae)[["cond"]], Terms = c(2, 5, 6))$result

```

```{r confounders Sutterellaceae, echo=TRUE}
library(lmtest)

full.model = glmmTMB(Sutterellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(full.model )
AIC(full.model)

initial.model = glmmTMB(Sutterellaceae.new ~  clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(initial.model )
AIC(initial.model)

sex.model =glmmTMB(Sutterellaceae.new ~ sex + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(sex.model )

AIC(initial.model) - AIC(sex.model)
lr_test.sex <- lrtest(initial.model, sex.model) # not significant
lr_test.sex
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(sex.model)
coef_initial_sex <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_sex <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.sex  <- coef_full_sex - coef_initial_sex # 0.01124904
coefficient_change_percentage.sex = (coef_full_sex - coef_initial_sex) / coef_initial_sex * 100 # 22%
coefficient_change_percentage.sex
# Check collinearity
#vif_values.sex <- car::vif(sex.model)
#vif_values.sex

age.model = glmmTMB(Sutterellaceae.new ~ age + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(age.model )

AIC(initial.model) - AIC(age.model)
lr_test.age <- lrtest(initial.model, age.model)
lr_test.age
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(age.model)
coef_initial_age <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_age <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.age  <- coef_full_age - coef_initial_age # 0.01124904
coefficient_change_percentage.age = (coef_full_age - coef_initial_age) / coef_initial_age * 100 
coefficient_change_percentage.age
# Check collinearity
#vif_values.age <- car::vif(age.model)
#vif_values.age

pretreatment.model = glmmTMB(Sutterellaceae.new ~ pretreatment + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(pretreatment.model )

AIC(initial.model) - AIC(pretreatment.model)
lr_test.pretreatment <- lrtest(initial.model, pretreatment.model)
lr_test.pretreatment
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(pretreatment.model)
coef_initial_pretreatment <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_pretreatment <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.pretreatment  <- coef_full_pretreatment - coef_initial_pretreatment # 0.01124904
coefficient_change_percentpretreatment.pretreatment = (coef_full_pretreatment - coef_initial_pretreatment) / coef_initial_pretreatment * 100
coefficient_change_percentpretreatment.pretreatment
# Check collinearity
#vif_values.pretreatment <- car::vif(pretreatment.model)
#vif_values.pretreatment

donor.model =glmmTMB(Sutterellaceae.new ~ treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(donor.model )

AIC(initial.model) - AIC(donor.model)
lr_test.treated_with_donor <- lrtest(initial.model, donor.model)
lr_test.treated_with_donor
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(donor.model)
coef_initial_donor <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_donor <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.donor  <- coef_full_donor - coef_initial_donor # 0.01124904
coefficient_change_percentdonor.donor = (coef_full_donor - coef_initial_donor) / coef_initial_donor * 100
coefficient_change_percentdonor.donor
# Check collinearity
#vif_values.treated_with_donor  <- car::vif(donor.model)
#vif_values.treated_with_donor
```

```{r}
glmm.int.Sutterellaceae =glmmTMB(Sutterellaceae.new ~ treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7) + (1 | subject_id), family = gaussian, data = df, zi= ~ 1)
summary(glmm.int.Sutterellaceae )

#wald.test(Sigma = vcov(glmm.int.Sutterellaceae)[["cond"]], b = fixef(glmm.int.Sutterellaceae)[["cond"]], Terms = 2)$result # sex

#wald.test(Sigma = vcov(glmm.int.Sutterellaceae)[["cond"]], b = fixef(glmm.int.Sutterellaceae)[["cond"]], Terms = 3)$result # age

#wald.test(Sigma = vcov(glmm.int.Sutterellaceae)[["cond"]], b = fixef(glmm.int.Sutterellaceae)[["cond"]], Terms = 4)$result # pretreatment

wald.test(Sigma = vcov(glmm.int.Sutterellaceae)[["cond"]], b = fixef(glmm.int.Sutterellaceae)[["cond"]], Terms = 2)$result # donor

wald.test(Sigma = vcov(glmm.int.Sutterellaceae)[["cond"]], b = fixef(glmm.int.Sutterellaceae)[["cond"]], Terms = c(3, 6, 7))$result
```

# Veillonellaceae

## Transform the data 

```{r Histogramm Veillonellaceae, echo=TRUE}
hist( df$Veillonellaceae )
df$Veillonellaceae.new = asin( sqrt( df$Veillonellaceae ))
hist( df$Veillonellaceae.new )
```

```{r Proportion Veillonellaceae, echo=TRUE}
sum( df$Veillonellaceae.new == 0 ) / length( df$Veillonellaceae.new ) # proportion of zeros
```

```{r Plot data Veillonellaceae, echo=TRUE}
# None responders
df.none = subset( df, clinical_outcome_wk14 == "None" ) # changed filter to subset

# Good responders
df.good = subset( df, clinical_outcome_wk14 == "Good" )
```

## Plot Veillonellaceae
 
```{r Plot Veillonellaceae, echo=TRUE, fig.width = 9}
a = xyplot( Veillonellaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.none, xlab = "Timepoint", ylab = "Relative abundance (transformed)", main="Veillonellaceae", 
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#EC7063", lwd = 4 )
           },
           key = list( space = "right", 
                      lines = list( col = c( "#EC7063", "#85C1E9" ), lty = c( 1, 1 ), lwd = 2 ), 
                      text = list( c( "Non-Responders", "Responders" ))))

b = xyplot( Veillonellaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.good, xlab = "Timepoint",
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#85C1E9", lwd = 4, type = "l", lty = 1 )
           })

c = xyplot( Veillonellaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.none, type = "p", col = "#EC7063" )

d = xyplot( Veillonellaceae.new ~ timepoint.new | clinical_outcome_wk14, data = df.good, type = "p", col = "#85C1E9" )

Veillonellaceae.plot = a + as.layer( b ) + as.layer( c ) + as.layer( d )
Veillonellaceae.plot
```

## Choose between the lmer and glmmTMB models Veillonellaceae

We have used time as a numeric value and added a spline at knots = 7.

```{r Mixed model Veillonellaceae, echo=TRUE}
lme.int.Veillonellaceae = lmer( Veillonellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), 
               data = df )

lme.slope.Veillonellaceae = lmer( Veillonellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), 
               data = df )

# test random slopes vs random intercepts
anova_results = anova( lme.int.Veillonellaceae, lme.slope.Veillonellaceae )
mixtureLRT = anova_results[[ "Chisq" ]][ 2 ]
0.5 * pchisq( mixtureLRT, 1, lower.tail = FALSE ) + 0.5 * pchisq( mixtureLRT, 2, lower.tail = FALSE )
# use random intercepts

glmm.int.Veillonellaceae = glmmTMB( Veillonellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new.num, knots = 7 ) + ( 1 | subject_id ), 
               family = gaussian, 
               data = df, 
               zi= ~ 1 ) # can't make this more complicated

glmm.slope.Veillonellaceae = glmmTMB( Veillonellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), 
               family = gaussian, 
               data = df, 
               zi= ~ 1 ) 

# test random slopes vs random intercepts
anova_results = anova( glmm.int.Veillonellaceae, glmm.slope.Veillonellaceae )
mixtureLRT = anova_results[[ "Chisq" ]][ 2 ]
0.5 * pchisq( mixtureLRT, 1, lower.tail = FALSE ) + 0.5 * pchisq( mixtureLRT, 2, lower.tail = FALSE )
# use random slopes model

AICc( lme.int.Veillonellaceae )
AIC( lme.slope.Veillonellaceae )
AICc( glmm.int.Veillonellaceae )
AICc( glmm.slope.Veillonellaceae ) # lower
```

# Diagnostics Veillonellaceae

```{r Diagnostics Veillonellaceae, eval=FALSE}
glmm.Veillonellaceae.diag = DHARMa::simulateResiduals( glmm.slope.Veillonellaceae )
plot( glmm.Veillonellaceae.diag )

plotResiduals( glmm.Veillonellaceae.diag, form = df$clinical_outcome_wk14 )
plotResiduals( glmm.Veillonellaceae.diag, form = df$timepoint.new )
plotResiduals( glmm.Veillonellaceae.diag, form = df$treated_with_donor )
plotResiduals( glmm.Veillonellaceae.diag, form = df$sex ) 
plotResiduals( glmm.Veillonellaceae.diag, form = df$age )
plotResiduals( glmm.Veillonellaceae.diag, form = df$pretreatment )

testZeroInflation( glmm.Veillonellaceae.diag )
testDispersion( glmm.Veillonellaceae.diag )

output1 = recalculateResiduals( glmm.Veillonellaceae.diag, group = df$timepoint.new )
testTemporalAutocorrelation( output1, time = unique( df$timepoint.new ))
```

ZIGMM was chosen due to a lower AICc value. Diagnostics between LMM and ZIGMM were similar. 

```{r Results Veillonellaceae, fig.width = 9}
conf.int = data.frame( confint( glmm.slope.Veillonellaceae ))
colnames( conf.int )[ 1 ] = "conf.low"
colnames( conf.int )[ 2 ] = "conf.high"
conf.int = conf.int[ -c( 11:21 ), ]

clostridfam = broom.mixed::tidy( glmm.slope.Veillonellaceae )[ , -c( 1 )]
clostridfam = clostridfam[ -c( 11:23 ), ]
clostridfam = clostridfam[ , -c( 1 )]
effect = "fixed"

clostridfam = data.frame( model = "Clostridiales incertaesedis", effect = effect, clostridfam, conf.low = conf.int$conf.low, conf.high = conf.int$conf.high )
clostridfam = clostridfam[ , -c( 8 )]
clostridfam = as_tibble( clostridfam )

dwplot( clostridfam ) + xlab( "Coefficient Estimate" ) + geom_vline( xintercept = 0, colour = "grey60", linetype = 2 ) + theme_bw() + theme( legend.title = element_blank())

wald.test( Sigma = vcov( glmm.slope.Veillonellaceae )[[ "cond" ]], b = fixef( glmm.slope.Veillonellaceae )[[ "cond" ]], Terms = 2 )$result # sex

wald.test( Sigma = vcov( glmm.slope.Veillonellaceae )[[ "cond" ]], b = fixef( glmm.slope.Veillonellaceae )[[ "cond" ]], Terms = 3 )$result # age

wald.test( Sigma = vcov( glmm.slope.Veillonellaceae )[[ "cond" ]], b = fixef( glmm.slope.Veillonellaceae )[[ "cond" ]], Terms = 4 )$result # pretreatment

wald.test( Sigma = vcov( glmm.slope.Veillonellaceae )[[ "cond" ]], b = fixef( glmm.slope.Veillonellaceae )[[ "cond" ]], Terms = 5 )$result # donor

wald.test( Sigma = vcov( glmm.slope.Veillonellaceae )[[ "cond" ]], b = fixef( glmm.slope.Veillonellaceae )[[ "cond" ]], Terms = c( 6, 9, 10 ))$result

# test effect confounders
glmm.slope.Veillonellaceae = glmmTMB( Veillonellaceae.new ~ sex + age + pretreatment + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), 
               family = gaussian, 
               data = df, 
               zi= ~ 1 ) 
wald.test( Sigma = vcov( glmm.slope.Veillonellaceae )[[ "cond" ]], b = fixef( glmm.slope.Veillonellaceae )[[ "cond" ]], Terms = c( 5, 8, 9 ))$result


glmm.slope.Veillonellaceae = glmmTMB( Veillonellaceae.new ~ sex + age + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), 
               family = gaussian, 
               data = df, 
               zi= ~ 1 ) 
wald.test( Sigma = vcov( glmm.slope.Veillonellaceae )[[ "cond" ]], b = fixef( glmm.slope.Veillonellaceae )[[ "cond" ]], Terms = c( 5, 8, 9 ))$result

```

```{r confounders Veillonellaceae, echo=TRUE}
library(lmtest)

full.model = glmmTMB( Veillonellaceae.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), family = gaussian, data = df, zi= ~ 1 ) 
summary(full.model )
AIC(full.model)

# note that pretreatment is in this model!!!
initial.model = glmmTMB( Veillonellaceae.new ~ pretreatment + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), family = gaussian, data = df, zi= ~ 1 ) 
summary(initial.model )
AIC(initial.model)

sex.model =glmmTMB( Veillonellaceae.new ~ sex + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), family = gaussian, data = df, zi= ~ 1 ) 
summary(sex.model )

AIC(initial.model) - AIC(sex.model)
lr_test.sex <- lrtest(initial.model, sex.model) # not significant
lr_test.sex
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(sex.model)
coef_initial_sex <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_sex <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.sex  <- coef_full_sex - coef_initial_sex # 0.01124904
coefficient_change_percentage.sex = (coef_full_sex - coef_initial_sex) / coef_initial_sex * 100 # 22%
coefficient_change_percentage.sex
# Check collinearity
#vif_values.sex <- car::vif(sex.model)
#vif_values.sex

age.model = glmmTMB( Veillonellaceae.new ~ age  + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), family = gaussian, data = df, zi= ~ 1 ) 
summary(age.model )

AIC(initial.model) - AIC(age.model)
lr_test.age <- lrtest(initial.model, age.model)
lr_test.age
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(age.model)
coef_initial_age <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_age <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.age  <- coef_full_age - coef_initial_age # 0.01124904
coefficient_change_percentage.age = (coef_full_age - coef_initial_age) / coef_initial_age * 100 
coefficient_change_percentage.age
# Check collinearity
#vif_values.age <- car::vif(age.model)
#vif_values.age

pretreatment.model = glmmTMB( Veillonellaceae.new ~  pretreatment + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), family = gaussian, data = df, zi= ~ 1 ) 
summary(pretreatment.model )

AIC(initial.model) - AIC(pretreatment.model)
lr_test.pretreatment <- lrtest(initial.model, pretreatment.model)
lr_test.pretreatment
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(pretreatment.model)
coef_initial_pretreatment <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_pretreatment <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.pretreatment  <- coef_full_pretreatment - coef_initial_pretreatment # 0.01124904
coefficient_change_percentpretreatment.pretreatment = (coef_full_pretreatment - coef_initial_pretreatment) / coef_initial_pretreatment * 100
coefficient_change_percentpretreatment.pretreatment
# Check collinearity
#vif_values.pretreatment <- car::vif(pretreatment.model)
#vif_values.pretreatment

donor.model =glmmTMB( Veillonellaceae.new ~ treated_with_donor + clinical_outcome_wk14 * ns( timepoint.new.num, knots = 7 ) + ( ns( timepoint.new.num, knots = 7 ) | subject_id ), family = gaussian, data = df, zi= ~ 1 ) 
summary(donor.model )

AIC(initial.model) - AIC(donor.model)
lr_test.treated_with_donor <- lrtest(initial.model, donor.model)
lr_test.treated_with_donor
# Extract coefficients
coef_initial <- coef(initial.model)
coef_full <- coef(donor.model)
coef_initial_donor <- coef_initial[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coef_full_donor <- coef_full[["cond"]][["subject_id"]][["clinical_outcome_wk14Good"]][1]
coefficient_changes.donor  <- coef_full_donor - coef_initial_donor # 0.01124904
coefficient_change_percentdonor.donor = (coef_full_donor - coef_initial_donor) / coef_initial_donor * 100
coefficient_change_percentdonor.donor
# Check collinearity
#vif_values.treated_with_donor  <- car::vif(donor.model)
#vif_values.treated_with_donor
```

# Coefficients Plot - Comparison

```{r Coefficients plot data, echo=TRUE}
# Bacteroidaceae
bacteroid = broom.mixed::tidy( lme.int.Bacteroidaceae, conf.int = TRUE )
bacteroid = bacteroid[ -c( 10:11 ), ]
model = "Bacteroidaceae"
bacteroid = data.frame( model = model, bacteroid )
bacteroid = as_tibble( bacteroid )

# Bacteroidalesfam.incertaesedis
conf.int = data.frame( confint( glmm.int.Bacteroidalesfam.incertaesedis ))
colnames( conf.int )[ 1 ] = "conf.low"
colnames( conf.int )[ 2 ] = "conf.high"
conf.int = conf.int[ -c( 8:9 ), ]

bactfam = broom.mixed::tidy( glmm.int.Bacteroidalesfam.incertaesedis )[ , -c( 1 )]
bactfam = bactfam[ -c( 8:10 ), ]
bactfam = bactfam[ , -c( 1 )]
effect = "fixed"

bactfam = data.frame( model = "Bacteroidalesfam.incertaesedis", effect = effect, bactfam, conf.low = conf.int$conf.low, conf.high = conf.int$conf.high )
bactfam = bactfam[ , -c( 8 )]
bactfam = as_tibble( bactfam )

# Bifidobacteriaceae
conf.int = data.frame( confint( glmm.int.Bifidobacteriaceae ))
colnames( conf.int )[ 1 ] = "conf.low"
colnames( conf.int )[ 2 ] = "conf.high"
conf.int = conf.int[ -c( 9:10 ), ]

bifidobac = broom.mixed::tidy( glmm.int.Bifidobacteriaceae )[ , -c( 1 )]
bifidobac = bifidobac[ -c( 9:11 ), ]
bifidobac = bifidobac[ , -c( 1 )]
effect = "fixed"

bifidobac = data.frame( model = "bifidobac", effect = effect, bifidobac, conf.low = conf.int$conf.low, conf.high = conf.int$conf.high )
bifidobac = bifidobac[ , -c( 8 )]
bifidobac = as_tibble( bifidobac )

# Clostridiaceae
conf.int = data.frame( confint( glmm.int.Clostridiaceae ))
colnames( conf.int )[ 1 ] = "conf.low"
colnames( conf.int )[ 2 ] = "conf.high"
conf.int = conf.int[ -c( 9:10 ), ]

clostrid = broom.mixed::tidy( glmm.int.Clostridiaceae )[ , -c( 1 )]
clostrid = clostrid[ -c( 9:11 ), ]
clostrid = clostrid[ , -c( 1 )]
effect = "fixed"

clostrid = data.frame( model = "Clostridiaceae", effect = effect, clostrid, conf.low = conf.int$conf.low, conf.high = conf.int$conf.high )
clostrid = clostrid[ , -c( 8 )]
clostrid = as_tibble( clostrid )

# Clostridiales incertaesedis
conf.int = data.frame( confint( glmm.slope.Clostridialesfam.incertaesedis ))
colnames( conf.int )[ 1 ] = "conf.low"
colnames( conf.int )[ 2 ] = "conf.high"
conf.int = conf.int[ -c( 11:21 ), ]

clostridfam = broom.mixed::tidy( glmm.slope.Clostridialesfam.incertaesedis )[ , -c( 1 )]
clostridfam = clostridfam[ -c( 11:23 ), ]
clostridfam = clostridfam[ , -c( 1 )]
effect = "fixed"

clostridfam = data.frame( model = "Clostridiales incertaesedis", effect = effect, clostridfam, conf.low = conf.int$conf.low, conf.high = conf.int$conf.high )
clostridfam = clostridfam[ , -c( 8 )]
clostridfam = as_tibble( clostridfam )

# Coriobacteriaceae
conf.int = data.frame( confint( glmm.int.Coriobacteriaceae ))
colnames( conf.int )[ 1 ] = "conf.low"
colnames( conf.int )[ 2 ] = "conf.high"
conf.int = conf.int[ -c( 10:11 ), ]

coriobac = broom.mixed::tidy( glmm.int.Coriobacteriaceae )[ , -c( 1 )]
coriobac = coriobac[ -c( 10:12 ), ]
coriobac = coriobac[ , -c( 1 )]
effect = "fixed"

coriobac = data.frame( model = "Coriobacteriaceae", effect = effect, coriobac, conf.low = conf.int$conf.low, conf.high = conf.int$conf.high )
coriobac = coriobac[ , -c( 8 )]
coriobac = as_tibble( coriobac )

# Eubacteriaceae 
eubact = broom.mixed::tidy( lme.slope.Eubacteriaceae, conf.int = TRUE )
eubact = eubact[ -c( 11:17 ), -c( 7:8 )]
model = "Eubacteriaceae"
eubact = data.frame( model = model, eubact )
eubact = as_tibble( eubact )

# Firmicutesfam.incertaesedis
firmifam = broom.mixed::tidy( lme.int.Firmicutesfam.incertaesedis, conf.int = TRUE )
firmifam = firmifam[ -c( 11:12 ), -c( 7:8 )]
model = "Firmicutesfam.incertaesedis"
firmifam = data.frame( model = model, firmifam )
firmifam = as_tibble( firmifam )

# Lachnospiraceae
lachno = broom.mixed::tidy( lme.int.Lachnospiraceae, conf.int = TRUE )
lachno = lachno[ -c( 11:12 ), -c( 7:8 )]
model = "Lachnospiraceae"
lachno = data.frame( model = model, lachno )
lachno = as_tibble( lachno )

# Oscillospiraceae
oscillo = broom.mixed::tidy( lme.int.Oscillospiraceae, conf.int = TRUE )
oscillo = oscillo[ -c( 11:12 ), -c( 6,8 )]
model = "Oscillospiraceae"
oscillo = data.frame( model = model, oscillo )
oscillo = as_tibble( oscillo )

# Prevotellaceae
prevo = broom.mixed::tidy( lme.int.Prevotellaceae, conf.int = TRUE )
prevo = prevo[ -c( 9:10 ), -c( 7:8 )]
model = "Prevotellaceae"
prevo = data.frame( model = model, prevo )
prevo = as_tibble( prevo )

# Rikenellaceae
conf.int = data.frame( confint( glmm.int.Rikenellaceae ))
colnames( conf.int )[ 1 ] = "conf.low"
colnames( conf.int )[ 2 ] = "conf.high"
conf.int = conf.int[ -c( 10:11 ), ]

rikenell = broom.mixed::tidy( glmm.int.Rikenellaceae )[ , -c( 1 )]
rikenell = rikenell[ -c( 10:12 ), ]
rikenell = rikenell[ , -c( 1 )]
effect = "fixed"

rikenell = data.frame( model = "Rikenellaceae", effect = effect, rikenell, conf.low = conf.int$conf.low, conf.high = conf.int$conf.high )
rikenell = rikenell[ , -c( 8 )]
rikenell = as_tibble( rikenell )

# Ruminococcaceae
rumino = broom.mixed::tidy( lme.int.Ruminococcaceae, conf.int = TRUE )
rumino = rumino[ -c( 11:12 ), -c( 6,8 )]
model = "Ruminococcaceae"
rumino = data.frame( model = model, rumino )
rumino = as_tibble( rumino )

# Sutterellaceae
conf.int = data.frame( confint( glmm.int.Sutterellaceae ))
colnames( conf.int )[ 1 ] = "conf.low"
colnames( conf.int )[ 2 ] = "conf.high"
conf.int = conf.int[ -c( 8:9 ), ]

sutterell = broom.mixed::tidy( glmm.int.Sutterellaceae )[ , -c( 1 )]
sutterell = sutterell[ -c( 8:10 ), ]
sutterell = sutterell[ , -c( 1 )]
effect = "fixed"

sutterell = data.frame( model = "Sutterellaceae", effect = effect, sutterell, conf.low = conf.int$conf.low, conf.high = conf.int$conf.high )
sutterell = sutterell[ , -c( 8 )]
sutterell = as_tibble( sutterell )

# Veillonellaceae
conf.int = data.frame( confint( glmm.slope.Veillonellaceae ))
colnames( conf.int )[ 1 ] = "conf.low"
colnames( conf.int )[ 2 ] = "conf.high"
conf.int = conf.int[ -c( 11:17 ), ]

veillon = broom.mixed::tidy( glmm.slope.Veillonellaceae )[ , -c( 1 )]
veillon = veillon[ -c( 11:18 ), ]
veillon = veillon[ , -c( 1 )]
effect = "fixed"

veillon = data.frame( model = "Veillonellaceae", effect = effect, veillon, conf.low = conf.int$conf.low, conf.high = conf.int$conf.high )
veillon = veillon[ , -c( 8 )]
veillon = as_tibble( veillon )
```


```{r Coefficient Plot, echo=TRUE, fig.width = 9, fig.height = 9}
# combine
common <- intersect( colnames( prevo ), colnames( rumino ))
all_bacteria = rbind( bacteroid[ common ], bactfam[ common ], bifidobac[ common ], clostrid[ common ], clostridfam[ common ], coriobac[ common ], eubact[ common ], firmifam[ common ], lachno[ common ], oscillo[ common ], prevo[ common ], rikenell[ common ], rumino[ common ], sutterell[ common ], veillon[ common ] )

all_bacteria <- all_bacteria %>%
  filter(effect=='fixed' )

# pdf( "coefficientsplot.pdf", width = 15, height = 11 )
# dwplot( all_bacteria, dodge_size = 0.8, dot_args = list( size = 3 ),
#   whisker_args = list( size = 2 )) + xlab( "Coefficient Estimate" ) + geom_vline( xintercept = 0, colour = "grey60", linetype = 2 ) + theme_bw( base_size = 4 ) + theme( legend.title = element_blank(), text = element_text( size = 20 ))

dwplot( all_bacteria ) + xlab( "Coefficient Estimate" ) + geom_vline( xintercept = 0, colour = "grey60", linetype = 2 ) + theme_bw() + theme( legend.title = element_blank())
# dev.off()
```

```{r Coefficient Plot sign, echo=TRUE, fig.width = 9, fig.height = 9}
# combine
common <- intersect( colnames( prevo ), colnames( rumino ))
all_bacteria = rbind( prevo[ common ], lachno[ common ], rumino[ common ], oscillo[ common ],sutterell[ common ])

# pdf( "coefficientsplot.pdf", width = 15, height = 11 )
# dwplot( all_bacteria, dodge_size = 0.8, dot_args = list( size = 3 ),
#   whisker_args = list( size = 2 )) + xlab( "Coefficient Estimate" ) + geom_vline( xintercept = 0, colour = "grey60", linetype = 2 ) + theme_bw( base_size = 4 ) + theme( legend.title = element_blank(), text = element_text( size = 20 ))

library(RColorBrewer)
mycolors <- colorRampPalette( brewer.pal( 8, "Set1" ))( 16 )
mycolors <- brewer.pal(n = 4, name = "Set1")

# Your specified order
desired_order <- c(
  "(Intercept)", "sexM", "age", "pretreatmentplacebo", "treated_with_donorDonor B",
  "clinical_outcome_wk14Good", "ns(timepoint.new.num, knots = 7)1", 
  "ns(timepoint.new.num, knots = 7)2", 
  "clinical_outcome_wk14Good:ns(timepoint.new.num, knots = 7)1", 
  "clinical_outcome_wk14Good:ns(timepoint.new.num, knots = 7)2"
)

# Create a custom factor with the desired order
all_bacteria$term <- factor(all_bacteria$term, levels = desired_order)

# Plot the ordered data
dwplot(all_bacteria, dodge_size = 0.6, dot_args = list(size = 4) ) + xlab( "Coefficient Estimate" ) + geom_vline( xintercept = 0, colour = "grey60", linetype = 2 ) + theme_bw() + theme( text = element_text( size = 20 ), legend.title = element_blank()) + scale_color_manual(values=c("#E41A1C", "#377EB8", "#4DAF4A", "#984EA3", "#E7861B"))
# dev.off()
```
