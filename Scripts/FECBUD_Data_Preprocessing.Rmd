---
title: "FECBUD Data Preprocessing"
date: "December 2022"
output:
  github_document: default
  word_document: default
  pdf_document: default
  html_document: default
---

```{r Setup, include=FALSE}
knitr::opts_chunk$set( echo = TRUE )
```

## Load required packages

```{r load-packages, echo=TRUE, message=FALSE}
library( dplyr )
library( magrittr )
library( knitr )
library( tidyverse )
```

```{r Load packages, echo=TRUE, message=FALSE}
library( phyloseq )
library( microViz )
library( microbiome )
```

## Load the data

Two datasets are available, one with the relative abundances and one with the counts. Here we use the relative abundance dataset

```{r Load Data, echo=FALSE}
physeq_mOTU <- readRDS("/Volumes/My Passport for Mac/FECBUD studie/FECBUD GitHub/FECBUD_microbiome/Data/FECBUD_physeq_relativeabundances.rds")
# physeq_mOTU <- readRDS("/Volumes/My Passport for Mac/FECBUD studie/FECBUD GitHub/Data/FECBUD_physeq_countdata.rds" )
```

```{r Phyloseq object, echo=TRUE}
physeq_mOTU
```
The data includes 209 samples (including the donor samples) and 33570 mOTUs

## Preprocessing of the data

```{r Remove samples and taxa, echo=TRUE, results='hide', warning=FALSE, message=FALSE}
# The mOTU data has two more samples, but those samples do not contain mOTUs
physeq_mOTU@otu_table %>% colSums()
physeq_mOTU <- prune_samples(! sample_sums(physeq_mOTU) == 0, physeq_mOTU)

# Removes taxa where phyloseq::taxa_sums() is equal to zero
physeq_mOTU.filt = phyloseq_validate(physeq_mOTU, remove_undetected = TRUE)

# Remove Archaea class
physeq_mOTU.filt@tax_table[,1] %>% table()
physeq_mOTU.filt <- subset_taxa(physeq_mOTU.filt, kingdom != "Archaea")
```

```{r Phyloseq filt, echo=TRUE}
physeq_mOTU.filt
```
After filtering the data, we are left with 207 samples and 1552 mOTUs.


```{r Clean data, echo=TRUE}
# Correct the name of Coriobacteriaceae
physeq_mOTU.filt = microbiome::merge_taxa2( physeq_mOTU.filt, pattern = "_Coriobacteriaceae", name = "Coriobacteriaceae" )

# Change the partial responders to none responders (wk14 and wk10)
physeq_mOTU.filt@sam_data$clinical_outcome_wk14 = gsub( "Partial", "None",
                                                        physeq_mOTU.filt@sam_data$clinical_outcome_wk14)
physeq_mOTU.filt@sam_data$clinical_outcome_wk14 = factor(physeq_mOTU.filt@sam_data$clinical_outcome_wk14, 
                                                         levels = c( "None", "Good" ))

physeq_mOTU.filt@sam_data$clinical_outcome_wk10 = gsub( "Partial", "None",
                                                        physeq_mOTU.filt@sam_data$clinical_outcome_wk10 )
physeq_mOTU.filt@sam_data$clinical_outcome_wk10 = factor( physeq_mOTU.filt@sam_data$clinical_outcome_wk10, 
                                                          levels = c( "None", "Good" ))

# Change the timepoint levels
physeq_mOTU.filt@sam_data[[ "timepoint" ]] = factor( physeq_mOTU.filt@sam_data[[ "timepoint" ]],
                                                     levels = c( "Baseline", "FMT1" , "FMT2", "FMT3", "FMT4",
                                                                 "Week7","Week8", "Week10", "Week14" ))
```

## Save the data

```{r Save phyloseq, eval=FALSE}
saveRDS( physeq_mOTU.filt, "FECBUD_physeq_filt_relativeabundances.rds" )
# saveRDS( physeq_mOTU.filt, "FECBUD_physeq_filt_countdata.rds" )
```



# Create dataframe object of families

## Agglomerate to family level

```{r Agglomerate, echo=TRUE}
# Agglomerate on family level
IBD.physeq.glom <- physeq_mOTU.filt %>% tax_glom( "family" )  # Note that if NA, all put in the same category
# View the new phyloseq object
IBD.physeq.glom 
```

The data consist of 95 different bacterial families

## Get all the taxa names

```{r Taxa names, echo=TRUE}
# Substract the taxonomy table   
tax.tab <- IBD.physeq.glom %>% tax_table()
# Keep only the last column
familynames <- tax.tab[,5] %>%  as.character()
# Get the OTUs from the otu table
otu.tab <- IBD.physeq.glom %>%  otu_table() %>% t()
# Keep only the names
otus <- otu.tab %>% colnames()
# Combine otus and names
names <- cbind( otus, familynames ) 
```

## Function to extract the abundances

```{r Function, echo=TRUE}
pickdata <- function (x, otu.name) {
  xx <- abundances(x)
  meta <- sample_data(x)
  if (otu.name %in% rownames(xx)) {
    xxx <- as.vector(xx[otu.name, ])
  }
  else if (otu.name %in% colnames(meta)) {
    xxx <- unlist(meta[, otu.name])
  }
}
```

## Store the abundances in a long dataframe

```{r Abundances per family, echo=TRUE, warning=FALSE}
# make a list to store the abundances per family
results_list <- vector( mode = "list", length = nrow( names ) )
# loop through all families
for ( i in 1:nrow( names ) ) {
  # get the data with the pickdata function
  density.data <- pickdata( IBD.physeq.glom, as.character( names[ i, 1 ] ) )
  
  # combine with meta data
  meta <- IBD.physeq.glom %>% meta()
  family.names <- names[ i,2 ]
  density.data.df <- cbind( family.names, density.data, meta )
  
  results_list[[i]] <- density.data.df
}

# make a dataframe for every family
new.names <- physeq_mOTU.filt@tax_table[,5:6] %>% as.data.frame()
families <- new.names["family"] %>% unique() %>% as.data.frame()
rownames(families) <- NULL
families <- families[,1] %>% as.character()
dataframe.abundances.families <- do.call( "rbind", results_list )
IBD.data.family <- dataframe.abundances.families[dataframe.abundances.families$family.names %in% families,]
```

## Investigate the data

```{r Dataframe, echo=TRUE}
IBD.data.family$family.names %>% unique()  
IBD.data.family %>% names()
IBD.data.family$subject_id %>% table()
IBD.data.family$sample_id.new %>% table()

IBD.data.family %>% head()
IBD.data.family %>% summary()
IBD.data.family %>% str()
```

```{r Abundances, echo=TRUE}
# Abundances
IBD.data.family$density.data %>% summary()
IBD.data.family$density.data %>% hist()
select <- IBD.data.family$density.data > 0
IBD.data.family$density.data[select] %>% summary()
IBD.data.family$density.data[select] %>% hist()
```

```{r Variables, echo=TRUE}
IBD.data.family$filename %>% unique()
IBD.data.family$file_id %>% unique()
IBD.data.family$raw_reads %>% unique()
IBD.data.family$human_reads %>% unique()
IBD.data.family$human_percentage %>% unique()
IBD.data.family$high_quality_reads %>% unique()

# Remove the variables that we will not use
IBD.data.family = subset(IBD.data.family, select = -c(filename, file_id, raw_reads, human_reads,
                                                      human_percentage, high_quality_reads) )
```

```{r Time, echo=TRUE}
IBD.data.family$timepoint %>% unique()
IBD.data.family$timepoint.new %>% unique()
IBD.data.family$days_offset %>% unique()
```

```{r Host variables, echo=TRUE}
# subset per family
IBD.data.subset <- IBD.data.family %>% 
  subset( ., family.names == "Lachnospiraceae" ) 

IBD.data.subset$treated_with_donor %>% table()

IBD.data.family$age %>% hist(., main = "Age")
mean.Age <-  IBD.data.family$age %>% mean()
# recode around mean age ~45 years
IBD.data.family$age2 <- as.numeric( IBD.data.family$age - mean.Age )

IBD.data.subset$sex %>% table()
IBD.data.subset$pretreatment %>% table()
IBD.data.subset$clinical_outcome_wk10 %>% table()
IBD.data.subset$clinical_outcome_wk14 %>% table()
```

## Save the dataframe
``` {r Save dataframe, eval=FALSE}
saveRDS( IBD.data.family, file = "dataframe.abundances.families.relativeabundance.rda" )
# saveRDS( IBD.data.family, file = "dataframe.abundances.families.countdata.rda" )
```