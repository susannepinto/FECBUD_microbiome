---
title: "Modelling Simpson Dominance"
date: "December 2022"
output:
  html_document: default
  word_document: default
  pdf_document: default
  github_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set( echo = TRUE )
```

## Load required packages

```{r Load packages 1, echo=TRUE, message=FALSE}
library( dplyr )
library( magrittr )
library( knitr )
library( tidyverse )
```

```{r Load packages 2, echo=TRUE, message=FALSE}
library( phyloseq )
library( microbiome )
library( lattice )
library( latticeExtra )
```

```{r Load paclages 3, echo=TRUE, message=FALSE}
library( nlme)
library( splines )
library( jtools ) 
library( aod )
library( predictmeans )
library( sjPlot )
```

## Load the data

Here we use the relative abundance dataset. If you use the count dataset, make it compositional.

```{r Load Data, echo=FALSE}
physeq_mOTU <- readRDS( "/Volumes/My Passport for Mac/FECBUD studie/FECBUD GitHub/Data/FECBUD_physeq_filt_relativeabundances.rds" ) 
```

## Preprocessing of the data

```{r Phyloseq object, echo=TRUE}
# Aggregate to family level
physeq_mOTU = aggregate_taxa( physeq_mOTU, "family" )
physeq_mOTU
```

```{r Preprocessing, echo=TRUE}
# Remove donors
physeq_mOTU = subset_samples( physeq_mOTU, subject_id != "Donor A" )
physeq_mOTU = subset_samples( physeq_mOTU, subject_id != "Donor B" )
```

## Calculate the Simpson dominance index

```{r Simpson Dominance, echo=TRUE}
# Simpson Dominance
dominance.df = dominance( physeq_mOTU )$simpson
physeq_mOTU@sam_data$simpson = dominance.df

# Store in a dataframe
df.div = physeq_mOTU@sam_data %>% as.matrix() %>% as.data.frame()

df.div$timepoint.new = as.factor( df.div$timepoint.new )
df.div$timepoint.new = factor( df.div[[ "timepoint.new" ]],
                              levels = c( "Baseline", "Pre-FMT" , "Post-1", "Post-2", "Post-3", "Post-4", "Week8", "Week10", "Week14" ))
df.div$clinical_outcome_wk14 = as.factor( df.div$clinical_outcome_wk14 )
df.div$clinical_outcome_wk14 = factor( df.div$clinical_outcome_wk14, levels = c( "None", "Good" ))
df.div$age = as.numeric( df.div$age )
df.div$treated_with_donor = as.factor( df.div$treated_with_donor )
df.div$pretreatment = as.factor( df.div$pretreatment )
df.div$sex = as.factor( df.div$sex )
df.div$subject_id = factor( df.div$subject_id )
df.div$simpson = as.numeric( df.div$simpson )

str(df.div)
```

## Save the data

```{r Save phyloseq, eval=FALSE}
saveRDS( df.div, file = "diversity_measures.rds" )
```

## Plot the Simpson Dominance

```{r Plot data, echo=TRUE}
# None responders
df.none = subset( df.div, clinical_outcome_wk14 == "None" ) # changed filter to subset
df.none$timepoint.new = factor( df.none$timepoint.new, levels = c( "Baseline", "Pre-FMT", "Post-1", "Post-2", "Post-3", "Post-4", "Week8", "Week10", "Week14" ))

# Good responders
df.good = subset( df.div, clinical_outcome_wk14 == "Good" )
df.good$timepoint.new = factor( df.good$timepoint.new, levels = c( "Baseline", "Pre-FMT", "Post-1", "Post-2", "Post-3", "Post-4", "Week8", "Week10", "Week14" ))
```

```{r Plot, echo=TRUE, fig.width = 9}
a = xyplot( simpson ~ timepoint.new, data = df.none, xlab = "Timepoint", ylab = "Simpson Dominance",
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#EC7063", lwd = 4 )
           },
           key = list( space = "right", 
                      lines = list( col = c( "#EC7063", "#82E0AA" ), lty = c( 1, 1 ), lwd = 2 ), 
                      text = list( c( "Non-Responders", "Responders" ))))

b = xyplot( simpson ~ timepoint.new, data = df.good, xlab = "Timepoint",
           panel = function( x, y ) {
             panel.average( x, y, horizontal = FALSE, col = "#82E0AA", lwd = 4, type = "l", lty = 1 )
           })

c = xyplot( simpson ~ timepoint.new, data = df.none, type = "p", col = "#EC7063" )

d = xyplot( simpson ~ timepoint.new, data = df.good, type = "p", col = "#82E0AA" )

simpson.plot = a + as.layer( b ) + as.layer( c ) + as.layer( d )
simpson.plot
```

## Mixed models 

```{r Data models, echo=TRUE}
df.div$timepoint.new = as.numeric( df.div$timepoint.new )
hist( df.div$simpson ) 

df.div$simpson.new = log( df.div$simpson ) # transformation to get closer to a normal distribution
hist( df.div$simpson.new )
```
We have used time as a numeric value and added a spline at knots = 7.

```{r Mixed model, echo=TRUE, fig.width = 9, message=FALSE}
# random slopes
lme.slope.simpson = lme( simpson.new ~ sex + age + pretreatment + treated_with_donor + clinical_outcome_wk14 * ns(timepoint.new, knots = 7), 
                        data = df.div, 
                        random = ~ ns( timepoint.new, knots = 7 ) | subject_id )

tab_model( lme.slope.simpson )
plot_summs( lme.slope.simpson )
```


## Wald test

```{r Wald test, echo=TRUE}
wald.test( Sigma = vcov( lme.slope.simpson ), b = fixef( lme.slope.simpson ), Terms = c( 6, 9, 10 )) # clinical outcome wk14
wald.test( Sigma = vcov( lme.slope.simpson ), b = fixef( lme.slope.simpson ), Terms = 2 ) # sex
wald.test( Sigma = vcov( lme.slope.simpson ), b = fixef( lme.slope.simpson ), Terms = 3 ) # age
wald.test( Sigma = vcov( lme.slope.simpson ), b = fixef( lme.slope.simpson ), Terms = 4 ) # pretreatment
wald.test( Sigma = vcov( lme.slope.simpson ), b = fixef( lme.slope.simpson ), Terms = 5 ) # donor
```

The Wald test gives a significant result for clinical outcome at wk14, sex and age.
